# Prometheus Alert Rules for Admin Center
#
# Defines alerts for critical conditions in the Admin Center:
# - High error rates
# - Payment failures
# - Slow API responses
# - Database connection issues
# - Stripe API errors
#
# Requirements: Task 31.3, Requirement 12

groups:
  - name: admin_api_alerts
    interval: 30s
    rules:
      # High error rate alert (>5%)
      - alert: AdminApiHighErrorRate
        expr: admin:api_error_percentage:rate5m > 5
        for: 5m
        labels:
          severity: critical
          component: admin-api
          category: availability
        annotations:
          summary: "High error rate in Admin API"
          description: "Admin API error rate is {{ $value | humanizePercentage }}% (threshold: 5%) for the last 5 minutes"
          impact: "Admin users may experience failures when managing users, payments, or subscriptions"
          action: "Check API logs for error details. Investigate database connectivity and Stripe API status."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#high-error-rate"
      
      # Slow API responses (>2 seconds)
      - alert: AdminApiSlowResponses
        expr: admin:api_response_time:p95 > 2000
        for: 5m
        labels:
          severity: warning
          component: admin-api
          category: performance
        annotations:
          summary: "Slow API responses in Admin Center"
          description: "95th percentile API response time is {{ $value | humanizeDuration }}ms (threshold: 2000ms)"
          impact: "Admin users may experience slow page loads and timeouts"
          action: "Check database query performance. Review slow query logs. Consider scaling database resources."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#slow-responses"
      
      # Very slow API responses (>5 seconds)
      - alert: AdminApiVerySlowResponses
        expr: admin:api_response_time:p95 > 5000
        for: 2m
        labels:
          severity: critical
          component: admin-api
          category: performance
        annotations:
          summary: "Very slow API responses in Admin Center"
          description: "95th percentile API response time is {{ $value | humanizeDuration }}ms (threshold: 5000ms)"
          impact: "Admin Center is nearly unusable. Users experiencing frequent timeouts."
          action: "URGENT: Check database connection pool. Review active queries. Consider emergency scaling."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#very-slow-responses"
      
      # High number of slow requests
      - alert: AdminApiManySlowRequests
        expr: rate(admin_slow_requests_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: admin-api
          category: performance
        annotations:
          summary: "Many slow requests in Admin API"
          description: "{{ $value }} slow requests per second (>2s response time)"
          impact: "Admin users experiencing degraded performance"
          action: "Identify slow endpoints. Optimize database queries. Review API logs."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#many-slow-requests"

  - name: admin_payment_alerts
    interval: 30s
    rules:
      # High payment failure rate (>10%)
      - alert: AdminPaymentHighFailureRate
        expr: admin:payment_failure_percentage:rate5m > 10
        for: 5m
        labels:
          severity: critical
          component: admin-api
          category: payments
        annotations:
          summary: "High payment failure rate"
          description: "Payment failure rate is {{ $value | humanizePercentage }}% (threshold: 10%) for the last 5 minutes"
          impact: "Users unable to complete payments. Revenue loss."
          action: "Check Stripe API status. Review payment error logs. Verify Stripe API keys."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#payment-failures"
      
      # Very high payment failure rate (>25%)
      - alert: AdminPaymentVeryHighFailureRate
        expr: admin:payment_failure_percentage:rate5m > 25
        for: 2m
        labels:
          severity: critical
          component: admin-api
          category: payments
        annotations:
          summary: "Very high payment failure rate"
          description: "Payment failure rate is {{ $value | humanizePercentage }}% (threshold: 25%)"
          impact: "CRITICAL: Most payments are failing. Significant revenue loss."
          action: "URGENT: Check Stripe service status. Verify API credentials. Review recent code changes."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#critical-payment-failures"
      
      # No successful payments in 15 minutes
      - alert: AdminPaymentNoSuccessfulPayments
        expr: rate(admin_payment_attempts_total{status="success"}[15m]) == 0 and rate(admin_payment_attempts_total[15m]) > 0
        for: 15m
        labels:
          severity: critical
          component: admin-api
          category: payments
        annotations:
          summary: "No successful payments in 15 minutes"
          description: "Payment attempts are being made but none are succeeding"
          impact: "CRITICAL: Complete payment system failure. All revenue blocked."
          action: "URGENT: Check Stripe API connectivity. Verify webhook configuration. Review error logs."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#no-successful-payments"

  - name: admin_refund_alerts
    interval: 30s
    rules:
      # Slow refund processing (>5 seconds)
      - alert: AdminRefundSlowProcessing
        expr: admin:refund_processing_time:p95 > 5000
        for: 5m
        labels:
          severity: warning
          component: admin-api
          category: refunds
        annotations:
          summary: "Slow refund processing"
          description: "95th percentile refund processing time is {{ $value | humanizeDuration }}ms (threshold: 5000ms)"
          impact: "Admins experiencing delays when processing refunds"
          action: "Check Stripe API response times. Review refund processing logs."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#slow-refunds"
      
      # High refund failure rate
      - alert: AdminRefundHighFailureRate
        expr: |
          (
            sum(rate(admin_refund_attempts_total{status="failed"}[5m]))
            /
            sum(rate(admin_refund_attempts_total[5m]))
          ) * 100 > 20
        for: 5m
        labels:
          severity: warning
          component: admin-api
          category: refunds
        annotations:
          summary: "High refund failure rate"
          description: "Refund failure rate is {{ $value | humanizePercentage }}% (threshold: 20%)"
          impact: "Admins unable to process refunds. Customer service impact."
          action: "Check Stripe API status. Review refund error logs. Verify transaction eligibility."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#refund-failures"

  - name: admin_database_alerts
    interval: 30s
    rules:
      # Database connection issues
      - alert: AdminDatabaseConnectionIssues
        expr: admin_db_pool_waiting_requests > 10
        for: 2m
        labels:
          severity: critical
          component: admin-api
          category: database
        annotations:
          summary: "Database connection pool exhausted"
          description: "{{ $value }} requests waiting for database connection"
          impact: "Admin API experiencing severe performance degradation or failures"
          action: "Check database connectivity. Review connection pool configuration. Scale database if needed."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#db-connection-issues"
      
      # Low database connection pool availability
      - alert: AdminDatabaseLowPoolAvailability
        expr: (admin_db_pool_idle_connections / admin_db_pool_size) < 0.1
        for: 5m
        labels:
          severity: warning
          component: admin-api
          category: database
        annotations:
          summary: "Low database connection pool availability"
          description: "Only {{ $value | humanizePercentage }}% of connections are idle (threshold: 10%)"
          impact: "Database connection pool under heavy load. May lead to connection exhaustion."
          action: "Monitor connection pool usage. Consider increasing pool size. Review long-running queries."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#low-pool-availability"
      
      # Slow database queries
      - alert: AdminDatabaseSlowQueries
        expr: admin:db_query_time:p95 > 100
        for: 5m
        labels:
          severity: warning
          component: admin-api
          category: database
        annotations:
          summary: "Slow database queries"
          description: "95th percentile database query time is {{ $value }}ms (threshold: 100ms)"
          impact: "Admin API performance degradation"
          action: "Review slow query logs. Check for missing indexes. Optimize queries."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#slow-queries"
      
      # Very slow database queries
      - alert: AdminDatabaseVerySlowQueries
        expr: admin:db_query_time:p95 > 500
        for: 2m
        labels:
          severity: critical
          component: admin-api
          category: database
        annotations:
          summary: "Very slow database queries"
          description: "95th percentile database query time is {{ $value }}ms (threshold: 500ms)"
          impact: "CRITICAL: Admin API severely degraded. Users experiencing timeouts."
          action: "URGENT: Identify slow queries. Check database load. Consider emergency optimization."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#very-slow-queries"

  - name: admin_stripe_alerts
    interval: 30s
    rules:
      # Stripe API errors
      - alert: AdminStripeApiErrors
        expr: rate(admin_stripe_api_errors_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
          component: admin-api
          category: stripe
        annotations:
          summary: "Stripe API errors detected"
          description: "{{ $value }} Stripe API errors per second"
          impact: "Payment and subscription operations may be failing"
          action: "Check Stripe API status. Review error logs. Verify API credentials."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#stripe-errors"
      
      # High Stripe API error rate
      - alert: AdminStripeApiHighErrorRate
        expr: admin:stripe_api_error_percentage:rate5m > 10
        for: 5m
        labels:
          severity: critical
          component: admin-api
          category: stripe
        annotations:
          summary: "High Stripe API error rate"
          description: "Stripe API error rate is {{ $value | humanizePercentage }}% (threshold: 10%)"
          impact: "CRITICAL: Most Stripe operations are failing. Payment system compromised."
          action: "URGENT: Check Stripe service status. Verify API keys. Review recent changes."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#high-stripe-error-rate"
      
      # Stripe API rate limiting
      - alert: AdminStripeApiRateLimited
        expr: rate(admin_stripe_api_errors_total{error_type="rate_limit"}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          component: admin-api
          category: stripe
        annotations:
          summary: "Stripe API rate limiting detected"
          description: "{{ $value }} rate limit errors per second"
          impact: "Stripe operations being throttled. May cause delays or failures."
          action: "Review API usage patterns. Implement request batching. Contact Stripe for limit increase."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#stripe-rate-limit"
      
      # Slow Stripe API responses
      - alert: AdminStripeApiSlowResponses
        expr: admin:stripe_api_response_time:p95 > 5000
        for: 5m
        labels:
          severity: warning
          component: admin-api
          category: stripe
        annotations:
          summary: "Slow Stripe API responses"
          description: "95th percentile Stripe API response time is {{ $value | humanizeDuration }}ms (threshold: 5000ms)"
          impact: "Payment and refund operations experiencing delays"
          action: "Check Stripe API status. Monitor Stripe service health. Consider retry logic."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#slow-stripe-responses"

  - name: admin_auth_alerts
    interval: 30s
    rules:
      # High authentication failure rate
      - alert: AdminAuthHighFailureRate
        expr: admin:auth_failure_percentage:rate5m > 20
        for: 5m
        labels:
          severity: warning
          component: admin-api
          category: authentication
        annotations:
          summary: "High admin authentication failure rate"
          description: "Authentication failure rate is {{ $value | humanizePercentage }}% (threshold: 20%)"
          impact: "Admins may be unable to access Admin Center"
          action: "Check Auth0 service status. Review authentication logs. Verify JWT configuration."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#auth-failures"
      
      # Possible brute force attack
      - alert: AdminAuthPossibleBruteForce
        expr: rate(admin_auth_attempts_total{result="failed"}[1m]) > 10
        for: 2m
        labels:
          severity: critical
          component: admin-api
          category: security
        annotations:
          summary: "Possible brute force attack on admin authentication"
          description: "{{ $value }} failed authentication attempts per second"
          impact: "SECURITY: Possible unauthorized access attempt"
          action: "URGENT: Review authentication logs. Check source IPs. Enable rate limiting. Consider blocking suspicious IPs."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#brute-force"

  - name: admin_service_alerts
    interval: 30s
    rules:
      # Admin API service down
      - alert: AdminApiServiceDown
        expr: up{job="admin-api"} == 0
        for: 2m
        labels:
          severity: critical
          component: admin-api
          category: availability
        annotations:
          summary: "Admin API service is down"
          description: "Admin API service has been unavailable for more than 2 minutes"
          impact: "CRITICAL: Admin Center completely unavailable. No admin operations possible."
          action: "URGENT: Check service status. Review deployment logs. Restart service if needed."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#service-down"
      
      # High memory usage
      - alert: AdminApiHighMemoryUsage
        expr: (admin_process_resident_memory_bytes / admin_process_heap_bytes) > 0.9
        for: 5m
        labels:
          severity: warning
          component: admin-api
          category: resources
        annotations:
          summary: "High memory usage in Admin API"
          description: "Memory usage is {{ $value | humanizePercentage }}% (threshold: 90%)"
          impact: "Service may crash or experience performance degradation"
          action: "Review memory usage patterns. Check for memory leaks. Consider scaling resources."
          runbook_url: "https://docs.cloudtolocalllm.online/operations/admin-center-troubleshooting#high-memory"
