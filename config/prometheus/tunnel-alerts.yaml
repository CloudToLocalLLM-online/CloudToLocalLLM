groups:
  - name: tunnel_alerts
    interval: 30s
    rules:
      # High error rate alert
      - alert: TunnelHighErrorRate
        expr: (rate(tunnel_errors_total[5m]) / rate(tunnel_requests_total[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
          component: tunnel
        annotations:
          summary: "High error rate detected in tunnel service"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%) for the last 5 minutes"
          runbook_url: "https://docs.cloudtolocalllm.online/operations/tunnel-troubleshooting"
      
      # High latency alert
      - alert: TunnelHighLatency
        expr: histogram_quantile(0.95, rate(tunnel_request_latency_ms_bucket[5m])) > 200
        for: 5m
        labels:
          severity: warning
          component: tunnel
        annotations:
          summary: "High latency detected in tunnel requests"
          description: "95th percentile latency is {{ $value | humanizeDuration }}ms (threshold: 200ms)"
          runbook_url: "https://docs.cloudtolocalllm.online/operations/tunnel-troubleshooting"
      
      # Connection storm alert
      - alert: TunnelConnectionStorm
        expr: increase(tunnel_connections_total[1m]) > 1000
        for: 1m
        labels:
          severity: critical
          component: tunnel
        annotations:
          summary: "Connection storm detected in tunnel service"
          description: "{{ $value }} new connections in the last minute (threshold: 1000)"
          runbook_url: "https://docs.cloudtolocalllm.online/operations/tunnel-troubleshooting"
      
      # Circuit breaker open alert
      - alert: TunnelCircuitBreakerOpen
        expr: tunnel_circuit_breaker_state == 1
        for: 5m
        labels:
          severity: critical
          component: tunnel
        annotations:
          summary: "Circuit breaker is open in tunnel service"
          description: "Circuit breaker for {{ $labels.service }} has been open for more than 5 minutes"
          runbook_url: "https://docs.cloudtolocalllm.online/operations/tunnel-troubleshooting"
      
      # Queue nearly full alert
      - alert: TunnelQueueNearlyFull
        expr: tunnel_queue_fill_percentage > 0.9
        for: 2m
        labels:
          severity: warning
          component: tunnel
        annotations:
          summary: "Tunnel request queue is nearly full"
          description: "Queue fill percentage is {{ $value | humanizePercentage }} (threshold: 90%) for user {{ $labels.user_id }}"
          runbook_url: "https://docs.cloudtolocalllm.online/operations/tunnel-troubleshooting"
      
      # High active connections alert
      - alert: TunnelHighActiveConnections
        expr: tunnel_active_connections > 500
        for: 5m
        labels:
          severity: warning
          component: tunnel
        annotations:
          summary: "High number of active tunnel connections"
          description: "{{ $value }} active connections (threshold: 500) for tier {{ $labels.user_tier }}"
          runbook_url: "https://docs.cloudtolocalllm.online/operations/tunnel-troubleshooting"
      
      # Rate limit violations alert
      - alert: TunnelRateLimitViolations
        expr: increase(tunnel_rate_limit_violations_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: tunnel
        annotations:
          summary: "High rate limit violations in tunnel service"
          description: "{{ $value }} rate limit violations in the last 5 minutes"
          runbook_url: "https://docs.cloudtolocalllm.online/operations/tunnel-troubleshooting"
      
      # Service unavailable alert
      - alert: TunnelServiceUnavailable
        expr: up{job="streaming-proxy"} == 0
        for: 2m
        labels:
          severity: critical
          component: tunnel
        annotations:
          summary: "Tunnel service is unavailable"
          description: "Streaming proxy service has been down for more than 2 minutes"
          runbook_url: "https://docs.cloudtolocalllm.online/operations/tunnel-troubleshooting"
