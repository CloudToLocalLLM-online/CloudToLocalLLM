# Simplified container for tunnel-aware applications
# Uses standard HTTP libraries to communicate through tunnel proxy

FROM node:24-alpine AS production

# Install curl for health checks and HTTP requests
RUN apk add --no-cache curl

# Security: Create non-root user
RUN addgroup -g 1001 -S appuser && \
    adduser -S -D -H -u 1001 -s /sbin/nologin -G appuser appuser

# Set working directory
WORKDIR /app

# Create simple HTTP client script for testing tunnel connectivity
COPY <<'EOF' test-tunnel.js
const http = require('http');
const https = require('https');

const OLLAMA_BASE_URL = process.env.OLLAMA_BASE_URL || 'http://localhost:11434';
const USER_ID = process.env.USER_ID;

console.log(`Testing tunnel connectivity for user: ${USER_ID}`);
console.log(`OLLAMA_BASE_URL: ${OLLAMA_BASE_URL}`);

// Simple health check request
const url = new URL('/api/tags', OLLAMA_BASE_URL);
const client = url.protocol === 'https:' ? https : http;

const req = client.request(url, {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json',
    'User-Agent': 'CloudToLocalLLM-Container/1.0'
  }
}, (res) => {
  console.log(`Response status: ${res.statusCode}`);
  console.log(`Response headers:`, res.headers);
  
  let data = '';
  res.on('data', chunk => data += chunk);
  res.on('end', () => {
    console.log('Response body:', data);
    process.exit(res.statusCode === 200 ? 0 : 1);
  });
});

req.on('error', (error) => {
  console.error('Request failed:', error.message);
  process.exit(1);
});

req.setTimeout(30000, () => {
  console.error('Request timeout');
  req.destroy();
  process.exit(1);
});

req.end();
EOF

# Create health check script
COPY <<'EOF' health-check.js
const http = require('http');

// Simple health check that verifies container is running
const server = http.createServer((req, res) => {
  if (req.url === '/health') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({
      status: 'healthy',
      userId: process.env.USER_ID,
      ollamaBaseUrl: process.env.OLLAMA_BASE_URL,
      timestamp: new Date().toISOString()
    }));
  } else {
    res.writeHead(404);
    res.end('Not found');
  }
});

const port = process.env.HEALTH_PORT || 8080;
server.listen(port, () => {
  console.log(`Health check server listening on port ${port}`);
});
EOF

# Security: Set proper ownership and permissions
RUN chown -R appuser:appuser /app && \
    chmod +x /app/*.js

# Health check for container monitoring
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# Security: Switch to non-root user
USER appuser

# Expose health check port
EXPOSE 8080

# Environment variables for tunnel configuration
ENV NODE_ENV=production
ENV HEALTH_PORT=8080
ENV LOG_LEVEL=info
# OLLAMA_BASE_URL will be set by container orchestrator to tunnel proxy endpoint

# Start health check server by default
CMD ["node", "health-check.js"]
