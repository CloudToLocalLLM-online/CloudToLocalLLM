# ============================================================================
# Deployer Dockerfile for CloudToLocalLLM
# Contains kubectl, kustomize, and psql for in-cluster deployment tasks
# ============================================================================
FROM cloudtolocalllm/base:latest

USER root

# Install kubectl
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" && \
    install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl && \
    rm kubectl

# Install kustomize
RUN curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash && \
    mv kustomize /usr/local/bin/

# Install PostgreSQL client (psql)
RUN dnf -y install postgresql && \
    dnf clean all

# Switch back to non-root user
USER cloudtolocalllm
WORKDIR /app

# Copy scripts and manifests
COPY --chown=cloudtolocalllm:cloudtolocalllm k8s/ k8s/
COPY --chown=cloudtolocalllm:cloudtolocalllm scripts/ scripts/

# Ensure script is executable (fix for Windows creation)
RUN chmod +x scripts/deploy-in-cluster.sh
