# CloudToLocalLLM Web App - Google Cloud Run Optimized
# Multi-stage build optimized for Cloud Run deployment
# Features: Fast cold starts, minimal image size, proper health checks

# Stage 1: Build the Flutter web app
FROM ghcr.io/cirruslabs/flutter:latest AS build

WORKDIR /app

# Create a non-root user and group
RUN groupadd -r fluttergroup && useradd -r -g fluttergroup -m -s /sbin/nologin flutteruser

# Change ownership of /app and /sdks/flutter to flutteruser
RUN chown -R flutteruser:fluttergroup /app && \
    chown -R flutteruser:fluttergroup /sdks/flutter

# Copy pubspec files first to leverage Docker cache for dependencies
COPY --chown=flutteruser:fluttergroup pubspec.yaml ./
COPY --chown=flutteruser:fluttergroup pubspec.lock ./

# Switch to non-root user for flutter commands
USER flutteruser

# Add Flutter SDK directory as a safe directory for git
RUN git config --global --add safe.directory /sdks/flutter

# Get dependencies
RUN flutter pub get

# Copy the rest of the application source code
COPY --chown=flutteruser:fluttergroup . .

# Build the Flutter web application with optimizations for Cloud Run
RUN flutter build web --release

# Stage 2: Serve with Nginx optimized for Cloud Run
FROM nginx:alpine

# Install curl for health checks
RUN apk add --no-cache curl

# Create nginx user directories
RUN mkdir -p /var/cache/nginx/client_temp \
             /var/cache/nginx/proxy_temp \
             /var/cache/nginx/fastcgi_temp \
             /var/cache/nginx/uwsgi_temp \
             /var/cache/nginx/scgi_temp \
             /var/run/nginx \
             /var/log/nginx && \
    chown -R nginx:nginx /var/cache/nginx /var/run/nginx /var/log/nginx && \
    chmod -R 755 /var/cache/nginx /var/run/nginx

# Copy the built web app from the build stage
COPY --from=build /app/build/web /usr/share/nginx/html

# Copy Cloud Run configuration
COPY web/cloudrun-config.js /usr/share/nginx/html/

# Copy Cloud Run optimized nginx configuration
COPY config/cloudrun/nginx-cloudrun.conf /etc/nginx/nginx.conf

# Set permissions for nginx user
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chmod -R 755 /usr/share/nginx/html

# Create health check endpoint
RUN echo '<!DOCTYPE html><html><body><h1>OK</h1></body></html>' > /usr/share/nginx/html/health

# Switch to non-root user
USER nginx

# Cloud Run requires listening on PORT environment variable
# Default to 8080 if not set
ENV PORT=8080

# Expose the port
EXPOSE $PORT

# Health check for Cloud Run
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl --fail http://localhost:$PORT/health || exit 1

# Start nginx with envsubst to handle PORT variable
CMD envsubst '$$PORT' < /etc/nginx/nginx.conf > /tmp/nginx.conf && \
    nginx -c /tmp/nginx.conf -g 'daemon off;'
