# ============================================================================
# Runtime Dockerfile for CloudToLocalLLM Streaming Proxy
# Uses artifacts from the Universal Builder
# ============================================================================

# Use custom Fedora base (cloudtolocalllm/base:latest)
FROM cloudtolocalllm/base:latest

# Switch to root to install Node.js
USER root
# Install NVM and Node.js 24
# We need to install as the cloudtolocalllm user to match the builder
USER cloudtolocalllm
ENV NVM_DIR=/home/cloudtolocalllm/.nvm
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash && \
    . "$NVM_DIR/nvm.sh" && \
    nvm install 24 && \
    nvm alias default 24 && \
    nvm use default && \
    ln -s $(dirname $(nvm which default)) /home/cloudtolocalllm/node-bin

# Add Node.js to PATH
ENV PATH="/home/cloudtolocalllm/node-bin:$PATH"

# Switch back to root for directory setup if needed, but we are already cloudtolocalllm below
USER root

WORKDIR /app

# Copy artifacts (node_modules + code) from local filesystem
# Ensure ownership by cloudtolocalllm
COPY --chown=cloudtolocalllm:cloudtolocalllm services/streaming-proxy/node_modules ./node_modules
COPY --chown=cloudtolocalllm:cloudtolocalllm services/streaming-proxy/ .

# Switch to non-root user
USER cloudtolocalllm

EXPOSE 8081
CMD [ "node", "dist/main.js" ]
