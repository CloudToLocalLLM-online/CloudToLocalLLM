
> cloudtolocalllm-api-backend@1.0.0 test
> node --experimental-vm-modules ./node_modules/jest/bin/jest.js --testNamePattern=UserProfileService

 Setting up global test environment...
 Global test setup completed
(node:51724) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL ../../test/api-backend/user-profile.test.js
  ΓùÅ UserProfileService ΓÇ║ updateUserProfile ΓÇ║ should validate profile data before updating

    expect(received).rejects.toThrow(expected)

    Expected substring: "Invalid first name"
    Received message:   "First name: Name must be between 0 and 100 characters"

          143 |       if (!validation.valid) {
          144 |         logValidationError('PUT /api/users/profile', userId, 'profile', validation.error);
        > 145 |         throw new Error(validation.error);
              |               ^
          146 |       }
          147 |
          148 |       // Use sanitized data

      at UserProfileService.updateUserProfile (services/user-profile-service.js:145:15)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:229:28)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:230:17)

  ΓùÅ UserProfileService ΓÇ║ updateUserProfile ΓÇ║ should validate avatar URL format

    expect(received).rejects.toThrow(expected)

    Expected substring: "Invalid avatar URL format"
    Received message:   "Avatar: Invalid URL format"

          143 |       if (!validation.valid) {
          144 |         logValidationError('PUT /api/users/profile', userId, 'profile', validation.error);
        > 145 |         throw new Error(validation.error);
              |               ^
          146 |       }
          147 |
          148 |       // Use sanitized data

      at UserProfileService.updateUserProfile (services/user-profile-service.js:145:15)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:243:28)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:244:17)

  ΓùÅ UserProfileService ΓÇ║ updateUserPreferences ΓÇ║ should validate theme preference

    expect(received).rejects.toThrow(expected)

    Expected substring: "Invalid theme"
    Received message:   "Theme must be one of: light, dark"

          237 |       if (!validation.valid) {
          238 |         logValidationError('PUT /api/users/preferences', userId, 'preferences', validation.error);
        > 239 |         throw new Error(validation.error);
              |               ^
          240 |       }
          241 |
          242 |       const sanitizedPreferences = validation.data;

      at UserProfileService.updateUserPreferences (services/user-profile-service.js:239:15)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:303:28)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:304:17)

  ΓùÅ UserProfileService ΓÇ║ updateUserAvatar ΓÇ║ should validate avatar URL format

    expect(received).rejects.toThrow(expected)

    Expected substring: "Invalid avatar URL format"
    Received message:   "Invalid URL format"

          328 |     if (!urlValidation.valid) {
          329 |       logValidationError('PUT /api/users/avatar', userId, 'avatarUrl', urlValidation.error);
        > 330 |       throw new Error(urlValidation.error);
              |             ^
          331 |     }
          332 |
          333 |     try {

      at UserProfileService.updateUserAvatar (services/user-profile-service.js:330:13)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:427:28)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:428:17)

  ΓùÅ UserProfileService ΓÇ║ Preference Validation ΓÇ║ should validate language length

    expect(received).rejects.toThrow(expected)

    Expected substring: "Invalid language"
    Received message:   "Language must be between 1 and 10 characters"

          237 |       if (!validation.valid) {
          238 |         logValidationError('PUT /api/users/preferences', userId, 'preferences', validation.error);
        > 239 |         throw new Error(validation.error);
              |               ^
          240 |       }
          241 |
          242 |       const sanitizedPreferences = validation.data;

      at UserProfileService.updateUserPreferences (services/user-profile-service.js:239:15)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:502:28)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:503:17)

  ΓùÅ UserProfileService ΓÇ║ Profile Data Validation ΓÇ║ should validate name lengths

    expect(received).rejects.toThrow(expected)

    Expected substring: "Invalid last name"
    Received message:   "Last name: Name must be between 0 and 100 characters"

          143 |       if (!validation.valid) {
          144 |         logValidationError('PUT /api/users/profile', userId, 'profile', validation.error);
        > 145 |         throw new Error(validation.error);
              |               ^
          146 |       }
          147 |
          148 |       // Use sanitized data

      at UserProfileService.updateUserProfile (services/user-profile-service.js:145:15)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:518:28)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:519:17)

  ΓùÅ UserProfileService ΓÇ║ Profile Data Validation ΓÇ║ should validate nickname length

    expect(received).rejects.toThrow(expected)

    Expected substring: "Invalid nickname"
    Received message:   "Nickname must be between 0 and 100 characters"

          143 |       if (!validation.valid) {
          144 |         logValidationError('PUT /api/users/profile', userId, 'profile', validation.error);
        > 145 |         throw new Error(validation.error);
              |               ^
          146 |       }
          147 |
          148 |       // Use sanitized data

      at UserProfileService.updateUserProfile (services/user-profile-service.js:145:15)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:532:28)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (../../test/api-backend/user-profile.test.js:533:17)


ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From ../../test/api-backend/security/user-isolation.test.js.



ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From ../../test/api-backend/security/user-isolation.test.js.



ReferenceError: You are trying to `import` a file after the Jest environment has been torn down. From ../../test/api-backend/security/user-isolation.test.js.


FAIL ../../test/api-backend/security/user-isolation.test.js
  ΓùÅ Test suite failed to run

    Configuration error:

    Could not locate module ../../tunnel/tunnel-proxy.js mapped as:
    E:\dev\CloudToLocalLLM\services\api-backend\tunnel\$1.js.

    Please check your configuration for these entries:
    {
      "moduleNameMapper": {
        "/^\.\.\/\.\.\/tunnel\/(.*)\.js$/": "E:\dev\CloudToLocalLLM\services\api-backend\tunnel\$1.js"
      },
      "resolver": undefined
    }

      at createNoMappedModuleFoundError (node_modules/jest-resolve/build/resolver.js:759:17)

FAIL ../../test/api-backend/message-protocol.test.js
  ΓùÅ Test suite failed to run

    Configuration error:

    Could not locate module ../tunnel/message-protocol.js mapped as:
    E:\dev\CloudToLocalLLM\services\api-backend\tunnel\$1.js.

    Please check your configuration for these entries:
    {
      "moduleNameMapper": {
        "/^\.\.\/tunnel\/(.*)\.js$/": "E:\dev\CloudToLocalLLM\services\api-backend\tunnel\$1.js"
      },
      "resolver": undefined
    }

      at createNoMappedModuleFoundError (node_modules/jest-resolve/build/resolver.js:759:17)

FAIL ../../test/api-backend/bridge-polling-routes.test.js
  ΓùÅ Test suite failed to run

    ReferenceError: jest is not defined

      10 |
      11 | // Mock the logger
    > 12 | jest.mock('../../services/api-backend/utils/logger.js', () => ({
         | ^
      13 |   TunnelLogger: jest.fn().mockImplementation(() => ({
      14 |     info: jest.fn(),
      15 |     debug: jest.fn(),

      at ../../test/api-backend/bridge-polling-routes.test.js:12:1

---------------------------------|---------|----------|---------|---------|-----------------------------------------------------------------------------------------------
File                             | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                             
---------------------------------|---------|----------|---------|---------|-----------------------------------------------------------------------------------------------
All files                        |    3.04 |     4.18 |    2.56 |    3.04 |                                                                                               
 api-backend                     |    2.36 |     2.32 |    0.75 |    2.37 |                                                                                               
  admin-data-flush-service.js    |    3.03 |        0 |    5.88 |    3.03 | 36-509                                                                                        
  admin-server.js                |       0 |        0 |       0 |       0 | 33-1350                                                                                       
  jest.setup.js                  |       0 |        0 |       0 |       0 | 7-25                                                                                          
  logger.js                      |   30.76 |    18.18 |       0 |   30.76 | 26-38,61-79,114-136,142-145,149-152,156-159,163-166                                           
  server.js                      |       0 |        0 |       0 |       0 | 41-849                                                                                        
  streaming-proxy-manager.js     |       0 |        0 |       0 |       0 | 7-396                                                                                         
  tracing.js                     |       0 |      100 |     100 |       0 | 8-23                                                                                          
 api-backend/auth                |    4.43 |    10.78 |    4.76 |    4.47 |                                                                                               
  auth-service.js                |    4.43 |    10.78 |    4.76 |    4.47 | 46-788                                                                                        
 api-backend/database            |    3.05 |    15.87 |    1.63 |    3.06 |                                                                                               
  db-pool.js                     |    6.55 |    56.66 |       0 |    6.55 | 71-279                                                                                        
  migrate-auth-pg.js             |       0 |        0 |       0 |       0 | 12-124                                                                                        
  migrate-pg.js                  |       0 |        0 |       0 |       0 | 12-210                                                                                        
  migrate.js                     |    4.92 |    13.04 |    6.25 |    4.96 | 37-459,467                                                                                    
  pool-monitor.js                |       0 |        0 |       0 |       0 | 18-271                                                                                        
 api-backend/database/migrations |       0 |        0 |       0 |       0 |                                                                                               
  run-migration.js               |       0 |        0 |       0 |       0 | 21-279                                                                                        
 api-backend/database/seeds      |       0 |        0 |       0 |       0 |                                                                                               
  run-seed.js                    |       0 |        0 |       0 |       0 | 22-208                                                                                        
 api-backend/middleware          |    1.23 |     0.57 |       0 |    1.23 |                                                                                               
  activity-logging.js            |       0 |        0 |       0 |       0 | 19-221                                                                                        
  admin-auth.js                  |       0 |        0 |       0 |       0 | 15-227                                                                                        
  admin-metrics.js               |       0 |        0 |       0 |       0 | 25-453                                                                                        
  admin-rate-limiter.js          |       0 |        0 |       0 |       0 | 23-247                                                                                        
  api-key-auth.js                |       0 |        0 |       0 |       0 | 23-227                                                                                        
  auth-audit-middleware.js       |       0 |        0 |       0 |       0 | 30-404                                                                                        
  auth.js                        |    3.84 |     1.51 |       0 |    3.84 | 37-573                                                                                        
  connection-security.js         |    0.56 |        0 |       0 |    0.57 | 70-763                                                                                        
  cors-config.js                 |       0 |        0 |       0 |       0 | 18-228                                                                                        
  graceful-shutdown.js           |       0 |        0 |       0 |       0 | 23-199                                                                                        
  https-enforcer.js              |       0 |        0 |       0 |       0 | 19-219                                                                                        
  input-sanitizer.js             |       0 |        0 |       0 |       0 | 21-340                                                                                        
  jwt-validator.js               |    0.51 |        0 |       0 |    0.52 | 45-684                                                                                        
  pipeline.js                    |       0 |        0 |       0 |       0 | 55-173                                                                                        
  rate-limiter.js                |     2.5 |     1.96 |       0 |     2.5 | 41-522                                                                                        
  rbac.js                        |    3.52 |        0 |       0 |    3.61 | 153-438                                                                                       
  request-logging.js             |       0 |        0 |       0 |       0 | 19-72                                                                                         
  request-timeout.js             |       0 |        0 |       0 |       0 | 19-61                                                                                         
  request-validation.js          |       0 |        0 |       0 |       0 | 18-109                                                                                        
  security-audit-logger.js       |    1.41 |        0 |       0 |    1.42 | 78-798                                                                                        
  tier-check.js                  |     3.8 |     6.25 |       0 |     3.8 | 73-451                                                                                        
 api-backend/routes              |    0.59 |        0 |       0 |     0.6 |                                                                                               
  admin-metrics.js               |       0 |      100 |       0 |       0 | 15-34                                                                                         
  admin.js                       |       0 |        0 |       0 |       0 | 40-399                                                                                        
  api-keys.js                    |     8.6 |        0 |       0 |    8.88 | 56-113,142-158,185-209,231-293,319-344,361-387,409-427                                        
  auth-audit.js                  |       0 |        0 |       0 |       0 | 25-429                                                                                        
  auth.js                        |       0 |        0 |       0 |       0 | 17-476                                                                                        
  bridge-polling-routes.js       |       0 |        0 |       0 |       0 | 13-504                                                                                        
  client-logs.js                 |       0 |        0 |       0 |       0 | 5-43                                                                                          
  conversations.js               |       0 |        0 |       0 |       0 | 15-474                                                                                        
  db-health.js                   |       0 |        0 |       0 |       0 | 18-114                                                                                        
  direct-proxy-routes.js         |       0 |        0 |       0 |       0 | 24-477                                                                                        
  monitoring.js                  |       0 |        0 |       0 |       0 | 14-414                                                                                        
  sessions.js                    |       0 |        0 |       0 |       0 | 1-177                                                                                         
  turn-credentials.js            |       0 |        0 |       0 |       0 | 14-66                                                                                         
  user-activity.js               |       0 |        0 |       0 |       0 | 31-286                                                                                        
  user-deletion.js               |       0 |        0 |       0 |       0 | 26-425                                                                                        
  user-profile.js                |       0 |        0 |       0 |       0 | 28-482                                                                                        
  users.js                       |       0 |        0 |       0 |       0 | 29-418                                                                                        
  webhooks.js                    |       0 |        0 |       0 |       0 | 20-376                                                                                        
 api-backend/routes/admin        |       0 |        0 |       0 |       0 |                                                                                               
  admins.js                      |       0 |        0 |       0 |       0 | 26-466                                                                                        
  audit.js                       |       0 |        0 |       0 |       0 | 25-582                                                                                        
  dashboard.js                   |       0 |        0 |       0 |       0 | 25-261                                                                                        
  dns.js                         |       0 |        0 |       0 |       0 | 28-688                                                                                        
  email.js                       |       0 |        0 |       0 |       0 | 33-1429                                                                                       
  payments.js                    |       0 |        0 |       0 |       0 | 27-881                                                                                        
  reports.js                     |       0 |        0 |       0 |       0 | 26-756                                                                                        
  subscriptions.js               |       0 |        0 |       0 |       0 | 19-815                                                                                        
  users.js                       |       0 |        0 |       0 |       0 | 27-949                                                                                        
 api-backend/scripts             |       0 |        0 |       0 |       0 |                                                                                               
  test-auth-flow.js              |       0 |        0 |       0 |       0 | 12-202                                                                                        
  test-database.js               |       0 |        0 |       0 |       0 | 12-148                                                                                        
 api-backend/services            |    4.77 |     6.02 |    3.33 |    4.78 |                                                                                               
  alerting-service.js            |       0 |        0 |       0 |       0 | 23-292                                                                                        
  api-key-service.js             |    2.67 |        0 |       0 |    2.67 | 33-473                                                                                        
  auth-audit-service.js          |    1.35 |        0 |       0 |    1.35 | 65-566                                                                                        
  cloudflare-dns-service.js      |       0 |        0 |       0 |       0 | 18-704                                                                                        
  email-config-service.js        |       0 |        0 |       0 |       0 | 18-827                                                                                        
  email-queue-service.js         |       0 |        0 |       0 |       0 | 19-747                                                                                        
  google-workspace-service.js    |       0 |        0 |       0 |       0 | 20-697                                                                                        
  health-check.js                |       0 |        0 |       0 |       0 | 10-174                                                                                        
  index.js                       |       0 |        0 |       0 |       0 |                                                                                               
  payment-service.js             |       0 |        0 |       0 |       0 | 14-268                                                                                        
  refund-service.js              |       0 |        0 |       0 |       0 | 15-355                                                                                        
  stripe-client.js               |       0 |        0 |       0 |       0 | 13-169                                                                                        
  subscription-service.js        |       0 |        0 |       0 |       0 | 14-600                                                                                        
  user-activity-service.js       |    1.19 |        0 |       0 |    1.19 | 87-557                                                                                        
  user-deletion-service.js       |       0 |        0 |       0 |       0 | 31-439                                                                                        
  user-profile-service.js        |   66.37 |    53.15 |   66.66 |   66.37 | 42-49,133,137,227,231,280,323,364-426                                                         
 api-backend/tunnel              |       0 |        0 |       0 |       0 |                                                                                               
  ssh-auth-handler.js            |       0 |        0 |       0 |       0 | 15-210                                                                                        
  ssh-proxy.js                   |       0 |        0 |       0 |       0 | 18-594                                                                                        
  tunnel-routes.js               |       0 |        0 |       0 |       0 | 31-245                                                                                        
 api-backend/utils               |   40.39 |    36.84 |      30 |   40.15 |                                                                                               
  audit-logger.js                |       0 |        0 |       0 |       0 | 37-322                                                                                        
  input-validation.js            |   65.54 |     59.6 |      68 |    65.3 | 30-33,46,74-80,91,112,125-157,179-215,238,247,260-268,280,319,328,356,394,416,436,453,480,504 
  logger.js                      |   16.66 |     2.32 |    4.76 |   16.66 | 84-384                                                                                        
---------------------------------|---------|----------|---------|---------|-----------------------------------------------------------------------------------------------
Jest: "global" coverage threshold for statements (70%) not met: 3.04%
Jest: "global" coverage threshold for branches (70%) not met: 4.18%
Jest: "global" coverage threshold for lines (70%) not met: 3.04%
Jest: "global" coverage threshold for functions (70%) not met: 2.56%
Test Suites: 4 failed, 13 skipped, 4 of 17 total
Tests:       7 failed, 416 skipped, 18 passed, 441 total
Snapshots:   0 total
Time:        3.469 s
Ran all test suites with tests matching "UserProfileService".
∩┐╜ Cleaning up global test environment...
 Global test cleanup completed
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
