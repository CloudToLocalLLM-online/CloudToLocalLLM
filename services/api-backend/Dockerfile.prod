# ============================================================================
# Runtime Dockerfile for CloudToLocalLLM API Backend
# Uses artifacts from the Universal Builder
# ============================================================================

# Use custom Fedora base (cloudtolocalllm/base:latest)
FROM cloudtolocalllm/base:latest

# Switch to root to install Node.js
USER root
RUN dnf -y install nodejs npm && \
    dnf clean all

# Create isolated data directories
WORKDIR /api
RUN mkdir -p /api/data /api/logs && \
    chown -R cloudtolocalllm:cloudtolocalllm /api

# Copy artifacts (node_modules + code) from local filesystem
# Ensure ownership by cloudtolocalllm
COPY --chown=cloudtolocalllm:cloudtolocalllm services/api-backend/node_modules ./node_modules
COPY --chown=cloudtolocalllm:cloudtolocalllm services/api-backend/ .

# Switch to non-root user
USER cloudtolocalllm

# Set environment variables
ENV LOG_DIR=/api/logs
ENV DB_PATH=/api/data/cloudtolocalllm.db
ENV SSH_PORT=2222

EXPOSE 3000
EXPOSE 8080
CMD [ "npm", "start" ]
