# ---- Base Node ----
FROM node:24-alpine AS base
WORKDIR /api

# Build tools for native modules (sqlite3)
RUN apk add --no-cache python3 make g++

# Copy package files
COPY services/api-backend/package*.json ./

# Install dependencies (run as root for system packages, then change ownership)
RUN npm ci && \
    chown -R 1001:1001 /api

# ---- Production ----
FROM node:24-alpine AS production

# Create non-root user
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

WORKDIR /api

# Copy files and change ownership
COPY --from=base --chown=nodejs:nodejs /api/node_modules ./node_modules
COPY --chown=nodejs:nodejs services/api-backend/ ./

# Switch to non-root user
USER nodejs

EXPOSE 3000
CMD [ "npm", "start" ]
