# ============================================================================
# Runtime Dockerfile for CloudToLocalLLM API Backend
# Uses artifacts from the Universal Builder
# ============================================================================

# Use custom Fedora base (cloudtolocalllm/base:latest)
FROM cloudtolocalllm/base:latest

# Switch to root to install Node.js
USER root
# Install NVM and Node.js 24
# We need to install as the cloudtolocalllm user to match the builder
USER cloudtolocalllm
ENV NVM_DIR=/home/cloudtolocalllm/.nvm
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash && \
    . "$NVM_DIR/nvm.sh" && \
    nvm install 24 && \
    nvm alias default 24 && \
    nvm use default && \
    ln -s $(dirname $(nvm which default)) /home/cloudtolocalllm/node-bin

# Add Node.js to PATH
ENV PATH="/home/cloudtolocalllm/node-bin:$PATH"

# Switch back to root for directory setup if needed, but we are already cloudtolocalllm below
USER root

# Create isolated data directories
WORKDIR /api
RUN mkdir -p /api/data /api/logs && \
    chown -R cloudtolocalllm:cloudtolocalllm /api

# Copy package files and install production dependencies
COPY --chown=cloudtolocalllm:cloudtolocalllm services/api-backend/package*.json ./
RUN npm install --omit=dev

# Copy application source
COPY --chown=cloudtolocalllm:cloudtolocalllm services/api-backend/ .

# Switch to non-root user
USER cloudtolocalllm

# Set environment variables
ENV LOG_DIR=/api/logs
ENV DB_PATH=/api/data/cloudtolocalllm.db
ENV SSH_PORT=2222

EXPOSE 3000
EXPOSE 8080
CMD [ "npm", "start" ]
