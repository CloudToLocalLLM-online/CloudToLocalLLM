# ============================================================================
# Runtime Dockerfile for CloudToLocalLLM API Backend
# Uses artifacts from the Universal Builder
# ============================================================================

# Use Debian Slim to match the Builder (Debian-based) for native module compatibility
FROM node:20-slim

# Install curl for health checks and python3/build-essential for any runtime rebuilds if absolutely needed (though we try to avoid it)
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Create non-root user (node image comes with 'node' user, usually 1000)
# We'll use the existing 'node' user

WORKDIR /api

# Create isolated data directories
RUN mkdir -p /api/data /api/logs && \
    chown -R node:node /api

# Copy artifacts (node_modules + code) from local filesystem
# The workflow downloads artifacts to services/api-backend
COPY services/api-backend/node_modules ./node_modules
COPY services/api-backend/ .

# Ensure data directories have correct ownership
RUN chown -R node:node /api/data /api/logs

# Switch to non-root user
USER node
ENV LOG_DIR=/api/logs
ENV DB_PATH=/api/data/cloudtolocalllm.db
ENV SSH_PORT=2222

EXPOSE 3000
EXPOSE 8080
CMD [ "npm", "start" ]
