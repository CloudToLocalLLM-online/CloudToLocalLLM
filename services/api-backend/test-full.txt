
> cloudtolocalllm-api-backend@1.0.0 test
> node --experimental-vm-modules ./node_modules/jest/bin/jest.js test/api-backend/request-queuing.test.js

 Setting up global test environment...
 Global test setup completed
(node:65576) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL ../../test/api-backend/request-queuing.test.js
  ΓùÅ RequestQueueService ΓÇ║ Queue timeout ΓÇ║ should timeout queued request after specified duration

    Queue cleared

      252 |           clearTimeout(entry.timeoutId);
      253 |         }
    > 254 |         entry.reject(new Error('Queue cleared'));
          |                      ^
      255 |       }
      256 |     }
      257 |     this.userQueues.clear();

      at RequestQueueService.clearAllQueues (services/request-queue-service.js:254:22)
      at Object.<anonymous> (../../test/api-backend/request-queuing.test.js:266:25)

  ΓùÅ RequestQueueService ΓÇ║ Queue timeout ΓÇ║ should timeout queued request after specified duration

    Queue cleared

      252 |           clearTimeout(entry.timeoutId);
      253 |         }
    > 254 |         entry.reject(new Error('Queue cleared'));
          |                      ^
      255 |       }
      256 |     }
      257 |     this.userQueues.clear();

      at RequestQueueService.clearAllQueues (services/request-queue-service.js:254:22)
      at Object.<anonymous> (../../test/api-backend/request-queuing.test.js:266:25)

  ΓùÅ RequestQueueService ΓÇ║ Queue timeout ΓÇ║ should timeout queued request after specified duration

    Queue cleared

      263 |           clearTimeout(entry.timeoutId);
      264 |         }
    > 265 |         entry.reject(new Error('Queue cleared'));
          |                      ^
      266 |       }
      267 |     }
      268 |     this.ipQueues.clear();

      at RequestQueueService.clearAllQueues (services/request-queue-service.js:265:22)
      at Object.<anonymous> (../../test/api-backend/request-queuing.test.js:266:25)

---------------------------------|---------|----------|---------|---------|-----------------------------------------------------
File                             | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                   
---------------------------------|---------|----------|---------|---------|-----------------------------------------------------
All files                        |    0.78 |     0.68 |    0.88 |    0.78 |                                                     
 api-backend                     |    1.86 |     2.32 |       0 |    1.87 |                                                     
  admin-data-flush-service.js    |       0 |        0 |       0 |       0 | 20-515                                              
  admin-server.js                |       0 |        0 |       0 |       0 | 33-1350                                             
  jest.setup.js                  |       0 |        0 |       0 |       0 | 7-25                                                
  logger.js                      |   30.76 |    18.18 |       0 |   30.76 | 26-38,61-79,114-136,142-145,149-152,156-159,163-166 
  server.js                      |       0 |        0 |       0 |       0 | 43-876                                              
  streaming-proxy-manager.js     |       0 |        0 |       0 |       0 | 7-396                                               
  tracing.js                     |       0 |      100 |     100 |       0 | 8-23                                                
 api-backend/auth                |       0 |        0 |       0 |       0 |                                                     
  auth-service.js                |       0 |        0 |       0 |       0 | 18-788                                              
 api-backend/database            |       0 |        0 |       0 |       0 |                                                     
  db-pool.js                     |       0 |        0 |       0 |       0 | 17-279                                              
  migrate-auth-pg.js             |       0 |        0 |       0 |       0 | 12-124                                              
  migrate-pg.js                  |       0 |        0 |       0 |       0 | 12-210                                              
  migrate.js                     |       0 |        0 |       0 |       0 | 13-467                                              
  pool-monitor.js                |       0 |        0 |       0 |       0 | 18-271                                              
 api-backend/database/migrations |       0 |        0 |       0 |       0 |                                                     
  run-migration.js               |       0 |        0 |       0 |       0 | 21-279                                              
 api-backend/database/seeds      |       0 |        0 |       0 |       0 |                                                     
  run-seed.js                    |       0 |        0 |       0 |       0 | 22-208                                              
 api-backend/middleware          |       0 |        0 |       0 |       0 |                                                     
  activity-logging.js            |       0 |        0 |       0 |       0 | 19-221                                              
  admin-auth.js                  |       0 |        0 |       0 |       0 | 15-227                                              
  admin-metrics.js               |       0 |        0 |       0 |       0 | 25-453                                              
  admin-rate-limiter.js          |       0 |        0 |       0 |       0 | 23-247                                              
  api-key-auth.js                |       0 |        0 |       0 |       0 | 23-227                                              
  auth-audit-middleware.js       |       0 |        0 |       0 |       0 | 30-404                                              
  auth.js                        |       0 |        0 |       0 |       0 | 16-573                                              
  connection-security.js         |       0 |        0 |       0 |       0 | 12-763                                              
  cors-config.js                 |       0 |        0 |       0 |       0 | 18-228                                              
  graceful-shutdown.js           |       0 |        0 |       0 |       0 | 23-199                                              
  https-enforcer.js              |       0 |        0 |       0 |       0 | 19-219                                              
  input-sanitizer.js             |       0 |        0 |       0 |       0 | 21-340                                              
  jwt-validator.js               |       0 |        0 |       0 |       0 | 17-684                                              
  pipeline.js                    |       0 |        0 |       0 |       0 | 58-189                                              
  rate-limiter.js                |       0 |        0 |       0 |       0 | 15-528                                              
  rbac.js                        |       0 |        0 |       0 |       0 | 18-438                                              
  request-logging.js             |       0 |        0 |       0 |       0 | 19-72                                               
  request-queuing.js             |       0 |        0 |       0 |       0 | 20-229                                              
  request-timeout.js             |       0 |        0 |       0 |       0 | 19-61                                               
  request-validation.js          |       0 |        0 |       0 |       0 | 18-109                                              
  security-audit-logger.js       |       0 |        0 |       0 |       0 | 13-798                                              
  tier-check.js                  |       0 |        0 |       0 |       0 | 17-451                                              
 api-backend/routes              |       0 |        0 |       0 |       0 |                                                     
  admin-metrics.js               |       0 |      100 |       0 |       0 | 15-34                                               
  admin.js                       |       0 |        0 |       0 |       0 | 40-399                                              
  api-keys.js                    |       0 |        0 |       0 |       0 | 26-427                                              
  auth-audit.js                  |       0 |        0 |       0 |       0 | 25-429                                              
  auth.js                        |       0 |        0 |       0 |       0 | 17-476                                              
  bridge-polling-routes.js       |       0 |        0 |       0 |       0 | 13-504                                              
  client-logs.js                 |       0 |        0 |       0 |       0 | 5-43                                                
  conversations.js               |       0 |        0 |       0 |       0 | 15-474                                              
  db-health.js                   |       0 |        0 |       0 |       0 | 18-114                                              
  direct-proxy-routes.js         |       0 |        0 |       0 |       0 | 24-477                                              
  monitoring.js                  |       0 |        0 |       0 |       0 | 14-414                                              
  proxy-config.js                |       0 |        0 |       0 |       0 | 6-667                                               
  proxy-diagnostics.js           |       0 |        0 |       0 |       0 | 6-426                                               
  proxy-failover.js              |       0 |        0 |       0 |       0 | 13-438                                              
  proxy-health.js                |       0 |        0 |       0 |       0 | 6-349                                               
  proxy-metrics.js               |       0 |        0 |       0 |       0 | 6-301                                               
  proxy-scaling.js               |       0 |        0 |       0 |       0 | 6-520                                               
  proxy-usage.js                 |       0 |        0 |       0 |       0 | 6-469                                               
  proxy-webhooks.js              |       0 |        0 |       0 |       0 | 28-566                                              
  sessions.js                    |       0 |        0 |       0 |       0 | 1-177                                               
  tunnel-failover.js             |       0 |        0 |       0 |       0 | 27-461                                              
  tunnel-health.js               |       0 |        0 |       0 |       0 | 25-516                                              
  tunnel-sharing.js              |       0 |        0 |       0 |       0 | 25-769                                              
  tunnel-usage.js                |       0 |        0 |       0 |       0 | 26-417                                              
  tunnel-webhooks.js             |       0 |        0 |       0 |       0 | 28-566                                              
  tunnels.js                     |       0 |        0 |       0 |       0 | 29-994                                              
  turn-credentials.js            |       0 |        0 |       0 |       0 | 14-66                                               
  user-activity.js               |       0 |        0 |       0 |       0 | 31-286                                              
  user-deletion.js               |       0 |        0 |       0 |       0 | 26-425                                              
  user-profile.js                |       0 |        0 |       0 |       0 | 28-482                                              
  users.js                       |       0 |        0 |       0 |       0 | 29-418                                              
  webhooks.js                    |       0 |        0 |       0 |       0 | 20-376                                              
 api-backend/routes/admin        |       0 |        0 |       0 |       0 |                                                     
  admins.js                      |       0 |        0 |       0 |       0 | 26-466                                              
  audit.js                       |       0 |        0 |       0 |       0 | 25-582                                              
  dashboard.js                   |       0 |        0 |       0 |       0 | 25-261                                              
  dns.js                         |       0 |        0 |       0 |       0 | 28-688                                              
  email.js                       |       0 |        0 |       0 |       0 | 33-1429                                             
  payments.js                    |       0 |        0 |       0 |       0 | 27-881                                              
  reports.js                     |       0 |        0 |       0 |       0 | 26-756                                              
  subscriptions.js               |       0 |        0 |       0 |       0 | 19-815                                              
  users.js                       |       0 |        0 |       0 |       0 | 27-949                                              
 api-backend/scripts             |       0 |        0 |       0 |       0 |                                                     
  test-auth-flow.js              |       0 |        0 |       0 |       0 | 12-202                                              
  test-database.js               |       0 |        0 |       0 |       0 | 12-148                                              
 api-backend/services            |    2.06 |     1.79 |    2.86 |    2.05 |                                                     
  alerting-service.js            |       0 |        0 |       0 |       0 | 23-292                                              
  api-key-service.js             |       0 |        0 |       0 |       0 | 16-473                                              
  auth-audit-service.js          |       0 |        0 |       0 |       0 | 20-566                                              
  cloudflare-dns-service.js      |       0 |        0 |       0 |       0 | 18-704                                              
  email-config-service.js        |       0 |        0 |       0 |       0 | 18-827                                              
  email-queue-service.js         |       0 |        0 |       0 |       0 | 19-747                                              
  google-workspace-service.js    |       0 |        0 |       0 |       0 | 20-697                                              
  health-check.js                |       0 |        0 |       0 |       0 | 10-174                                              
  index.js                       |       0 |        0 |       0 |       0 |                                                     
  payment-service.js             |       0 |        0 |       0 |       0 | 14-268                                              
  proxy-config-service.js        |       0 |        0 |       0 |       0 | 11-638                                              
  proxy-diagnostics-service.js   |       0 |        0 |       0 |       0 | 11-593                                              
  proxy-failover-service.js      |       0 |        0 |       0 |       0 | 11-842                                              
  proxy-health-service.js        |       0 |        0 |       0 |       0 | 10-403                                              
  proxy-metrics-service.js       |       0 |        0 |       0 |       0 | 23-418                                              
  proxy-scaling-service.js       |       0 |        0 |       0 |       0 | 11-791                                              
  proxy-usage-service.js         |       0 |        0 |       0 |       0 | 24-562                                              
  proxy-webhook-service.js       |       0 |        0 |       0 |       0 | 28-689                                              
  refund-service.js              |       0 |        0 |       0 |       0 | 15-355                                              
  request-queue-service.js       |   98.78 |    80.43 |     100 |   98.76 | 194                                                 
  stripe-client.js               |       0 |        0 |       0 |       0 | 13-169                                              
  subscription-service.js        |       0 |        0 |       0 |       0 | 14-600                                              
  tunnel-failover-service.js     |       0 |        0 |       0 |       0 | 25-584                                              
  tunnel-health-service.js       |       0 |        0 |       0 |       0 | 23-457                                              
  tunnel-service.js              |       0 |        0 |       0 |       0 | 27-765                                              
  tunnel-sharing-service.js      |       0 |        0 |       0 |       0 | 25-646                                              
  tunnel-usage-service.js        |       0 |        0 |       0 |       0 | 25-563                                              
  tunnel-webhook-service.js      |       0 |        0 |       0 |       0 | 28-689                                              
  user-activity-service.js       |       0 |        0 |       0 |       0 | 19-557                                              
  user-deletion-service.js       |       0 |        0 |       0 |       0 | 31-439                                              
  user-profile-service.js        |       0 |        0 |       0 |       0 | 35-426                                              
 api-backend/tunnel              |       0 |        0 |       0 |       0 |                                                     
  ssh-auth-handler.js            |       0 |        0 |       0 |       0 | 15-210                                              
  ssh-proxy.js                   |       0 |        0 |       0 |       0 | 18-594                                              
  tunnel-routes.js               |       0 |        0 |       0 |       0 | 31-245                                              
 api-backend/utils               |       0 |        0 |       0 |       0 |                                                     
  audit-logger.js                |       0 |        0 |       0 |       0 | 37-322                                              
  input-validation.js            |       0 |        0 |       0 |       0 | 30-530                                              
  logger.js                      |       0 |        0 |       0 |       0 | 13-393                                              
  tunnel-config-validation.js    |       0 |        0 |       0 |       0 | 25-107                                              
---------------------------------|---------|----------|---------|---------|-----------------------------------------------------
Jest: "global" coverage threshold for statements (70%) not met: 0.78%
Jest: "global" coverage threshold for branches (70%) not met: 0.68%
Jest: "global" coverage threshold for lines (70%) not met: 0.78%
Jest: "global" coverage threshold for functions (70%) not met: 0.88%
Test Suites: 1 failed, 1 total
Tests:       1 failed, 30 passed, 31 total
Snapshots:   0 total
Time:        2.025 s
Ran all test suites matching /test\\api-backend\\request-queuing.test.js/i.
∩┐╜ Cleaning up global test environment...
 Global test cleanup completed
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
