
> cloudtolocalllm-api-backend@1.0.0 test
> node --experimental-vm-modules ./node_modules/jest/bin/jest.js

 Setting up global test environment...
 Global test setup completed
(node:19836) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:33332) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:27988) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:36500) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:36048) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:36388) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:37152) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL ../../test/api-backend/tunnel-health-tracking.test.js
  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Tunnel Status Tracking ΓÇ║ should track tunnel status changes

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Tunnel Status Tracking ΓÇ║ should reject invalid tunnel status

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Endpoint Health Checking ΓÇ║ should get endpoint health status

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Endpoint Health Checking ΓÇ║ should update endpoint health status

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Metrics Collection and Aggregation ΓÇ║ should record request metrics

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Metrics Collection and Aggregation ΓÇ║ should flush metrics to database

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Metrics Collection and Aggregation ΓÇ║ should calculate success rate correctly

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Metrics Collection and Aggregation ΓÇ║ should handle empty metrics

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Tunnel Status Summary ΓÇ║ should get tunnel status summary

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Tunnel Status Summary ΓÇ║ should include endpoint details in status summary

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Health Check Lifecycle ΓÇ║ should start and stop health checks

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Health Check Lifecycle ΓÇ║ should not start duplicate health checks

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)


  ΓùÅ Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'cleanup')

      57 |
      58 |   afterAll(async () => {
    > 59 |     tunnelHealthService.cleanup();
         |                         ^
      60 |     if (pool) {
      61 |       await pool.end();
      62 |     }

      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:59:25)

FAIL ../../test/api-backend/user-activity.test.js
  ΓùÅ User Activity Tracking Service ΓÇ║ logUserActivity ΓÇ║ should log user activity successfully

    TypeError: Cannot read properties of null (reading 'id')

      131 |
      132 |       expect(result).toBeDefined();
    > 133 |       expect(result.id).toBeDefined();
          |                     ^
      134 |       expect(result.created_at).toBeDefined();
      135 |     });
      136 |

      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:133:21)

  ΓùÅ User Activity Tracking Service ΓÇ║ updateUserUsageMetrics ΓÇ║ should create new metrics record for new user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at updateUserUsageMetrics (services/user-activity-service.js:165:28)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:172:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ updateUserUsageMetrics ΓÇ║ should update existing metrics record

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at updateUserUsageMetrics (services/user-activity-service.js:165:28)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:184:7)

  ΓùÅ User Activity Tracking Service ΓÇ║ getUserActivityLogs ΓÇ║ should retrieve user activity logs successfully

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getUserActivityLogs (services/user-activity-service.js:267:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:216:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getUserActivityLogs ΓÇ║ should filter logs by action

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getUserActivityLogs (services/user-activity-service.js:267:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:226:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getUserActivityLogsCount ΓÇ║ should return count of user activity logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getUserActivityLogsCount (services/user-activity-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:242:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getUserUsageMetrics ΓÇ║ should retrieve user usage metrics successfully

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at updateUserUsageMetrics (services/user-activity-service.js:165:28)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:256:7)

  ΓùÅ User Activity Tracking Service ΓÇ║ getUserUsageMetrics ΓÇ║ should return null when no metrics found

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getUserUsageMetrics (services/user-activity-service.js:353:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:268:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getUserActivitySummary ΓÇ║ should retrieve user activity summary successfully

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getUserActivitySummary (services/user-activity-service.js:421:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:282:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getAllUserActivityLogs ΓÇ║ should retrieve all user activity logs for admin

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAllUserActivityLogs (services/user-activity-service.js:494:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:301:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getAllUserActivityLogs ΓÇ║ should filter logs by action

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAllUserActivityLogs (services/user-activity-service.js:494:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:310:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getAllUserActivityLogsCount ΓÇ║ should return count of all user activity logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAllUserActivityLogsCount (services/user-activity-service.js:550:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:322:22)

(node:32008) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL ../../test/api-backend/admin-data-flush.test.js
  ΓùÅ AdminDataFlushService ΓÇ║ Container and Network Clearing ΓÇ║ should clear containers and networks for specific user

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"all": true, "filters": {"label": ["cloudtolocalllm.type"]}}

    Number of calls: 0

      195 |       expect(result).toHaveProperty('volumes');
      196 |
    > 197 |       expect(mockDocker.listContainers).toHaveBeenCalledWith({
          |                                         ^
      198 |         all: true,
      199 |         filters: { label: ['cloudtolocalllm.type'] },
      200 |       });

      at Object.<anonymous> (../../test/api-backend/admin-data-flush.test.js:197:41)

  ΓùÅ AdminDataFlushService ΓÇ║ Container and Network Clearing ΓÇ║ should clear all containers and networks when no user specified

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      216 |
      217 |       // Should process all containers
    > 218 |       expect(result.containers).toBe(2);
          |                                 ^
      219 |       expect(result.networks).toBe(1);
      220 |     });
      221 |

      at Object.<anonymous> (../../test/api-backend/admin-data-flush.test.js:218:33)

  ΓùÅ AdminDataFlushService ΓÇ║ System Statistics ΓÇ║ should return system statistics

    expect(received).toHaveProperty(path, value)

    Expected path: "totalContainers"

    Expected value: 3
    Received value: 0

      376 |       const stats = await adminService.getSystemStatistics();
      377 |
    > 378 |       expect(stats).toHaveProperty('totalContainers', 3);
          |                     ^
      379 |       expect(stats).toHaveProperty('userContainers', 2);
      380 |       expect(stats).toHaveProperty('userNetworks', 2);
      381 |       expect(stats).toHaveProperty('activeUsers', 2);

      at Object.<anonymous> (../../test/api-backend/admin-data-flush.test.js:378:21)

  ΓùÅ AdminDataFlushService ΓÇ║ System Statistics ΓÇ║ should handle Docker API errors in statistics

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"activeUsers": 0, "lastFlushOperation": null, "totalContainers": 0, "userContainers": 0, "userNetworks": 0}

      386 |       mockDocker.listContainers.mockRejectedValue(new Error('Docker API error'));
      387 |
    > 388 |       await expect(adminService.getSystemStatistics()).rejects.toThrow('Docker API error');
          |             ^
      389 |     });
      390 |   });
      391 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (../../test/api-backend/admin-data-flush.test.js:388:13)

  ΓùÅ AdminDataFlushService ΓÇ║ Operation Status and History ΓÇ║ should return flush history with correct limit

    expect(received).toBe(expected) // Object.is equality

    Expected: "op-9"
    Received: "op-5"

      435 |
      436 |       // Should return most recent operations first
    > 437 |       expect(history[0].operationId).toBe('op-9');
          |                                      ^
      438 |       expect(history[4].operationId).toBe('op-5');
      439 |     });
      440 |   });

      at Object.<anonymous> (../../test/api-backend/admin-data-flush.test.js:437:38)

  ΓùÅ AdminDataFlushService ΓÇ║ Error Handling and Edge Cases ΓÇ║ should handle missing Docker daemon gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"containers": 0, "networks": 0, "volumes": 0}

      444 |       mockDocker.listContainers.mockRejectedValue(new Error('Docker daemon not running'));
      445 |
    > 446 |       await expect(
          |             ^
      447 |         adminService.clearUserContainersAndNetworks('user123'),
      448 |       ).rejects.toThrow('Docker daemon not running');
      449 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (../../test/api-backend/admin-data-flush.test.js:446:13)

(node:39712) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL ../../test/api-backend/webhook-rate-limiting.test.js
  ΓùÅ WebhookRateLimiterService ΓÇ║ getWebhookRateLimitConfig ΓÇ║ should return default config when no config exists

    AggregateError:

      101 |   async getWebhookRateLimitConfig(webhookId, userId) {
      102 |     try {
    > 103 |       const client = await this.pool.connect();
          |                      ^
      104 |       try {
      105 |         const result = await client.query(
      106 |           `SELECT 

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.getWebhookRateLimitConfig (services/webhook-rate-limiter.js:103:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:49:22)

  ΓùÅ WebhookRateLimiterService ΓÇ║ setWebhookRateLimitConfig ΓÇ║ should create new rate limit config

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:71:22)

  ΓùÅ WebhookRateLimiterService ΓÇ║ setWebhookRateLimitConfig ΓÇ║ should update existing rate limit config

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:91:7)

  ΓùÅ WebhookRateLimiterService ΓÇ║ setWebhookRateLimitConfig ΓÇ║ should invalidate cache after update

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:128:7)

  ΓùÅ WebhookRateLimiterService ΓÇ║ checkRateLimit ΓÇ║ should allow request when under limit

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:148:7)

  ΓùÅ WebhookRateLimiterService ΓÇ║ checkRateLimit ΓÇ║ should block request when minute limit exceeded

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:173:7)

  ΓùÅ WebhookRateLimiterService ΓÇ║ checkRateLimit ΓÇ║ should block request when hour limit exceeded

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:200:7)

  ΓùÅ WebhookRateLimiterService ΓÇ║ checkRateLimit ΓÇ║ should allow request when rate limiting disabled

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:227:7)

  ΓùÅ WebhookRateLimiterService ΓÇ║ getRateLimitStats ΓÇ║ should return stats for webhook

    AggregateError:

      355 |   async getRateLimitStats(webhookId, userId) {
      356 |     try {
    > 357 |       const client = await this.pool.connect();
          |                      ^
      358 |       try {
      359 |         const result = await client.query(
      360 |           `SELECT 

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.getRateLimitStats (services/webhook-rate-limiter.js:357:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:305:21)

(node:36392) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:29176) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:37296) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:19584) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:19544) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL ../../test/api-backend/tunnel-properties.test.js
  ΓùÅ Tunnel Lifecycle Property-Based Tests ΓÇ║ should maintain consistent tunnel state transitions

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-properties.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Property-Based Tests ΓÇ║ should maintain retrievable tunnel status after transitions

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-properties.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Property-Based Tests ΓÇ║ should maintain consistent metrics across tunnel states

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-properties.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Property-Based Tests ΓÇ║ should always create tunnels with created status

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-properties.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Property-Based Tests ΓÇ║ should handle idempotent status updates

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-properties.test.js:34:5)

FAIL ../../test/api-backend/error-notifications.test.js
  ΓùÅ ErrorNotificationService ΓÇ║ Error Detection and Categorization ΓÇ║ should categorize resource errors correctly

    TypeError: Cannot read properties of undefined (reading 'category')

      67 |       const result = await service.detectAndNotify(error);
      68 |
    > 69 |       expect(result.notification.category).toBe(ErrorCategory.RESOURCE);
         |                                  ^
      70 |     });
      71 |
      72 |     it('should categorize system errors correctly', async () => {

      at Object.<anonymous> (../../test/api-backend/error-notifications.test.js:69:34)

  ΓùÅ ErrorNotificationService ΓÇ║ Notification Cooldown ΓÇ║ should respect cooldown period between notifications

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      196 |       // Second notification within cooldown should not be sent
      197 |       const result2 = await service.detectAndNotify(error);
    > 198 |       expect(result2.notificationSent).toBe(false);
          |                                        ^
      199 |
      200 |       // Wait for cooldown to expire
      201 |       await new Promise(resolve => setTimeout(resolve, 1100));

      at Object.<anonymous> (../../test/api-backend/error-notifications.test.js:198:40)

  ΓùÅ ErrorNotificationService ΓÇ║ Error Count Threshold ΓÇ║ should send notification when error count exceeds threshold

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      231 |       // First error - below threshold
      232 |       const result1 = await service.detectAndNotify(error);
    > 233 |       expect(result1.notificationSent).toBe(false);
          |                                        ^
      234 |
      235 |       // Second error - below threshold
      236 |       const result2 = await service.detectAndNotify(error);

      at Object.<anonymous> (../../test/api-backend/error-notifications.test.js:233:40)

  ΓùÅ ErrorNotificationService ΓÇ║ Error Statistics ΓÇ║ should reset error counts

    expect(received).toBe(expected) // Object.is equality

    Expected: 0
    Received: 1

      339 |       service.resetErrorCounts();
      340 |       stats = service.getErrorStatistics();
    > 341 |       expect(stats.totalErrors).toBe(0);
          |                                 ^
      342 |     });
      343 |   });
      344 |

      at Object.<anonymous> (../../test/api-backend/error-notifications.test.js:341:33)

FAIL ../../test/api-backend/tunnel-usage.test.js
  ΓùÅ TunnelUsageService ΓÇ║ recordUsageEvent ΓÇ║ should record a connection_start event

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ recordUsageEvent ΓÇ║ should record a data_transfer event

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ recordUsageEvent ΓÇ║ should record a connection_end event

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ recordUsageEvent ΓÇ║ should record an error event

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ recordUsageEvent ΓÇ║ should reject invalid event type

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getTunnelUsageMetrics ΓÇ║ should get tunnel usage metrics for a specific date

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getTunnelUsageMetrics ΓÇ║ should return zero metrics if no data exists

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getTunnelUsageMetrics ΓÇ║ should reject if tunnel not found

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getTunnelUsageMetrics ΓÇ║ should reject if user is not tunnel owner

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getTunnelUsageMetricsRange ΓÇ║ should get tunnel usage metrics for a date range

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getTunnelUsageMetricsRange ΓÇ║ should return empty array if no data in range

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ aggregateUserUsage ΓÇ║ should aggregate user usage for a period

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ aggregateUserUsage ΓÇ║ should handle user with no tunnels

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getUserUsageReport ΓÇ║ should get usage report grouped by day

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getUserUsageReport ΓÇ║ should get usage report grouped by tunnel

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getUserUsageReport ΓÇ║ should reject invalid groupBy parameter

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getUserUsageReport ΓÇ║ should require startDate and endDate

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getBillingSummary ΓÇ║ should calculate billing for free tier

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getBillingSummary ΓÇ║ should calculate billing for premium tier

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getBillingSummary ΓÇ║ should calculate billing for enterprise tier

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getUserUsageAggregation ΓÇ║ should get user usage aggregation

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getUserUsageAggregation ΓÇ║ should return zero aggregation if no data exists

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)


  ΓùÅ Test suite failed to run

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:58:5)

FAIL ../../test/api-backend/proxy-usage.test.js
  ΓùÅ Proxy Usage Tracking ΓÇ║ Record Usage Events ΓÇ║ should record a connection_start event

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Record Usage Events ΓÇ║ should record a data_transfer event

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Record Usage Events ΓÇ║ should record a connection_end event

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Record Usage Events ΓÇ║ should record an error event

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Record Usage Events ΓÇ║ should reject invalid event types

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Get Usage Metrics ΓÇ║ should get usage metrics for a specific date

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Get Usage Metrics ΓÇ║ should return zero metrics for non-existent date

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Get Usage Metrics ΓÇ║ should get usage metrics for a date range

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Get Usage Metrics ΓÇ║ should reject unauthorized access

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Aggregation ΓÇ║ should aggregate user usage for a period

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Aggregation ΓÇ║ should get user usage aggregation

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Aggregation ΓÇ║ should return zero aggregation for user with no proxies

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Reports ΓÇ║ should generate usage report grouped by day

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Reports ΓÇ║ should generate usage report grouped by proxy

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Reports ΓÇ║ should reject invalid groupBy parameter

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Reports ΓÇ║ should require startDate and endDate

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Billing Summary ΓÇ║ should calculate billing for free tier

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Billing Summary ΓÇ║ should calculate billing for premium tier

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Billing Summary ΓÇ║ should calculate billing for enterprise tier

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)


  ΓùÅ Test suite failed to run

    AggregateError:

      52 |   afterAll(async () => {
      53 |     // Cleanup
    > 54 |     await pool.query('DELETE FROM proxy_usage_events WHERE user_id = $1', [testUserId]);
         |     ^
      55 |     await pool.query('DELETE FROM proxy_usage_metrics WHERE user_id = $1', [testUserId]);
      56 |     await pool.query('DELETE FROM proxy_usage_aggregation WHERE user_id = $1', [testUserId]);
      57 |     await pool.query('DELETE FROM proxy_usage_summary WHERE user_id = $1', [testUserId]);

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:54:5)

FAIL ../../test/api-backend/tunnel-lifecycle.test.js
  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Creation ΓÇ║ should create a tunnel with valid data

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Creation ΓÇ║ should reject tunnel creation with empty name

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Creation ΓÇ║ should reject tunnel creation with duplicate name

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Creation ΓÇ║ should reject tunnel name exceeding 255 characters

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Retrieval ΓÇ║ should retrieve tunnel by ID

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Retrieval ΓÇ║ should reject retrieval of non-existent tunnel

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Retrieval ΓÇ║ should reject retrieval of tunnel owned by different user

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Listing ΓÇ║ should list tunnels for user

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Listing ΓÇ║ should support pagination

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Updates ΓÇ║ should update tunnel name

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Updates ΓÇ║ should update tunnel config

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Updates ΓÇ║ should update tunnel endpoints

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Status Management ΓÇ║ should update tunnel status to connecting

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Status Management ΓÇ║ should update tunnel status to connected

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Status Management ΓÇ║ should update tunnel status to disconnected

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Status Management ΓÇ║ should reject invalid status

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Deletion ΓÇ║ should delete tunnel

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Deletion ΓÇ║ should reject deletion of non-existent tunnel

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Metrics ΓÇ║ should retrieve tunnel metrics

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Metrics ΓÇ║ should update tunnel metrics

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Activity Logs ΓÇ║ should retrieve tunnel activity logs

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

FAIL ../../test/api-backend/tunnel-webhooks.test.js
  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Registration ΓÇ║ should register a webhook for tunnel events

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Registration ΓÇ║ should reject invalid webhook URL

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Registration ΓÇ║ should reject empty events array

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Registration ΓÇ║ should reject invalid event type

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Registration ΓÇ║ should reject non-existent tunnel

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Registration ΓÇ║ should allow registering webhook for all user tunnels

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Management ΓÇ║ should retrieve webhook by ID

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Management ΓÇ║ should reject unauthorized webhook access

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Management ΓÇ║ should list webhooks for user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Management ΓÇ║ should update webhook

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Management ΓÇ║ should deactivate webhook

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Management ΓÇ║ should delete webhook

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Events ΓÇ║ should trigger webhook event for tunnel status change

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Events ΓÇ║ should not trigger webhook for inactive webhooks

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Events ΓÇ║ should not trigger webhook for unsubscribed events

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Delivery ΓÇ║ should queue webhook delivery

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Delivery ΓÇ║ should get delivery status

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Delivery ΓÇ║ should get delivery history

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Signature Verification ΓÇ║ should generate valid webhook signature

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Retry Logic ΓÇ║ should schedule retry with exponential backoff

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Retry Logic ΓÇ║ should mark delivery as failed after max retries

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)


  ΓùÅ Test suite failed to run

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:60:5)

FAIL ../../test/api-backend/tunnel-sharing.test.js
  ΓùÅ Tunnel Sharing Service ΓÇ║ shareTunnel ΓÇ║ should share a tunnel with another user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ shareTunnel ΓÇ║ should not share tunnel with non-existent user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ shareTunnel ΓÇ║ should not share tunnel with self

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ shareTunnel ΓÇ║ should reject invalid permission

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ shareTunnel ΓÇ║ should not share tunnel not owned by user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ getTunnelShares ΓÇ║ should get all shares for a tunnel

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ getTunnelShares ΓÇ║ should not get shares for tunnel not owned by user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ revokeTunnelAccess ΓÇ║ should revoke tunnel access from a user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ revokeTunnelAccess ΓÇ║ should not revoke access for tunnel not owned by user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ createShareToken ΓÇ║ should create a share token

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ createShareToken ΓÇ║ should create token with max uses

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ createShareToken ΓÇ║ should reject invalid permission for token

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ getShareTokens ΓÇ║ should get all share tokens for a tunnel

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ revokeShareToken ΓÇ║ should revoke a share token

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ verifyTunnelAccess ΓÇ║ should verify owner has admin access

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ verifyTunnelAccess ΓÇ║ should verify shared user has read access

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ verifyTunnelAccess ΓÇ║ should deny access for user without permission

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ verifyTunnelAccess ΓÇ║ should deny write access when only read is granted

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ getSharedTunnels ΓÇ║ should get tunnels shared with a user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ getTunnelAccessLogs ΓÇ║ should get tunnel access logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ getTunnelAccessLogs ΓÇ║ should not get logs for tunnel not owned by user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ updateSharePermission ΓÇ║ should update share permission

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ updateSharePermission ΓÇ║ should reject invalid permission update

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)


  ΓùÅ Test suite failed to run

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:65:5)

FAIL ../../test/api-backend/query-cache.test.js
  ΓùÅ QueryCacheService ΓÇ║ invalidation ΓÇ║ should invalidate by table name

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      159 |       const count = cache.invalidateByTable('users');
      160 |
    > 161 |       expect(count).toBe(2);
          |                     ^
      162 |       expect(cache.get('table:users:1')).toBeNull();
      163 |       expect(cache.get('table:users:2')).toBeNull();
      164 |       expect(cache.get('table:posts:1')).not.toBeNull();

      at Object.<anonymous> (../../test/api-backend/query-cache.test.js:161:21)

(node:33984) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL ../../test/api-backend/request-queuing.test.js
  ΓùÅ RequestQueueService ΓÇ║ Queue timeout ΓÇ║ should timeout queued request after specified duration

    Queue cleared

      252 |           clearTimeout(entry.timeoutId);
      253 |         }
    > 254 |         entry.reject(new Error('Queue cleared'));
          |                      ^
      255 |       }
      256 |     }
      257 |     this.userQueues.clear();

      at RequestQueueService.clearAllQueues (services/request-queue-service.js:254:22)
      at Object.<anonymous> (../../test/api-backend/request-queuing.test.js:262:25)

  ΓùÅ RequestQueueService ΓÇ║ Queue timeout ΓÇ║ should timeout queued request after specified duration

    Queue cleared

      252 |           clearTimeout(entry.timeoutId);
      253 |         }
    > 254 |         entry.reject(new Error('Queue cleared'));
          |                      ^
      255 |       }
      256 |     }
      257 |     this.userQueues.clear();

      at RequestQueueService.clearAllQueues (services/request-queue-service.js:254:22)
      at Object.<anonymous> (../../test/api-backend/request-queuing.test.js:262:25)

  ΓùÅ RequestQueueService ΓÇ║ Queue timeout ΓÇ║ should timeout queued request after specified duration

    Queue cleared

      263 |           clearTimeout(entry.timeoutId);
      264 |         }
    > 265 |         entry.reject(new Error('Queue cleared'));
          |                      ^
      266 |       }
      267 |     }
      268 |     this.ipQueues.clear();

      at RequestQueueService.clearAllQueues (services/request-queue-service.js:265:22)
      at Object.<anonymous> (../../test/api-backend/request-queuing.test.js:262:25)

(node:40644) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:3096) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS ../../test/api-backend/security/authentication-authorization.test.js
FAIL ../../test/api-backend/auth-audit.test.js
  ΓùÅ Authentication Audit Logging Service ΓÇ║ logAuthEvent ΓÇ║ should log authentication event with all details

    TypeError: Cannot read properties of null (reading 'id')

      77 |
      78 |       expect(result).toBeDefined();
    > 79 |       expect(result.id).toBeDefined();
         |                     ^
      80 |       expect(result.created_at).toBeDefined();
      81 |     });
      82 |

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:79:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logAuthEvent ΓÇ║ should log failed authentication event

    TypeError: Cannot read properties of null (reading 'id')

      93 |
      94 |       expect(result).toBeDefined();
    > 95 |       expect(result.id).toBeDefined();
         |                     ^
      96 |     });
      97 |
      98 |     it('should throw error if eventType is missing', async () => {

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:95:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logLoginSuccess ΓÇ║ should log successful login

    TypeError: Cannot read properties of null (reading 'id')

      127 |
      128 |       expect(result).toBeDefined();
    > 129 |       expect(result.id).toBeDefined();
          |                     ^
      130 |     });
      131 |   });
      132 |

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:129:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logLoginFailure ΓÇ║ should log failed login attempt

    TypeError: Cannot read properties of null (reading 'id')

      142 |
      143 |       expect(result).toBeDefined();
    > 144 |       expect(result.id).toBeDefined();
          |                     ^
      145 |     });
      146 |
      147 |     it('should log failed login without user ID', async () => {

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:144:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logLoginFailure ΓÇ║ should log failed login without user ID

    TypeError: Cannot read properties of null (reading 'id')

      154 |
      155 |       expect(result).toBeDefined();
    > 156 |       expect(result.id).toBeDefined();
          |                     ^
      157 |     });
      158 |   });
      159 |

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:156:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logLogout ΓÇ║ should log logout event

    TypeError: Cannot read properties of null (reading 'id')

      167 |
      168 |       expect(result).toBeDefined();
    > 169 |       expect(result.id).toBeDefined();
          |                     ^
      170 |     });
      171 |   });
      172 |

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:169:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logTokenRefresh ΓÇ║ should log token refresh event

    TypeError: Cannot read properties of null (reading 'id')

      181 |
      182 |       expect(result).toBeDefined();
    > 183 |       expect(result.id).toBeDefined();
          |                     ^
      184 |     });
      185 |   });
      186 |

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:183:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logTokenRevoke ΓÇ║ should log token revocation event

    TypeError: Cannot read properties of null (reading 'id')

      195 |
      196 |       expect(result).toBeDefined();
    > 197 |       expect(result.id).toBeDefined();
          |                     ^
      198 |     });
      199 |   });
      200 |

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:197:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogs ΓÇ║ should retrieve audit logs for user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:219:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogs ΓÇ║ should filter audit logs by event type

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:226:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogs ΓÇ║ should support pagination

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:237:25)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogs ΓÇ║ should return empty array for non-existent user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:252:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogsCount ΓÇ║ should count audit logs for user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogsCount (services/auth-audit-service.js:378:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:260:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogsCount ΓÇ║ should count filtered audit logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogsCount (services/auth-audit-service.js:378:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:267:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getFailedLoginAttempts ΓÇ║ should retrieve failed login attempts for user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getFailedLoginAttempts (services/auth-audit-service.js:434:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:288:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getFailedLoginAttempts ΓÇ║ should retrieve all failed login attempts

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getFailedLoginAttempts (services/auth-audit-service.js:434:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:297:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getFailedLoginAttempts ΓÇ║ should support pagination for failed attempts

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getFailedLoginAttempts (services/auth-audit-service.js:434:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:303:25)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogsForAdmin ΓÇ║ should retrieve all audit logs for admin

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogsForAdmin (services/auth-audit-service.js:505:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:314:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogsForAdmin ΓÇ║ should filter audit logs by event type for admin

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogsForAdmin (services/auth-audit-service.js:505:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:320:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogsForAdmin ΓÇ║ should filter audit logs by severity for admin

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogsForAdmin (services/auth-audit-service.js:505:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:331:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogsForAdmin ΓÇ║ should support pagination for admin

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogsForAdmin (services/auth-audit-service.js:505:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:342:25)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ Property Tests ΓÇ║ should preserve all audit log details on round trip

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:376:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ Property Tests ΓÇ║ should consistently log correct event types

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:413:22)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ Property Tests ΓÇ║ should preserve IP address and user agent exactly

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:439:20)

(node:39612) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL ../../test/api-backend/error-notifications-integration.test.js
  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should reset error counts

    TypeError: mime.getType is not a function

      139 |       response = await request(app)
      140 |         .post('/api/reset')
    > 141 |         .send({ type: 'counts' });
          |          ^
      142 |
      143 |       expect(response.status).toBe(200);
      144 |       expect(response.body.success).toBe(true);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:141:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should reset error history

    TypeError: mime.getType is not a function

      156 |       response = await request(app)
      157 |         .post('/api/reset')
    > 158 |         .send({ type: 'history' });
          |          ^
      159 |
      160 |       expect(response.status).toBe(200);
      161 |

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:158:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should reset metrics

    TypeError: mime.getType is not a function

      172 |       response = await request(app)
      173 |         .post('/api/reset')
    > 174 |         .send({ type: 'metrics' });
          |          ^
      175 |
      176 |       expect(response.status).toBe(200);
      177 |

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:174:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should reset all data

    TypeError: mime.getType is not a function

      185 |       const response = await request(app)
      186 |         .post('/api/reset')
    > 187 |         .send({ type: 'all' });
          |          ^
      188 |
      189 |       expect(response.status).toBe(200);
      190 |

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:187:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should reject invalid reset type

    TypeError: mime.getType is not a function

      199 |       const response = await request(app)
      200 |         .post('/api/reset')
    > 201 |         .send({ type: 'invalid' });
          |          ^
      202 |
      203 |       expect(response.status).toBe(400);
      204 |       expect(response.body.error).toBeDefined();

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:201:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should send manual error notification

    TypeError: mime.getType is not a function

      208 |       const response = await request(app)
      209 |         .post('/api/manual-notification')
    > 210 |         .send({
          |          ^
      211 |           message: 'Test error notification',
      212 |           category: 'database',
      213 |           severity: 'critical',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:210:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should reject manual notification without message

    TypeError: mime.getType is not a function

      222 |       const response = await request(app)
      223 |         .post('/api/manual-notification')
    > 224 |         .send({});
          |          ^
      225 |
      226 |       expect(response.status).toBe(400);
      227 |       expect(response.body.error).toBeDefined();

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:224:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ withErrorNotification Wrapper ΓÇ║ should include request context in wrapped handler errors

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-id"
    Received: "unknown"

      328 |       const history = errorNotificationService.getErrorHistory();
      329 |       expect(history.length).toBeGreaterThan(0);
    > 330 |       expect(history[0].context.correlationId).toBe('test-id');
          |                                                ^
      331 |     });
      332 |   });
      333 |

      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:330:48)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Queue ΓÇ║ should not exceed maximum queue size

    ReferenceError: require is not defined

      385 |
      386 |     it('should not exceed maximum queue size', async () => {
    > 387 |       const service = new (require('../../services/api-backend/services/error-notification-service.js').ErrorNotificationService)({
          |                       ^
      388 |         maxNotificationQueueSize: 5,
      389 |       });
      390 |

      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:387:23)

(node:28020) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS ../../test/api-backend/retry-middleware-simple.test.js
PASS ../../test/api-backend/error-recovery.test.js
PASS ../../test/api-backend/log-routing-integration.test.js
PASS ../../test/api-backend/circuit-breaker-integration.test.js
PASS ../../test/api-backend/graceful-degradation-integration.test.js
PASS ../../test/api-backend/database-performance-integration.test.js
FAIL ../../test/api-backend/api-keys.test.js
  ΓùÅ API Key Service ΓÇ║ generateApiKey ΓÇ║ should generate a valid API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ generateApiKey ΓÇ║ should set expiration date when expiresIn is provided

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ generateApiKey ΓÇ║ should create audit log entry

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should validate a valid API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should validate a valid API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:93:22)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for invalid API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for invalid API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:93:22)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for key without prefix

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for key without prefix

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:93:22)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should update last_used_at on validation

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should update last_used_at on validation

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:93:22)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for expired API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for expired API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:93:22)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for inactive API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for inactive API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:93:22)

  ΓùÅ API Key Service ΓÇ║ listApiKeys ΓÇ║ should list all API keys for a user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ listApiKeys ΓÇ║ should not include actual API keys in list

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKey ΓÇ║ should get API key details

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKey ΓÇ║ should get API key details

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:189:22)

  ΓùÅ API Key Service ΓÇ║ getApiKey ΓÇ║ should return null for non-existent key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKey ΓÇ║ should return null for non-existent key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:189:22)

  ΓùÅ API Key Service ΓÇ║ getApiKey ΓÇ║ should return null for unauthorized user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKey ΓÇ║ should return null for unauthorized user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:189:22)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key name

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key name

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:220:22)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key description

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key description

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:220:22)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key scopes

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key scopes

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:220:22)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key rate limit

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key rate limit

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:220:22)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should not allow updating key_hash

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should not allow updating key_hash

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:220:22)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should generate a new API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should generate a new API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:276:22)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should preserve key metadata during rotation

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should preserve key metadata during rotation

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:276:22)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should revoke the old key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should revoke the old key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:276:22)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should create audit log entries

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should create audit log entries

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:276:22)

  ΓùÅ API Key Service ΓÇ║ revokeApiKey ΓÇ║ should revoke an API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ revokeApiKey ΓÇ║ should revoke an API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:318:22)

  ΓùÅ API Key Service ΓÇ║ revokeApiKey ΓÇ║ should make revoked key invalid

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ revokeApiKey ΓÇ║ should make revoked key invalid

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:318:22)

  ΓùÅ API Key Service ΓÇ║ revokeApiKey ΓÇ║ should create audit log entry

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ revokeApiKey ΓÇ║ should create audit log entry

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:318:22)

  ΓùÅ API Key Service ΓÇ║ getApiKeyAuditLogs ΓÇ║ should retrieve audit logs for an API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKeyAuditLogs ΓÇ║ should retrieve audit logs for an API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:347:22)

  ΓùÅ API Key Service ΓÇ║ getApiKeyAuditLogs ΓÇ║ should include creation event in audit logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKeyAuditLogs ΓÇ║ should include creation event in audit logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:347:22)

  ΓùÅ API Key Service ΓÇ║ getApiKeyAuditLogs ΓÇ║ should return empty array for non-existent key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKeyAuditLogs ΓÇ║ should return empty array for non-existent key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:347:22)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys ΓÇ║ should create a new API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys ΓÇ║ should reject request without name

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys ΓÇ║ should reject invalid scopes

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys ΓÇ║ should reject invalid rate limit

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys ΓÇ║ should list all API keys

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys ΓÇ║ should list all API keys

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:459:7)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys ΓÇ║ should not include actual API keys

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys ΓÇ║ should not include actual API keys

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:459:7)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys/:keyId ΓÇ║ should get API key details

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys/:keyId ΓÇ║ should get API key details

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:485:22)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys/:keyId ΓÇ║ should return 404 for non-existent key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys/:keyId ΓÇ║ should return 404 for non-existent key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:485:22)

  ΓùÅ API Key Routes ΓÇ║ PATCH /api-keys/:keyId ΓÇ║ should update API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ PATCH /api-keys/:keyId ΓÇ║ should update API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:509:22)

  ΓùÅ API Key Routes ΓÇ║ PATCH /api-keys/:keyId ΓÇ║ should reject invalid fields

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ PATCH /api-keys/:keyId ΓÇ║ should reject invalid fields

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:509:22)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys/:keyId/rotate ΓÇ║ should rotate API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys/:keyId/rotate ΓÇ║ should rotate API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:539:22)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys/:keyId/revoke ΓÇ║ should revoke API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys/:keyId/revoke ΓÇ║ should revoke API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:557:22)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys/:keyId/audit-logs ΓÇ║ should get audit logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys/:keyId/audit-logs ΓÇ║ should get audit logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:573:22)

  ΓùÅ API Key Middleware ΓÇ║ authenticateApiKey ΓÇ║ should authenticate with valid API key in Authorization header

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:599:24)

  ΓùÅ API Key Middleware ΓÇ║ authenticateApiKey ΓÇ║ should authenticate with valid API key in X-API-Key header

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:599:24)

  ΓùÅ API Key Middleware ΓÇ║ authenticateApiKey ΓÇ║ should reject request without API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:599:24)

  ΓùÅ API Key Middleware ΓÇ║ authenticateApiKey ΓÇ║ should reject invalid API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:599:24)

  ΓùÅ API Key Middleware ΓÇ║ authenticateApiKey ΓÇ║ should reject revoked API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:599:24)


  ΓùÅ Test suite failed to run

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:41:5)

  ΓùÅ Test suite failed to run

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:406:5)

  ΓùÅ Test suite failed to run

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:627:5)

PASS ../../test/api-backend/retry-service-simple.test.js
PASS ../../test/api-backend/log-aggregation.test.js
PASS ../../test/api-backend/circuit-breaker.test.js
PASS ../../test/api-backend/backup-recovery-integration.test.js
PASS ../../test/api-backend/prometheus-metrics.test.js
PASS ../../test/api-backend/cached-query-wrapper.test.js
PASS ../../test/api-backend/deprecation.test.js
PASS ../../test/api-backend/user-activity-unit.test.js
PASS ../../test/api-backend/proxy-diagnostics.test.js
PASS ../../test/api-backend/graceful-degradation.test.js
PASS ../../test/api-backend/alert-configuration.test.js
PASS ../../test/api-backend/metrics-consistency-properties.test.js
PASS ../../test/api-backend/alert-triggering.test.js
PASS ../../test/api-backend/user-profile.test.js
PASS ../../test/api-backend/rate-limit-exemptions.test.js
PASS ../../test/api-backend/sandbox-routes.test.js
PASS ../../test/api-backend/user-deletion.test.js
PASS ../../test/api-backend/bulk-operations.test.js
PASS ../../test/api-backend/api-versioning.test.js
PASS ../../test/api-backend/failover-manager.test.js
PASS ../../test/api-backend/tunnel-metrics-properties.test.js
PASS ../../test/api-backend/webhook-event-filters.test.js
PASS ../../test/api-backend/tunnel-failover.test.js
PASS ../../test/api-backend/webhook-payload-transformer.test.js
PASS ../../test/api-backend/read-replica-routing.test.js
PASS ../../test/api-backend/proxy-metrics.test.js
PASS ../../test/api-backend/rate-limit-metrics.test.js
PASS ../../test/api-backend/quota-management.test.js
PASS ../../test/api-backend/input-validation.test.js
PASS ../../test/api-backend/tier-validation.test.js
PASS ../../test/api-backend/webhook-testing.test.js
PASS ../../test/api-backend/proxy-scaling.test.js
PASS ../../test/api-backend/sandbox-service.test.js
PASS ../../test/api-backend/database-performance-tracking.test.js
PASS ../../test/api-backend/webhook-rate-limiting-unit.test.js
PASS ../../test/api-backend/backup-recovery.test.js
PASS ../../test/api-backend/auth-token-refresh.test.js
PASS ../../test/api-backend/health-check.test.js
PASS ../../test/api-backend/proxy-failover.test.js
PASS ../../test/api-backend/proxy-config.test.js
PASS ../../test/api-backend/webhook-testing-integration.test.js
PASS ../../test/api-backend/proxy-webhooks.test.js
PASS ../../test/api-backend/admin-users-search.test.js
PASS ../../test/api-backend/failover-integration.test.js
PASS ../../test/api-backend/rbac.test.js
PASS ../../test/api-backend/tunnel-config-management.test.js
PASS ../../test/api-backend/api-documentation-properties.test.js
PASS ../../test/api-backend/rate-limit-violations.test.js
PASS ../../test/api-backend/cache-metrics-routes.test.js
FAIL ../../test/api-backend/rate-limiting-properties.test.js
  ΓùÅ Test suite failed to run

    SyntaxError: The requested module '../../utils/globals.js' does not provide an export named 'safeNormalize'

      at Runtime.linkAndEvaluateModule (node_modules/jest-runtime/build/index.js:708:5)

FAIL ../../test/api-backend/proxy-health-properties.test.js
  ΓùÅ Test suite failed to run

    SyntaxError: The requested module '../../utils/globals.js' does not provide an export named 'safeNormalize'

      at Runtime.linkAndEvaluateModule (node_modules/jest-runtime/build/index.js:708:5)

FAIL ../../test/api-backend/database-transaction-properties.test.js
  ΓùÅ Test suite failed to run

    SyntaxError: The requested module '../../utils/globals.js' does not provide an export named 'safeNormalize'

      at Runtime.linkAndEvaluateModule (node_modules/jest-runtime/build/index.js:708:5)

FAIL ../../test/api-backend/bridge-polling-routes.test.js
  ΓùÅ Test suite failed to run

    ReferenceError: jest is not defined

      33 | import bridgePollingRoutes from '../../services/api-backend/routes/bridge-polling-routes.js';
      34 |
    > 35 | jest.mock('../../services/api-backend/middleware/tier-check.js', () => ({
         | ^
      36 |   addTierInfo: (req, res, next) => {
      37 |     req.userTier = 'free';
      38 |     next();

      at ../../test/api-backend/bridge-polling-routes.test.js:35:1

PASS ../../test/api-backend/proxy-health.test.js (5.61 s)
FAIL ../../test/api-backend/adaptive-rate-limiting.test.js (122.115 s)
  ΓùÅ Adaptive Rate Limiting ΓÇ║ SystemLoadMonitor ΓÇ║ should adjust adaptive multiplier based on load

    expect(received).toBeLessThan(expected)

    Expected: < 1
    Received:   1

      179 |
      180 |       // Should reduce multiplier under high load
    > 181 |       expect(monitor.adaptiveMultiplier).toBeLessThan(1.0);
          |                                          ^
      182 |
      183 |       done();
      184 |     });

      at Object.<anonymous> (../../test/api-backend/adaptive-rate-limiting.test.js:181:42)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ AdaptiveRateLimiter ΓÇ║ should enforce window rate limit

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      266 |       for (let i = 0; i < 100; i++) {
      267 |         const result = limiter.checkRateLimit('user1', `corr-${i}`, {});
    > 268 |         expect(result.allowed).toBe(true);
          |                                ^
      269 |       }
      270 |
      271 |       // Next request should be blocked

      at Object.<anonymous> (../../test/api-backend/adaptive-rate-limiting.test.js:268:32)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ AdaptiveRateLimiter ΓÇ║ should reduce limits under high load

    expect(received).toBeLessThan(expected)

    Expected: < 100
    Received:   100

      297 |
      298 |         // Limits should be reduced
    > 299 |         expect(limits.maxRequests).toBeLessThan(100);
          |                                    ^
      300 |         expect(limits.burstRequests).toBeLessThan(20);
      301 |         expect(limits.multiplier).toBeLessThan(1.0);
      302 |

      at Timeout._onTimeout (../../test/api-backend/adaptive-rate-limiting.test.js:299:36)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ AdaptiveRateLimiter ΓÇ║ should reduce limits under high load

    thrown: "Exceeded timeout of 30000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      286 |     });
      287 |
    > 288 |     it('should reduce limits under high load', (done) => {
          |     ^
      289 |       // Simulate high load
      290 |       limiter.systemLoadMonitor.currentMetrics.cpuUsage = 85;
      291 |       limiter.systemLoadMonitor.currentMetrics.memoryUsage = 80;

      at ../../test/api-backend/adaptive-rate-limiting.test.js:288:5
      at ../../test/api-backend/adaptive-rate-limiting.test.js:206:3
      at ../../test/api-backend/adaptive-rate-limiting.test.js:10:1

  ΓùÅ Adaptive Rate Limiting ΓÇ║ AdaptiveRateLimiter ΓÇ║ should track active requests

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      310 |
      311 |       const metrics = limiter.getSystemMetrics();
    > 312 |       expect(metrics.activeRequests).toBe(2);
          |                                      ^
      313 |     });
      314 |
      315 |     it('should complete requests', () => {

      at Object.<anonymous> (../../test/api-backend/adaptive-rate-limiting.test.js:312:38)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ AdaptiveRateLimiter ΓÇ║ should complete requests

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      320 |
      321 |       const metrics = limiter.getSystemMetrics();
    > 322 |       expect(metrics.activeRequests).toBe(1);
          |                                      ^
      323 |     });
      324 |
      325 |     it('should get system metrics', (done) => {

      at Object.<anonymous> (../../test/api-backend/adaptive-rate-limiting.test.js:322:38)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ Adaptive Rate Limiting Integration ΓÇ║ should adapt limits as system load changes

    expect(received).toBeLessThan(expected)

    Expected: < 100
    Received:   100

      438 |
      439 |         // Limits should be reduced
    > 440 |         expect(highLoadLimits.maxRequests).toBeLessThan(initialLimits.maxRequests);
          |                                            ^
      441 |         expect(highLoadLimits.multiplier).toBeLessThan(1.0);
      442 |
      443 |         done();

      at Timeout._onTimeout (../../test/api-backend/adaptive-rate-limiting.test.js:440:44)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ Adaptive Rate Limiting Integration ΓÇ║ should adapt limits as system load changes

    thrown: "Exceeded timeout of 30000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      424 |     });
      425 |
    > 426 |     it('should adapt limits as system load changes', (done) => {
          |     ^
      427 |       // Get initial limits
      428 |       const initialLimits = limiter.getAdaptiveLimits();
      429 |       expect(initialLimits.multiplier).toBe(1.0);

      at ../../test/api-backend/adaptive-rate-limiting.test.js:426:5
      at ../../test/api-backend/adaptive-rate-limiting.test.js:407:3
      at ../../test/api-backend/adaptive-rate-limiting.test.js:10:1

  ΓùÅ Adaptive Rate Limiting ΓÇ║ Adaptive Rate Limiting Integration ΓÇ║ should handle critical load scenario

    expect(received).toBe(expected) // Object.is equality

    Expected: 0.25
    Received: 1

      463 |
      464 |         // Should be at 25% of normal limits
    > 465 |         expect(limits.multiplier).toBe(0.25);
          |                                   ^
      466 |         expect(limits.maxRequests).toBe(25); // 100 * 0.25
      467 |
      468 |         done();

      at Timeout._onTimeout (../../test/api-backend/adaptive-rate-limiting.test.js:465:35)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ Adaptive Rate Limiting Integration ΓÇ║ should handle critical load scenario

    thrown: "Exceeded timeout of 30000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      453 |     });
      454 |
    > 455 |     it('should handle critical load scenario', (done) => {
          |     ^
      456 |       // Simulate critical load
      457 |       limiter.systemLoadMonitor.currentMetrics.cpuUsage = 95;
      458 |       limiter.systemLoadMonitor.currentMetrics.memoryUsage = 95;

      at ../../test/api-backend/adaptive-rate-limiting.test.js:455:5
      at ../../test/api-backend/adaptive-rate-limiting.test.js:407:3
      at ../../test/api-backend/adaptive-rate-limiting.test.js:10:1

  ΓùÅ Adaptive Rate Limiting ΓÇ║ Adaptive Rate Limiting Integration ΓÇ║ should handle recovery from high load

    expect(received).toBeLessThan(expected)

    Expected: < 1
    Received:   1

      478 |       setTimeout(() => {
      479 |         const highLoadLimits = limiter.getAdaptiveLimits();
    > 480 |         expect(highLoadLimits.multiplier).toBeLessThan(1.0);
          |                                           ^
      481 |
      482 |         // Simulate recovery
      483 |         limiter.systemLoadMonitor.currentMetrics.cpuUsage = 20;

      at Timeout._onTimeout (../../test/api-backend/adaptive-rate-limiting.test.js:480:43)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ Adaptive Rate Limiting Integration ΓÇ║ should handle recovery from high load

    thrown: "Exceeded timeout of 30000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      470 |     });
      471 |
    > 472 |     it('should handle recovery from high load', (done) => {
          |     ^
      473 |       // Simulate high load
      474 |       limiter.systemLoadMonitor.currentMetrics.cpuUsage = 85;
      475 |       limiter.systemLoadMonitor.currentMetrics.memoryUsage = 80;

      at ../../test/api-backend/adaptive-rate-limiting.test.js:472:5
      at ../../test/api-backend/adaptive-rate-limiting.test.js:407:3
      at ../../test/api-backend/adaptive-rate-limiting.test.js:10:1

FAIL ../../test/api-backend/error-recovery-integration.test.js (315.291 s)
  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/status ΓÇ║ should return recovery statuses for all services

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

       96 |         .set('Authorization', `Bearer ${adminToken}`);
       97 |
    >  98 |       expect(response.status).toBe(200);
          |                               ^
       99 |       expect(response.body.status).toBe('success');
      100 |       expect(Array.isArray(response.body.data)).toBe(true);
      101 |       expect(response.body.data.length).toBeGreaterThan(0);

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:98:31)

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/status/:serviceName ΓÇ║ should return recovery status for specific service

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      130 |         .set('Authorization', `Bearer ${adminToken}`);
      131 |
    > 132 |       expect(response.status).toBe(200);
          |                               ^
      133 |       expect(response.body.status).toBe('success');
      134 |       expect(response.body.data.service).toBe('test-service');
      135 |       expect(response.body.data.description).toBe('Test recovery procedure');

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:132:31)

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/status/:serviceName ΓÇ║ should return unknown status for unregistered service

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      141 |         .set('Authorization', `Bearer ${adminToken}`);
      142 |
    > 143 |       expect(response.status).toBe(200);
          |                               ^
      144 |       expect(response.body.data.status).toBe('unknown');
      145 |     });
      146 |

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:143:31)

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/status/:serviceName ΓÇ║ should require service name parameter

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 401

      151 |
      152 |       // Express will not match this route
    > 153 |       expect(response.status).toBe(404);
          |                               ^
      154 |     });
      155 |   });
      156 |

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:153:31)

  ΓùÅ Error Recovery Endpoints ΓÇ║ POST /error-recovery/recover/:serviceName ΓÇ║ should execute recovery procedure successfully

    TypeError: mime.getType is not a function

      163 |         .post('/error-recovery/recover/test-service')
      164 |         .set('Authorization', `Bearer ${adminToken}`)
    > 165 |         .send({ reason: 'Manual intervention' });
          |          ^
      166 |
      167 |       expect(response.status).toBe(200);
      168 |       expect(response.body.status).toBe('success');

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:165:10)

  ΓùÅ Error Recovery Endpoints ΓÇ║ POST /error-recovery/recover/:serviceName ΓÇ║ should return 404 if no recovery procedure registered

    TypeError: mime.getType is not a function

      175 |         .post('/error-recovery/recover/unknown-service')
      176 |         .set('Authorization', `Bearer ${adminToken}`)
    > 177 |         .send({ reason: 'Test' });
          |          ^
      178 |
      179 |       expect(response.status).toBe(404);
      180 |       expect(response.body.status).toBe('error');

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:177:10)

  ΓùÅ Error Recovery Endpoints ΓÇ║ POST /error-recovery/recover/:serviceName ΓÇ║ should return 409 if recovery already in progress

    TypeError: mime.getType is not a function

      191 |         .post('/error-recovery/recover/test-service')
      192 |         .set('Authorization', `Bearer ${adminToken}`)
    > 193 |         .send({ reason: 'First' });
          |          ^
      194 |
      195 |       // Try to start second recovery immediately
      196 |       const promise2 = request(app)

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:193:10)

  ΓùÅ Error Recovery Endpoints ΓÇ║ POST /error-recovery/recover/:serviceName ΓÇ║ should require admin role

    TypeError: mime.getType is not a function

      209 |         .post('/error-recovery/recover/test-service')
      210 |         .set('Authorization', `Bearer ${userToken}`)
    > 211 |         .send({ reason: 'Test' });
          |          ^
      212 |
      213 |       expect(response.status).toBe(403);
      214 |     });

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:211:10)

  ΓùÅ Error Recovery Endpoints ΓÇ║ POST /error-recovery/recover/:serviceName ΓÇ║ should track recovery in history

    TypeError: mime.getType is not a function

      221 |         .post('/error-recovery/recover/test-service')
      222 |         .set('Authorization', `Bearer ${adminToken}`)
    > 223 |         .send({ reason: 'Test recovery' });
          |          ^
      224 |
      225 |       const history = errorRecoveryService.getRecoveryHistory();
      226 |       expect(history.length).toBe(1);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:223:10)

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/history ΓÇ║ should return recovery history

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      230 |
      231 |   describe('GET /error-recovery/history', () => {
    > 232 |     it('should return recovery history', async () => {
          |     ^
      233 |       const procedure = jest.fn().mockResolvedValue({});
      234 |       errorRecoveryService.registerRecoveryProcedure('test-service', { procedure });
      235 |

      at ../../test/api-backend/error-recovery-integration.test.js:232:5
      at ../../test/api-backend/error-recovery-integration.test.js:231:3
      at ../../test/api-backend/error-recovery-integration.test.js:73:1

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/history ΓÇ║ should filter history by service name

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      248 |     });
      249 |
    > 250 |     it('should filter history by service name', async () => {
          |     ^
      251 |       const procedure = jest.fn().mockResolvedValue({});
      252 |       errorRecoveryService.registerRecoveryProcedure('service-1', { procedure });
      253 |       errorRecoveryService.registerRecoveryProcedure('service-2', { procedure });

      at ../../test/api-backend/error-recovery-integration.test.js:250:5
      at ../../test/api-backend/error-recovery-integration.test.js:231:3
      at ../../test/api-backend/error-recovery-integration.test.js:73:1

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/history ΓÇ║ should filter history by status

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      270 |     });
      271 |
    > 272 |     it('should filter history by status', async () => {
          |     ^
      273 |       const successProcedure = jest.fn().mockResolvedValue({});
      274 |       const failProcedure = jest.fn().mockRejectedValue(new Error('Failed'));
      275 |       

      at ../../test/api-backend/error-recovery-integration.test.js:272:5
      at ../../test/api-backend/error-recovery-integration.test.js:231:3
      at ../../test/api-backend/error-recovery-integration.test.js:73:1

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/history ΓÇ║ should limit history results

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      294 |     });
      295 |
    > 296 |     it('should limit history results', async () => {
          |     ^
      297 |       const procedure = jest.fn().mockResolvedValue({});
      298 |       errorRecoveryService.registerRecoveryProcedure('test-service', { procedure });
      299 |

      at ../../test/api-backend/error-recovery-integration.test.js:296:5
      at ../../test/api-backend/error-recovery-integration.test.js:231:3
      at ../../test/api-backend/error-recovery-integration.test.js:73:1

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/metrics ΓÇ║ should return recovery metrics

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      319 |         .set('Authorization', `Bearer ${adminToken}`);
      320 |
    > 321 |       expect(response.status).toBe(200);
          |                               ^
      322 |       expect(response.body.status).toBe('success');
      323 |       expect(response.body.data.totalRecoveryAttempts).toBe(0);
      324 |       expect(response.body.data.successfulRecoveries).toBe(0);

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:321:31)

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/metrics ΓÇ║ should update metrics after recovery

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      326 |     });
      327 |
    > 328 |     it('should update metrics after recovery', async () => {
          |     ^
      329 |       const procedure = jest.fn().mockResolvedValue({});
      330 |       errorRecoveryService.registerRecoveryProcedure('test-service', { procedure });
      331 |

      at ../../test/api-backend/error-recovery-integration.test.js:328:5
      at ../../test/api-backend/error-recovery-integration.test.js:315:3
      at ../../test/api-backend/error-recovery-integration.test.js:73:1

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/report ΓÇ║ should return comprehensive recovery report

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      353 |         .set('Authorization', `Bearer ${adminToken}`);
      354 |
    > 355 |       expect(response.status).toBe(200);
          |                               ^
      356 |       expect(response.body.status).toBe('success');
      357 |       expect(response.body.data.summary).toBeDefined();
      358 |       expect(response.body.data.services).toBeDefined();

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:355:31)

  ΓùÅ Error Recovery Endpoints ΓÇ║ DELETE /error-recovery/history ΓÇ║ should clear recovery history

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      371 |
      372 |       let history = errorRecoveryService.getRecoveryHistory();
    > 373 |       expect(history.length).toBe(1);
          |                              ^
      374 |
      375 |       const response = await request(app)
      376 |         .delete('/error-recovery/history')

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:373:30)

  ΓùÅ Error Recovery Endpoints ΓÇ║ POST /error-recovery/reset-metrics ΓÇ║ should reset recovery metrics

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      403 |
      404 |       let metrics = errorRecoveryService.getMetrics();
    > 405 |       expect(metrics.totalRecoveryAttempts).toBe(1);
          |                                             ^
      406 |
      407 |       const response = await request(app)
      408 |         .post('/error-recovery/reset-metrics')

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:405:45)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
-------------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File                                 | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                                                               
-------------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All files                            |   24.82 |    27.13 |   35.56 |   24.63 |                                                                                                                                                                                                 
 api-backend                         |   11.83 |    10.75 |    8.88 |   11.89 |                                                                                                                                                                                                 
  admin-data-flush-service.js        |   66.66 |     53.7 |   70.58 |   66.66 | 96-100,131-133,142-146,176-177,186-190,217-219,225-229,259-260,265-283,299-300,305-317,330-334,439-449,459,490,494,508-509                                                                      
  admin-server.js                    |       0 |        0 |       0 |       0 | 33-1350                                                                                                                                                                                         
  jest.setup.js                      |       0 |        0 |       0 |       0 | 7-25                                                                                                                                                                                            
  logger.js                          |   30.76 |    18.18 |       0 |   30.76 | 26-38,61-79,114-136,142-145,149-152,156-159,163-166                                                                                                                                             
  server.js                          |       0 |        0 |       0 |       0 | 52-963                                                                                                                                                                                          
  streaming-proxy-manager.js         |       0 |        0 |       0 |       0 | 7-396                                                                                                                                                                                           
  swagger-config.js                  |       0 |      100 |     100 |       0 | 12-489                                                                                                                                                                                          
  tracing.js                         |       0 |      100 |     100 |       0 | 8-23                                                                                                                                                                                            
 api-backend/auth                    |    4.43 |    10.78 |    4.76 |    4.47 |                                                                                                                                                                                                 
  auth-service.js                    |    4.43 |    10.78 |    4.76 |    4.47 | 46-788                                                                                                                                                                                          
 api-backend/database                |   39.66 |       50 |   43.12 |   39.22 |                                                                                                                                                                                                 
  cached-query-wrapper.js            |   86.36 |    67.64 |   72.72 |   85.93 | 62-64,133-153                                                                                                                                                                                   
  db-pool.js                         |   33.33 |    66.66 |      25 |   33.33 | 74,96-97,106-107,114,123-124,132,164-262,286-287                                                                                                                                                
  failover-manager.js                |   31.81 |    29.41 |      45 |   31.93 | 73-314,331-334,343,387-394,429-436,520-542,558-588                                                                                                                                              
  migrate-auth-pg.js                 |       0 |        0 |       0 |       0 | 12-124                                                                                                                                                                                          
  migrate-pg.js                      |   13.11 |    63.15 |   18.18 |   13.11 | 44-50,60-210                                                                                                                                                                                    
  migrate.js                         |    4.92 |    13.04 |    6.25 |    4.96 | 37-459,467                                                                                                                                                                                      
  pool-monitor.js                    |       0 |        0 |       0 |       0 | 18-271                                                                                                                                                                                          
  query-cache.js                     |    92.7 |    79.68 |    90.9 |   92.22 | 94-98,241-242                                                                                                                                                                                   
  query-performance-tracker.js       |   96.66 |     87.5 |     100 |   96.66 | 102,311                                                                                                                                                                                         
  query-wrapper.js                   |   61.22 |     61.9 |   35.71 |    64.1 | 31-34,85-104,142-152                                                                                                                                                                            
  read-replica-manager.js            |   37.12 |    47.61 |   57.14 |    37.5 | 48-90,163-187,233-294,342-375,391-421                                                                                                                                                           
 api-backend/database/migrations     |       0 |        0 |       0 |       0 |                                                                                                                                                                                                 
  run-migration.js                   |       0 |        0 |       0 |       0 | 21-279                                                                                                                                                                                          
 api-backend/database/seeds          |       0 |        0 |       0 |       0 |                                                                                                                                                                                                 
  run-seed.js                        |       0 |        0 |       0 |       0 | 22-208                                                                                                                                                                                          
 api-backend/middleware              |   24.87 |     20.3 |   29.87 |   24.87 |                                                                                                                                                                                                 
  activity-logging.js                |       0 |        0 |       0 |       0 | 19-221                                                                                                                                                                                          
  adaptive-rate-limiter.js           |   69.09 |       34 |   78.26 |    68.8 | 63-64,124,208-218,269,301,335,340,344,373-456                                                                                                                                                   
  admin-auth.js                      |       0 |        0 |       0 |       0 | 15-227                                                                                                                                                                                          
  admin-metrics.js                   |       0 |        0 |       0 |       0 | 25-453                                                                                                                                                                                          
  admin-rate-limiter.js              |       0 |        0 |       0 |       0 | 23-247                                                                                                                                                                                          
  api-key-auth.js                    |       0 |        0 |       0 |       0 | 23-227                                                                                                                                                                                          
  api-versioning.js                  |      66 |    59.09 |   53.33 |      66 | 139-164,197-215                                                                                                                                                                                 
  auth-audit-middleware.js           |       0 |        0 |       0 |       0 | 30-404                                                                                                                                                                                          
  auth.js                            |    9.34 |     7.57 |      20 |    9.34 | 37-47,64-70,84,108,121-573                                                                                                                                                                      
  circuit-breaker-middleware.js      |     100 |    80.76 |     100 |     100 | 12-39                                                                                                                                                                                           
  connection-security.js             |       0 |        0 |       0 |       0 | 12-763                                                                                                                                                                                          
  cors-config.js                     |       0 |        0 |       0 |       0 | 18-228                                                                                                                                                                                          
  deprecation-middleware.js          |   66.66 |    45.83 |      80 |   66.66 | 29-30,129-161                                                                                                                                                                                   
  error-notification-middleware.js   |   46.26 |    48.27 |   82.35 |   46.26 | 55,92,114-115,144-145,164-165,184-185,200-227,242-271                                                                                                                                           
  graceful-degradation-middleware.js |   93.02 |       88 |   83.33 |   93.02 | 114-115,211                                                                                                                                                                                     
  graceful-shutdown.js               |       0 |        0 |       0 |       0 | 23-199                                                                                                                                                                                          
  https-enforcer.js                  |       0 |        0 |       0 |       0 | 19-219                                                                                                                                                                                          
  input-sanitizer.js                 |       0 |        0 |       0 |       0 | 21-340                                                                                                                                                                                          
  jwt-validator.js                   |       0 |        0 |       0 |       0 | 17-684                                                                                                                                                                                          
  log-routing.js                     |   37.14 |    37.03 |   30.43 |   37.86 | 29-34,41-155,182-190,201,221-227,231-237,241-247,251-257,261-267,291-292,296-297,309,313                                                                                                        
  metrics-collection.js              |    92.3 |    57.14 |     100 |    92.3 | 42,64                                                                                                                                                                                           
  pipeline.js                        |       0 |        0 |       0 |       0 | 62-202                                                                                                                                                                                          
  rate-limit-exemptions.js           |   95.34 |    83.33 |   95.65 |   95.29 | 194,377-381                                                                                                                                                                                     
  rate-limiter.js                    |   42.17 |     29.5 |   42.85 |   42.17 | 73-83,168,231-275,290-336,352-398,457-472,487,506-581,608-696                                                                                                                                   
  rbac.js                            |   87.05 |    84.21 |     100 |   86.74 | 184,265-270,308,313,332,348-353,374,409-414                                                                                                                                                     
  request-logging.js                 |       0 |        0 |       0 |       0 | 19-72                                                                                                                                                                                           
  request-queuing.js                 |       0 |        0 |       0 |       0 | 20-229                                                                                                                                                                                          
  request-timeout.js                 |       0 |        0 |       0 |       0 | 19-61                                                                                                                                                                                           
  request-validation.js              |       0 |        0 |       0 |       0 | 18-109                                                                                                                                                                                          
  retry-middleware.js                |      80 |    88.57 |      75 |      80 | 53,109-119                                                                                                                                                                                      
  sandbox-middleware.js              |       0 |        0 |       0 |       0 | 11-196                                                                                                                                                                                          
  security-audit-logger.js           |       0 |        0 |       0 |       0 | 13-798                                                                                                                                                                                          
  tier-check.js                      |   50.47 |    64.06 |      50 |   50.47 | 103-108,157-165,178-182,211-216,236-425                                                                                                                                                         
  webhook-rate-limiter.js            |       0 |        0 |       0 |       0 | 25-122                                                                                                                                                                                          
 api-backend/routes                  |    4.64 |     2.09 |    6.44 |    4.68 |                                                                                                                                                                                                 
  adaptive-rate-limiting.js          |       0 |        0 |       0 |       0 | 11-279                                                                                                                                                                                          
  admin-metrics.js                   |       0 |      100 |       0 |       0 | 15-34                                                                                                                                                                                           
  admin.js                           |       0 |        0 |       0 |       0 | 41-490                                                                                                                                                                                          
  alert-configuration.js             |       0 |        0 |       0 |       0 | 22-353                                                                                                                                                                                          
  api-keys.js                        |     8.6 |        0 |       0 |    8.88 | 56-113,142-158,185-209,231-293,319-344,361-387,409-427                                                                                                                                          
  auth-audit.js                      |       0 |        0 |       0 |       0 | 25-429                                                                                                                                                                                          
  auth.js                            |       0 |        0 |       0 |       0 | 17-791                                                                                                                                                                                          
  backup-recovery.js                 |       0 |        0 |       0 |       0 | 16-272                                                                                                                                                                                          
  bridge-polling-routes.js           |       0 |        0 |       0 |       0 | 13-504                                                                                                                                                                                          
  cache-metrics.js                   |       0 |        0 |       0 |       0 | 15-120                                                                                                                                                                                          
  changelog.js                       |       0 |        0 |       0 |       0 | 12-271                                                                                                                                                                                          
  client-logs.js                     |       0 |        0 |       0 |       0 | 5-43                                                                                                                                                                                            
  conversations.js                   |       0 |        0 |       0 |       0 | 15-474                                                                                                                                                                                          
  database-performance.js            |   74.46 |      100 |     100 |   74.46 | 49-53,90-94,125-129,160-164,205-209,238-242                                                                                                                                                     
  db-health.js                       |       0 |        0 |       0 |       0 | 18-191                                                                                                                                                                                          
  deprecation.js                     |   82.35 |    83.33 |     100 |   82.35 | 72,128,178,243,255,338                                                                                                                                                                          
  direct-proxy-routes.js             |       0 |        0 |       0 |       0 | 24-477                                                                                                                                                                                          
  error-recovery.js                  |   14.08 |     5.55 |       0 |    14.7 | 42-52,67-87,103-154,170-188,203-213,228-238,253-263,278-288                                                                                                                                     
  failover.js                        |       0 |        0 |       0 |       0 | 17-245                                                                                                                                                                                          
  monitoring.js                      |       0 |        0 |       0 |       0 | 14-414                                                                                                                                                                                          
  prometheus-metrics.js              |   77.27 |       75 |     100 |   77.27 | 68-73,122,136-140                                                                                                                                                                               
  proxy-config.js                    |       0 |        0 |       0 |       0 | 6-667                                                                                                                                                                                           
  proxy-diagnostics.js               |    9.34 |      2.5 |       0 |    9.34 | 36-37,46-81,95-142,156-202,216-263,277-312,326-364,378-426                                                                                                                                      
  proxy-failover.js                  |       0 |        0 |       0 |       0 | 13-438                                                                                                                                                                                          
  proxy-health.js                    |       0 |        0 |       0 |       0 | 6-349                                                                                                                                                                                           
  proxy-metrics.js                   |       0 |        0 |       0 |       0 | 6-301                                                                                                                                                                                           
  proxy-scaling.js                   |       0 |        0 |       0 |       0 | 6-520                                                                                                                                                                                           
  proxy-usage.js                     |       0 |        0 |       0 |       0 | 6-469                                                                                                                                                                                           
  proxy-webhooks.js                  |       0 |        0 |       0 |       0 | 28-566                                                                                                                                                                                          
  quotas.js                          |       0 |        0 |       0 |       0 | 28-290                                                                                                                                                                                          
  rate-limit-exemptions.js           |       0 |        0 |       0 |       0 | 9-305                                                                                                                                                                                           
  rate-limit-metrics.js              |       0 |        0 |       0 |       0 | 13-456                                                                                                                                                                                          
  rate-limit-violations.js           |       0 |        0 |       0 |       0 | 17-298                                                                                                                                                                                          
  sandbox.js                         |   75.21 |     64.7 |     100 |   75.21 | 67,90,115-116,131,154-155,170,194-195,210,236-237,252,275,292-293,308,334-335,350,376-377,392,423-424,439,467-468                                                                               
  sessions.js                        |       0 |        0 |       0 |       0 | 1-177                                                                                                                                                                                           
  tunnel-failover.js                 |       0 |        0 |       0 |       0 | 27-461                                                                                                                                                                                          
  tunnel-health.js                   |       0 |        0 |       0 |       0 | 25-516                                                                                                                                                                                          
  tunnel-sharing.js                  |       0 |        0 |       0 |       0 | 25-769                                                                                                                                                                                          
  tunnel-usage.js                    |       0 |        0 |       0 |       0 | 26-417                                                                                                                                                                                          
  tunnel-webhooks.js                 |       0 |        0 |       0 |       0 | 28-566                                                                                                                                                                                          
  tunnels.js                         |       0 |        0 |       0 |       0 | 29-1043                                                                                                                                                                                         
  turn-credentials.js                |       0 |        0 |       0 |       0 | 14-66                                                                                                                                                                                           
  user-activity.js                   |       0 |        0 |       0 |       0 | 31-286                                                                                                                                                                                          
  user-deletion.js                   |       0 |        0 |       0 |       0 | 26-425                                                                                                                                                                                          
  user-profile.js                    |       0 |        0 |       0 |       0 | 28-482                                                                                                                                                                                          
  users.js                           |       0 |        0 |       0 |       0 | 29-456                                                                                                                                                                                          
  versioned-routes.js                |       0 |        0 |       0 |       0 | 21-169                                                                                                                                                                                          
  webhook-event-filters.js           |       0 |        0 |       0 |       0 | 25-497                                                                                                                                                                                          
  webhook-payload-transformations.js |       0 |        0 |       0 |       0 | 26-287                                                                                                                                                                                          
  webhook-rate-limiting.js           |       0 |        0 |       0 |       0 | 22-179                                                                                                                                                                                          
  webhook-testing.js                 |       0 |        0 |       0 |       0 | 27-394                                                                                                                                                                                          
  webhooks.js                        |       0 |        0 |       0 |       0 | 20-422                                                                                                                                                                                          
 api-backend/routes/admin            |       0 |        0 |       0 |       0 |                                                                                                                                                                                                 
  admins.js                          |       0 |        0 |       0 |       0 | 26-466                                                                                                                                                                                          
  audit.js                           |       0 |        0 |       0 |       0 | 25-582                                                                                                                                                                                          
  bulk-operations.js                 |       0 |        0 |       0 |       0 | 26-237                                                                                                                                                                                          
  dashboard.js                       |       0 |        0 |       0 |       0 | 25-261                                                                                                                                                                                          
  dns.js                             |       0 |        0 |       0 |       0 | 28-688                                                                                                                                                                                          
  email.js                           |       0 |        0 |       0 |       0 | 33-1429                                                                                                                                                                                         
  payments.js                        |       0 |        0 |       0 |       0 | 27-881                                                                                                                                                                                          
  reports.js                         |       0 |        0 |       0 |       0 | 26-756                                                                                                                                                                                          
  subscriptions.js                   |       0 |        0 |       0 |       0 | 19-815                                                                                                                                                                                          
  users.js                           |       0 |        0 |       0 |       0 | 27-949                                                                                                                                                                                          
 api-backend/scripts                 |       0 |        0 |       0 |       0 |                                                                                                                                                                                                 
  test-auth-flow.js                  |       0 |        0 |       0 |       0 | 12-202                                                                                                                                                                                          
  test-database.js                   |       0 |        0 |       0 |       0 | 12-148                                                                                                                                                                                          
 api-backend/services                |   44.61 |     47.3 |   60.68 |   44.31 |                                                                                                                                                                                                 
  alert-configuration-service.js     |   89.18 |    92.85 |     100 |   88.88 | 97-98,155-158,233,248,305-308                                                                                                                                                                   
  alert-triggering-service.js        |   77.02 |    70.83 |   84.61 |   76.38 | 43,89,128-153,213,244-247                                                                                                                                                                       
  alerting-service.js                |   36.11 |    39.28 |   66.66 |   35.71 | 49-70,86-123,139-186,202-241,292                                                                                                                                                                
  api-key-service.js                 |    12.5 |    17.64 |   11.11 |    12.5 | 45,56-73,100-473                                                                                                                                                                                
  auth-audit-service.js              |   59.45 |    60.86 |   83.33 |   59.45 | 99-117,269-271,314-316,320-322,330,367-369,373-375,379,419-421,425-427,435,490-492,496-498,506,526-566                                                                                          
  backup-recovery-service.js         |   39.42 |    30.15 |   63.63 |   39.65 | 78-168,241-316,336-340,378,407-445,483,490-536,570-574                                                                                                                                          
  bulk-operations-service.js         |   21.79 |    48.88 |   43.75 |   21.79 | 116-563                                                                                                                                                                                         
  changelog-service.js               |   22.78 |    10.86 |    37.5 |   23.68 | 33-98,110-118,138-169,191-209,224                                                                                                                                                               
  circuit-breaker.js                 |     100 |    94.44 |     100 |     100 | 14-15                                                                                                                                                                                           
  cloudflare-dns-service.js          |       0 |        0 |       0 |       0 | 18-704                                                                                                                                                                                          
  deprecation-service.js             |   97.82 |     87.5 |   92.85 |   97.72 | 261                                                                                                                                                                                             
  email-config-service.js            |       0 |        0 |       0 |       0 | 18-827                                                                                                                                                                                          
  email-queue-service.js             |       0 |        0 |       0 |       0 | 19-747                                                                                                                                                                                          
  error-notification-service.js      |   79.53 |    74.61 |   85.18 |   79.16 | 127-147,154-161,168-239,332-336,394,434,448-449,466,495-496,535,545-546,554                                                                                                                     
  error-recovery-service.js          |    95.5 |    85.45 |     100 |   95.34 | 316,326-327,335                                                                                                                                                                                 
  google-workspace-service.js        |       0 |        0 |       0 |       0 | 20-697                                                                                                                                                                                          
  graceful-degradation.js            |   94.11 |    88.23 |     100 |   94.04 | 93-94,121-122,242                                                                                                                                                                               
  health-check.js                    |   95.45 |    89.47 |     100 |   95.45 | 173-174                                                                                                                                                                                         
  index.js                           |       0 |        0 |       0 |       0 |                                                                                                                                                                                                 
  metrics-service.js                 |    80.8 |    45.83 |   94.73 |    80.8 | 198,212,225,239,252,273,309,333-347,371,385,399,413,437,451-454,474                                                                                                                             
  payment-service.js                 |       0 |        0 |       0 |       0 | 14-268                                                                                                                                                                                          
  proxy-config-service.js            |   63.75 |    65.93 |    87.5 |   63.75 | 102-106,118-122,128,143,236-241,252,267-271,285,291,308-309,362-390,402,416-420,435,441-443,462-467,478,488,493-497,513-516,531,536-584                                                         
  proxy-diagnostics-service.js       |   82.75 |    71.05 |   90.62 |   83.53 | 49,92,122,138,156,170,188,200-201,217,224-225,241,253-254,309,349,407-413,415-421,465,510-521,535,544                                                                                           
  proxy-failover-service.js          |   69.49 |     69.4 |   84.61 |   68.96 | 115-120,131,146-150,163,197-202,213,226-230,243,258,305-309,323,349-354,366,383,422-427,442,484-487,499-504,518,522,535,549-553,564,574,579-583,596,642-647,659,673-677,693,697,701,705,815-842 
  proxy-health-service.js            |   98.33 |    90.16 |     100 |   98.31 | 105,345                                                                                                                                                                                         
  proxy-metrics-service.js           |   78.68 |    71.42 |    87.5 |   78.33 | 30-40,196,224-231,253,303-310                                                                                                                                                                   
  proxy-scaling-service.js           |   66.84 |    67.93 |   88.46 |   65.55 | 108-113,124,134,139-143,156,219-224,235,248,253-257,269,276,284,294,304-311,353-358,373,384,433-436,445-450,471-499,511,525-559,571,633-637,660,664,668,676,680,780-791                         
  proxy-usage-service.js             |    1.03 |        0 |    7.69 |    1.05 | 31-562                                                                                                                                                                                          
  proxy-webhook-service.js           |       0 |        0 |       0 |       0 | 28-689                                                                                                                                                                                          
  quota-service.js                   |   76.98 |    70.83 |   93.33 |    76.8 | 31-41,102,142-148,220-225,262,318-325,371-375,405-407,428-433,465,475-480,504-508                                                                                                               
  rate-limit-metrics-service.js      |   87.67 |    63.15 |     100 |   87.67 | 147,171,195,220,237,255,271,286,300                                                                                                                                                             
  rate-limit-violations-service.js   |    65.6 |    68.49 |     100 |    64.7 | 100-105,156-160,193-195,199-201,211-215,251-253,257-259,291-295,331-333,337-339,347,371-375,411-413,417-419,440-443,479-481,485-487,508-511,549-551,555-557,565,589-593                         
  refund-service.js                  |       0 |        0 |       0 |       0 | 15-355                                                                                                                                                                                          
  request-queue-service.js           |   95.12 |    76.08 |    92.3 |   95.06 | 194,305-308                                                                                                                                                                                     
  retry-service.js                   |   96.66 |      100 |     100 |   96.55 | 137-138                                                                                                                                                                                         
  sandbox-service.js                 |     100 |    90.19 |     100 |     100 | 18,341-357                                                                                                                                                                                      
  stripe-client.js                   |       0 |        0 |       0 |       0 | 13-169                                                                                                                                                                                          
  subscription-service.js            |       0 |        0 |       0 |       0 | 14-600                                                                                                                                                                                          
  system-load-monitor.js             |   88.23 |    58.53 |     100 |   89.58 | 47-49,191,194,197,205-217,279                                                                                                                                                                   
  transaction-manager.js             |       0 |        0 |       0 |       0 | 16-443                                                                                                                                                                                          
  tunnel-failover-service.js         |   31.67 |       40 |      36 |   32.25 | 36-123,157,192-198,207-211,233-285,304-307,345-545,567-571                                                                                                                                      
  tunnel-health-service.js           |   17.54 |    29.03 |   15.78 |   18.01 | 32-186,233,279-457                                                                                                                                                                              
  tunnel-service.js                  |       0 |        0 |       0 |       0 | 27-765                                                                                                                                                                                          
  tunnel-sharing-service.js          |     3.2 |     1.75 |   16.66 |     3.2 | 35,39-646                                                                                                                                                                                       
  tunnel-usage-service.js            |    5.15 |     1.81 |   15.38 |    5.26 | 35,39-563                                                                                                                                                                                       
  tunnel-webhook-service.js          |    3.48 |     1.61 |   11.11 |    3.48 | 40,44-689                                                                                                                                                                                       
  user-activity-service.js           |   60.71 |    75.82 |   88.88 |   60.71 | 119-139,170-190,245-247,252-254,258-260,268,304-306,311-313,318-320,324-326,330,361-365,407-409,413-415,422,472-474,479-481,485-487,495,525-527,532-534,539-541,545-547,551                     
  user-deletion-service.js           |   95.61 |      100 |   85.71 |   95.61 | 38-45                                                                                                                                                                                           
  user-profile-service.js            |   66.37 |    53.15 |   66.66 |   66.37 | 42-49,133,137,227,231,280,323,364-426                                                                                                                                                           
  webhook-event-filter.js            |   52.55 |    71.73 |   66.66 |   51.85 | 31-41,71,97,103,134,153,159-341,354,451-455                                                                                                                                                     
  webhook-event-replay-service.js    |       0 |        0 |       0 |       0 | 14-35                                                                                                                                                                                           
  webhook-payload-transformer.js     |   57.28 |    68.98 |      75 |   56.86 | 31-41,67,82,98,130,142-147,162,168,178,192,203,207,222-392,445,493,546,570-582,602,621,628,650-662                                                                                              
  webhook-rate-limiter.js            |   44.24 |    47.36 |   68.75 |   44.24 | 36,43-46,56,104-128,153-217,236-315,329-337,358-381,413,422,440                                                                                                                                 
  webhook-testing-service.js         |    73.5 |    63.63 |   95.45 |    73.5 | 38-48,202,213-214,241-244,320,383-438,460-475,524-527                                                                                                                                           
 api-backend/tunnel                  |       0 |        0 |       0 |       0 |                                                                                                                                                                                                 
  ssh-auth-handler.js                |       0 |        0 |       0 |       0 | 15-210                                                                                                                                                                                          
  ssh-proxy.js                       |       0 |        0 |       0 |       0 | 18-594                                                                                                                                                                                          
  tunnel-routes.js                   |       0 |        0 |       0 |       0 | 31-245                                                                                                                                                                                          
 api-backend/utils                   |    47.4 |    61.08 |   54.65 |   47.58 |                                                                                                                                                                                                 
  audit-logger.js                    |       0 |        0 |       0 |       0 | 37-322                                                                                                                                                                                          
  globals.js                         |       0 |        0 |       0 |       0 | 5-153                                                                                                                                                                                           
  hash.js                            |       0 |      100 |       0 |       0 | 13-30                                                                                                                                                                                           
  input-validation.js                |   91.21 |    92.71 |      96 |   91.15 | 30-33,112,140,154,208,280,319,416,480,504                                                                                                                                                       
  log-aggregation.js                 |   88.88 |    84.94 |   92.85 |   88.67 | 220,223,238-240,246,291                                                                                                                                                                         
  logger.js                          |   33.33 |    16.27 |   28.57 |   33.33 | 84-139,200-248,277-384                                                                                                                                                                          
  stringify.js                       |       0 |        0 |       0 |       0 | 12-30                                                                                                                                                                                           
  tunnel-config-validation.js        |     100 |    97.05 |     100 |     100 | 92                                                                                                                                                                                              
-------------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Jest: "global" coverage threshold for statements (70%) not met: 24.82%
Jest: "global" coverage threshold for branches (70%) not met: 27.13%
Jest: "global" coverage threshold for lines (70%) not met: 24.63%
Jest: "global" coverage threshold for functions (70%) not met: 35.56%
Summary of all failing tests
FAIL ../../test/api-backend/tunnel-health-tracking.test.js
  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Tunnel Status Tracking ΓÇ║ should track tunnel status changes

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Tunnel Status Tracking ΓÇ║ should reject invalid tunnel status

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Endpoint Health Checking ΓÇ║ should get endpoint health status

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Endpoint Health Checking ΓÇ║ should update endpoint health status

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Metrics Collection and Aggregation ΓÇ║ should record request metrics

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Metrics Collection and Aggregation ΓÇ║ should flush metrics to database

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Metrics Collection and Aggregation ΓÇ║ should calculate success rate correctly

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Metrics Collection and Aggregation ΓÇ║ should handle empty metrics

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Tunnel Status Summary ΓÇ║ should get tunnel status summary

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Tunnel Status Summary ΓÇ║ should include endpoint details in status summary

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Health Check Lifecycle ΓÇ║ should start and stop health checks

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)

  ΓùÅ Tunnel Health and Status Tracking ΓÇ║ Health Check Lifecycle ΓÇ║ should not start duplicate health checks

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:37:5)


  ΓùÅ Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'cleanup')

      57 |
      58 |   afterAll(async () => {
    > 59 |     tunnelHealthService.cleanup();
         |                         ^
      60 |     if (pool) {
      61 |       await pool.end();
      62 |     }

      at Object.<anonymous> (../../test/api-backend/tunnel-health-tracking.test.js:59:25)

FAIL ../../test/api-backend/user-activity.test.js
  ΓùÅ User Activity Tracking Service ΓÇ║ logUserActivity ΓÇ║ should log user activity successfully

    TypeError: Cannot read properties of null (reading 'id')

      131 |
      132 |       expect(result).toBeDefined();
    > 133 |       expect(result.id).toBeDefined();
          |                     ^
      134 |       expect(result.created_at).toBeDefined();
      135 |     });
      136 |

      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:133:21)

  ΓùÅ User Activity Tracking Service ΓÇ║ updateUserUsageMetrics ΓÇ║ should create new metrics record for new user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at updateUserUsageMetrics (services/user-activity-service.js:165:28)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:172:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ updateUserUsageMetrics ΓÇ║ should update existing metrics record

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at updateUserUsageMetrics (services/user-activity-service.js:165:28)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:184:7)

  ΓùÅ User Activity Tracking Service ΓÇ║ getUserActivityLogs ΓÇ║ should retrieve user activity logs successfully

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getUserActivityLogs (services/user-activity-service.js:267:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:216:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getUserActivityLogs ΓÇ║ should filter logs by action

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getUserActivityLogs (services/user-activity-service.js:267:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:226:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getUserActivityLogsCount ΓÇ║ should return count of user activity logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getUserActivityLogsCount (services/user-activity-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:242:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getUserUsageMetrics ΓÇ║ should retrieve user usage metrics successfully

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at updateUserUsageMetrics (services/user-activity-service.js:165:28)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:256:7)

  ΓùÅ User Activity Tracking Service ΓÇ║ getUserUsageMetrics ΓÇ║ should return null when no metrics found

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getUserUsageMetrics (services/user-activity-service.js:353:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:268:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getUserActivitySummary ΓÇ║ should retrieve user activity summary successfully

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getUserActivitySummary (services/user-activity-service.js:421:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:282:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getAllUserActivityLogs ΓÇ║ should retrieve all user activity logs for admin

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAllUserActivityLogs (services/user-activity-service.js:494:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:301:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getAllUserActivityLogs ΓÇ║ should filter logs by action

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAllUserActivityLogs (services/user-activity-service.js:494:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:310:22)

  ΓùÅ User Activity Tracking Service ΓÇ║ getAllUserActivityLogsCount ΓÇ║ should return count of all user activity logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAllUserActivityLogsCount (services/user-activity-service.js:550:20)
      at Object.<anonymous> (../../test/api-backend/user-activity.test.js:322:22)

FAIL ../../test/api-backend/admin-data-flush.test.js
  ΓùÅ AdminDataFlushService ΓÇ║ Container and Network Clearing ΓÇ║ should clear containers and networks for specific user

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"all": true, "filters": {"label": ["cloudtolocalllm.type"]}}

    Number of calls: 0

      195 |       expect(result).toHaveProperty('volumes');
      196 |
    > 197 |       expect(mockDocker.listContainers).toHaveBeenCalledWith({
          |                                         ^
      198 |         all: true,
      199 |         filters: { label: ['cloudtolocalllm.type'] },
      200 |       });

      at Object.<anonymous> (../../test/api-backend/admin-data-flush.test.js:197:41)

  ΓùÅ AdminDataFlushService ΓÇ║ Container and Network Clearing ΓÇ║ should clear all containers and networks when no user specified

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      216 |
      217 |       // Should process all containers
    > 218 |       expect(result.containers).toBe(2);
          |                                 ^
      219 |       expect(result.networks).toBe(1);
      220 |     });
      221 |

      at Object.<anonymous> (../../test/api-backend/admin-data-flush.test.js:218:33)

  ΓùÅ AdminDataFlushService ΓÇ║ System Statistics ΓÇ║ should return system statistics

    expect(received).toHaveProperty(path, value)

    Expected path: "totalContainers"

    Expected value: 3
    Received value: 0

      376 |       const stats = await adminService.getSystemStatistics();
      377 |
    > 378 |       expect(stats).toHaveProperty('totalContainers', 3);
          |                     ^
      379 |       expect(stats).toHaveProperty('userContainers', 2);
      380 |       expect(stats).toHaveProperty('userNetworks', 2);
      381 |       expect(stats).toHaveProperty('activeUsers', 2);

      at Object.<anonymous> (../../test/api-backend/admin-data-flush.test.js:378:21)

  ΓùÅ AdminDataFlushService ΓÇ║ System Statistics ΓÇ║ should handle Docker API errors in statistics

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"activeUsers": 0, "lastFlushOperation": null, "totalContainers": 0, "userContainers": 0, "userNetworks": 0}

      386 |       mockDocker.listContainers.mockRejectedValue(new Error('Docker API error'));
      387 |
    > 388 |       await expect(adminService.getSystemStatistics()).rejects.toThrow('Docker API error');
          |             ^
      389 |     });
      390 |   });
      391 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (../../test/api-backend/admin-data-flush.test.js:388:13)

  ΓùÅ AdminDataFlushService ΓÇ║ Operation Status and History ΓÇ║ should return flush history with correct limit

    expect(received).toBe(expected) // Object.is equality

    Expected: "op-9"
    Received: "op-5"

      435 |
      436 |       // Should return most recent operations first
    > 437 |       expect(history[0].operationId).toBe('op-9');
          |                                      ^
      438 |       expect(history[4].operationId).toBe('op-5');
      439 |     });
      440 |   });

      at Object.<anonymous> (../../test/api-backend/admin-data-flush.test.js:437:38)

  ΓùÅ AdminDataFlushService ΓÇ║ Error Handling and Edge Cases ΓÇ║ should handle missing Docker daemon gracefully

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"containers": 0, "networks": 0, "volumes": 0}

      444 |       mockDocker.listContainers.mockRejectedValue(new Error('Docker daemon not running'));
      445 |
    > 446 |       await expect(
          |             ^
      447 |         adminService.clearUserContainersAndNetworks('user123'),
      448 |       ).rejects.toThrow('Docker daemon not running');
      449 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (../../test/api-backend/admin-data-flush.test.js:446:13)

FAIL ../../test/api-backend/webhook-rate-limiting.test.js
  ΓùÅ WebhookRateLimiterService ΓÇ║ getWebhookRateLimitConfig ΓÇ║ should return default config when no config exists

    AggregateError:

      101 |   async getWebhookRateLimitConfig(webhookId, userId) {
      102 |     try {
    > 103 |       const client = await this.pool.connect();
          |                      ^
      104 |       try {
      105 |         const result = await client.query(
      106 |           `SELECT 

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.getWebhookRateLimitConfig (services/webhook-rate-limiter.js:103:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:49:22)

  ΓùÅ WebhookRateLimiterService ΓÇ║ setWebhookRateLimitConfig ΓÇ║ should create new rate limit config

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:71:22)

  ΓùÅ WebhookRateLimiterService ΓÇ║ setWebhookRateLimitConfig ΓÇ║ should update existing rate limit config

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:91:7)

  ΓùÅ WebhookRateLimiterService ΓÇ║ setWebhookRateLimitConfig ΓÇ║ should invalidate cache after update

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:128:7)

  ΓùÅ WebhookRateLimiterService ΓÇ║ checkRateLimit ΓÇ║ should allow request when under limit

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:148:7)

  ΓùÅ WebhookRateLimiterService ΓÇ║ checkRateLimit ΓÇ║ should block request when minute limit exceeded

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:173:7)

  ΓùÅ WebhookRateLimiterService ΓÇ║ checkRateLimit ΓÇ║ should block request when hour limit exceeded

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:200:7)

  ΓùÅ WebhookRateLimiterService ΓÇ║ checkRateLimit ΓÇ║ should allow request when rate limiting disabled

    AggregateError:

      150 |       this.validateRateLimitConfig(config);
      151 |
    > 152 |       const client = await this.pool.connect();
          |                      ^
      153 |       try {
      154 |         await client.query('BEGIN');
      155 |

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.setWebhookRateLimitConfig (services/webhook-rate-limiter.js:152:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:227:7)

  ΓùÅ WebhookRateLimiterService ΓÇ║ getRateLimitStats ΓÇ║ should return stats for webhook

    AggregateError:

      355 |   async getRateLimitStats(webhookId, userId) {
      356 |     try {
    > 357 |       const client = await this.pool.connect();
          |                      ^
      358 |       try {
      359 |         const result = await client.query(
      360 |           `SELECT 

      at node_modules/pg-pool/index.js:45:11
      at WebhookRateLimiterService.getRateLimitStats (services/webhook-rate-limiter.js:357:22)
      at Object.<anonymous> (../../test/api-backend/webhook-rate-limiting.test.js:305:21)

FAIL ../../test/api-backend/tunnel-properties.test.js
  ΓùÅ Tunnel Lifecycle Property-Based Tests ΓÇ║ should maintain consistent tunnel state transitions

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-properties.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Property-Based Tests ΓÇ║ should maintain retrievable tunnel status after transitions

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-properties.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Property-Based Tests ΓÇ║ should maintain consistent metrics across tunnel states

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-properties.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Property-Based Tests ΓÇ║ should always create tunnels with created status

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-properties.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Property-Based Tests ΓÇ║ should handle idempotent status updates

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-properties.test.js:34:5)

FAIL ../../test/api-backend/error-notifications.test.js
  ΓùÅ ErrorNotificationService ΓÇ║ Error Detection and Categorization ΓÇ║ should categorize resource errors correctly

    TypeError: Cannot read properties of undefined (reading 'category')

      67 |       const result = await service.detectAndNotify(error);
      68 |
    > 69 |       expect(result.notification.category).toBe(ErrorCategory.RESOURCE);
         |                                  ^
      70 |     });
      71 |
      72 |     it('should categorize system errors correctly', async () => {

      at Object.<anonymous> (../../test/api-backend/error-notifications.test.js:69:34)

  ΓùÅ ErrorNotificationService ΓÇ║ Notification Cooldown ΓÇ║ should respect cooldown period between notifications

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      196 |       // Second notification within cooldown should not be sent
      197 |       const result2 = await service.detectAndNotify(error);
    > 198 |       expect(result2.notificationSent).toBe(false);
          |                                        ^
      199 |
      200 |       // Wait for cooldown to expire
      201 |       await new Promise(resolve => setTimeout(resolve, 1100));

      at Object.<anonymous> (../../test/api-backend/error-notifications.test.js:198:40)

  ΓùÅ ErrorNotificationService ΓÇ║ Error Count Threshold ΓÇ║ should send notification when error count exceeds threshold

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      231 |       // First error - below threshold
      232 |       const result1 = await service.detectAndNotify(error);
    > 233 |       expect(result1.notificationSent).toBe(false);
          |                                        ^
      234 |
      235 |       // Second error - below threshold
      236 |       const result2 = await service.detectAndNotify(error);

      at Object.<anonymous> (../../test/api-backend/error-notifications.test.js:233:40)

  ΓùÅ ErrorNotificationService ΓÇ║ Error Statistics ΓÇ║ should reset error counts

    expect(received).toBe(expected) // Object.is equality

    Expected: 0
    Received: 1

      339 |       service.resetErrorCounts();
      340 |       stats = service.getErrorStatistics();
    > 341 |       expect(stats.totalErrors).toBe(0);
          |                                 ^
      342 |     });
      343 |   });
      344 |

      at Object.<anonymous> (../../test/api-backend/error-notifications.test.js:341:33)

FAIL ../../test/api-backend/tunnel-usage.test.js
  ΓùÅ TunnelUsageService ΓÇ║ recordUsageEvent ΓÇ║ should record a connection_start event

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ recordUsageEvent ΓÇ║ should record a data_transfer event

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ recordUsageEvent ΓÇ║ should record a connection_end event

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ recordUsageEvent ΓÇ║ should record an error event

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ recordUsageEvent ΓÇ║ should reject invalid event type

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getTunnelUsageMetrics ΓÇ║ should get tunnel usage metrics for a specific date

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getTunnelUsageMetrics ΓÇ║ should return zero metrics if no data exists

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getTunnelUsageMetrics ΓÇ║ should reject if tunnel not found

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getTunnelUsageMetrics ΓÇ║ should reject if user is not tunnel owner

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getTunnelUsageMetricsRange ΓÇ║ should get tunnel usage metrics for a date range

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getTunnelUsageMetricsRange ΓÇ║ should return empty array if no data in range

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ aggregateUserUsage ΓÇ║ should aggregate user usage for a period

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ aggregateUserUsage ΓÇ║ should handle user with no tunnels

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getUserUsageReport ΓÇ║ should get usage report grouped by day

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getUserUsageReport ΓÇ║ should get usage report grouped by tunnel

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getUserUsageReport ΓÇ║ should reject invalid groupBy parameter

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getUserUsageReport ΓÇ║ should require startDate and endDate

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getBillingSummary ΓÇ║ should calculate billing for free tier

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getBillingSummary ΓÇ║ should calculate billing for premium tier

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getBillingSummary ΓÇ║ should calculate billing for enterprise tier

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getUserUsageAggregation ΓÇ║ should get user usage aggregation

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)

  ΓùÅ TunnelUsageService ΓÇ║ getUserUsageAggregation ΓÇ║ should return zero aggregation if no data exists

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:38:24)


  ΓùÅ Test suite failed to run

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-usage.test.js:58:5)

FAIL ../../test/api-backend/proxy-usage.test.js
  ΓùÅ Proxy Usage Tracking ΓÇ║ Record Usage Events ΓÇ║ should record a connection_start event

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Record Usage Events ΓÇ║ should record a data_transfer event

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Record Usage Events ΓÇ║ should record a connection_end event

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Record Usage Events ΓÇ║ should record an error event

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Record Usage Events ΓÇ║ should reject invalid event types

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Get Usage Metrics ΓÇ║ should get usage metrics for a specific date

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Get Usage Metrics ΓÇ║ should return zero metrics for non-existent date

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Get Usage Metrics ΓÇ║ should get usage metrics for a date range

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Get Usage Metrics ΓÇ║ should reject unauthorized access

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Aggregation ΓÇ║ should aggregate user usage for a period

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Aggregation ΓÇ║ should get user usage aggregation

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Aggregation ΓÇ║ should return zero aggregation for user with no proxies

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Reports ΓÇ║ should generate usage report grouped by day

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Reports ΓÇ║ should generate usage report grouped by proxy

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Reports ΓÇ║ should reject invalid groupBy parameter

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Usage Reports ΓÇ║ should require startDate and endDate

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Billing Summary ΓÇ║ should calculate billing for free tier

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Billing Summary ΓÇ║ should calculate billing for premium tier

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)

  ΓùÅ Proxy Usage Tracking ΓÇ║ Billing Summary ΓÇ║ should calculate billing for enterprise tier

    AggregateError:

      33 |
      34 |     // Create test user
    > 35 |     const userResult = await pool.query(
         |                        ^
      36 |       `INSERT INTO users (id, email, auth0_id, tier, is_active)
      37 |        VALUES ($1, $2, $3, $4, $5)
      38 |        RETURNING id`,

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:35:24)


  ΓùÅ Test suite failed to run

    AggregateError:

      52 |   afterAll(async () => {
      53 |     // Cleanup
    > 54 |     await pool.query('DELETE FROM proxy_usage_events WHERE user_id = $1', [testUserId]);
         |     ^
      55 |     await pool.query('DELETE FROM proxy_usage_metrics WHERE user_id = $1', [testUserId]);
      56 |     await pool.query('DELETE FROM proxy_usage_aggregation WHERE user_id = $1', [testUserId]);
      57 |     await pool.query('DELETE FROM proxy_usage_summary WHERE user_id = $1', [testUserId]);

      at node_modules/pg-pool/index.js:45:11
      at Object.<anonymous> (../../test/api-backend/proxy-usage.test.js:54:5)

FAIL ../../test/api-backend/tunnel-lifecycle.test.js
  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Creation ΓÇ║ should create a tunnel with valid data

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Creation ΓÇ║ should reject tunnel creation with empty name

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Creation ΓÇ║ should reject tunnel creation with duplicate name

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Creation ΓÇ║ should reject tunnel name exceeding 255 characters

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Retrieval ΓÇ║ should retrieve tunnel by ID

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Retrieval ΓÇ║ should reject retrieval of non-existent tunnel

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Retrieval ΓÇ║ should reject retrieval of tunnel owned by different user

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Listing ΓÇ║ should list tunnels for user

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Listing ΓÇ║ should support pagination

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Updates ΓÇ║ should update tunnel name

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Updates ΓÇ║ should update tunnel config

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Updates ΓÇ║ should update tunnel endpoints

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Status Management ΓÇ║ should update tunnel status to connecting

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Status Management ΓÇ║ should update tunnel status to connected

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Status Management ΓÇ║ should update tunnel status to disconnected

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Status Management ΓÇ║ should reject invalid status

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Deletion ΓÇ║ should delete tunnel

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Deletion ΓÇ║ should reject deletion of non-existent tunnel

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Metrics ΓÇ║ should retrieve tunnel metrics

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Metrics ΓÇ║ should update tunnel metrics

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

  ΓùÅ Tunnel Lifecycle Management ΓÇ║ Tunnel Activity Logs ΓÇ║ should retrieve tunnel activity logs

    AggregateError:

      41 |   async initialize() {
      42 |     try {
    > 43 |       const client = await this.pool.connect();
         |                      ^
      44 |       await client.query('SELECT 1');
      45 |       client.release();
      46 |       this.logger.info('PostgreSQL connection established', {

      at node_modules/pg-pool/index.js:45:11
      at DatabaseMigratorPG.initialize (database/migrate-pg.js:43:22)
      at Object.<anonymous> (../../test/api-backend/tunnel-lifecycle.test.js:34:5)

FAIL ../../test/api-backend/tunnel-webhooks.test.js
  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Registration ΓÇ║ should register a webhook for tunnel events

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Registration ΓÇ║ should reject invalid webhook URL

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Registration ΓÇ║ should reject empty events array

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Registration ΓÇ║ should reject invalid event type

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Registration ΓÇ║ should reject non-existent tunnel

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Registration ΓÇ║ should allow registering webhook for all user tunnels

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Management ΓÇ║ should retrieve webhook by ID

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Management ΓÇ║ should reject unauthorized webhook access

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Management ΓÇ║ should list webhooks for user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Management ΓÇ║ should update webhook

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Management ΓÇ║ should deactivate webhook

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Management ΓÇ║ should delete webhook

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Events ΓÇ║ should trigger webhook event for tunnel status change

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Events ΓÇ║ should not trigger webhook for inactive webhooks

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Events ΓÇ║ should not trigger webhook for unsubscribed events

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Delivery ΓÇ║ should queue webhook delivery

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Delivery ΓÇ║ should get delivery status

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Delivery ΓÇ║ should get delivery history

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Signature Verification ΓÇ║ should generate valid webhook signature

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Retry Logic ΓÇ║ should schedule retry with exponential backoff

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)

  ΓùÅ Tunnel Webhooks ΓÇ║ Webhook Retry Logic ΓÇ║ should mark delivery as failed after max retries

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:37:5)


  ΓùÅ Test suite failed to run

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-webhooks.test.js:60:5)

FAIL ../../test/api-backend/tunnel-sharing.test.js
  ΓùÅ Tunnel Sharing Service ΓÇ║ shareTunnel ΓÇ║ should share a tunnel with another user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ shareTunnel ΓÇ║ should not share tunnel with non-existent user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ shareTunnel ΓÇ║ should not share tunnel with self

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ shareTunnel ΓÇ║ should reject invalid permission

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ shareTunnel ΓÇ║ should not share tunnel not owned by user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ getTunnelShares ΓÇ║ should get all shares for a tunnel

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ getTunnelShares ΓÇ║ should not get shares for tunnel not owned by user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ revokeTunnelAccess ΓÇ║ should revoke tunnel access from a user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ revokeTunnelAccess ΓÇ║ should not revoke access for tunnel not owned by user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ createShareToken ΓÇ║ should create a share token

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ createShareToken ΓÇ║ should create token with max uses

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ createShareToken ΓÇ║ should reject invalid permission for token

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ getShareTokens ΓÇ║ should get all share tokens for a tunnel

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ revokeShareToken ΓÇ║ should revoke a share token

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ verifyTunnelAccess ΓÇ║ should verify owner has admin access

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ verifyTunnelAccess ΓÇ║ should verify shared user has read access

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ verifyTunnelAccess ΓÇ║ should deny access for user without permission

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ verifyTunnelAccess ΓÇ║ should deny write access when only read is granted

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ getSharedTunnels ΓÇ║ should get tunnels shared with a user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ getTunnelAccessLogs ΓÇ║ should get tunnel access logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ getTunnelAccessLogs ΓÇ║ should not get logs for tunnel not owned by user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ updateSharePermission ΓÇ║ should update share permission

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)

  ΓùÅ Tunnel Sharing Service ΓÇ║ updateSharePermission ΓÇ║ should reject invalid permission update

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:42:5)


  ΓùÅ Test suite failed to run

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/tunnel-sharing.test.js:65:5)

FAIL ../../test/api-backend/query-cache.test.js
  ΓùÅ QueryCacheService ΓÇ║ invalidation ΓÇ║ should invalidate by table name

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      159 |       const count = cache.invalidateByTable('users');
      160 |
    > 161 |       expect(count).toBe(2);
          |                     ^
      162 |       expect(cache.get('table:users:1')).toBeNull();
      163 |       expect(cache.get('table:users:2')).toBeNull();
      164 |       expect(cache.get('table:posts:1')).not.toBeNull();

      at Object.<anonymous> (../../test/api-backend/query-cache.test.js:161:21)

FAIL ../../test/api-backend/request-queuing.test.js
  ΓùÅ RequestQueueService ΓÇ║ Queue timeout ΓÇ║ should timeout queued request after specified duration

    Queue cleared

      252 |           clearTimeout(entry.timeoutId);
      253 |         }
    > 254 |         entry.reject(new Error('Queue cleared'));
          |                      ^
      255 |       }
      256 |     }
      257 |     this.userQueues.clear();

      at RequestQueueService.clearAllQueues (services/request-queue-service.js:254:22)
      at Object.<anonymous> (../../test/api-backend/request-queuing.test.js:262:25)

  ΓùÅ RequestQueueService ΓÇ║ Queue timeout ΓÇ║ should timeout queued request after specified duration

    Queue cleared

      252 |           clearTimeout(entry.timeoutId);
      253 |         }
    > 254 |         entry.reject(new Error('Queue cleared'));
          |                      ^
      255 |       }
      256 |     }
      257 |     this.userQueues.clear();

      at RequestQueueService.clearAllQueues (services/request-queue-service.js:254:22)
      at Object.<anonymous> (../../test/api-backend/request-queuing.test.js:262:25)

  ΓùÅ RequestQueueService ΓÇ║ Queue timeout ΓÇ║ should timeout queued request after specified duration

    Queue cleared

      263 |           clearTimeout(entry.timeoutId);
      264 |         }
    > 265 |         entry.reject(new Error('Queue cleared'));
          |                      ^
      266 |       }
      267 |     }
      268 |     this.ipQueues.clear();

      at RequestQueueService.clearAllQueues (services/request-queue-service.js:265:22)
      at Object.<anonymous> (../../test/api-backend/request-queuing.test.js:262:25)

FAIL ../../test/api-backend/auth-audit.test.js
  ΓùÅ Authentication Audit Logging Service ΓÇ║ logAuthEvent ΓÇ║ should log authentication event with all details

    TypeError: Cannot read properties of null (reading 'id')

      77 |
      78 |       expect(result).toBeDefined();
    > 79 |       expect(result.id).toBeDefined();
         |                     ^
      80 |       expect(result.created_at).toBeDefined();
      81 |     });
      82 |

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:79:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logAuthEvent ΓÇ║ should log failed authentication event

    TypeError: Cannot read properties of null (reading 'id')

      93 |
      94 |       expect(result).toBeDefined();
    > 95 |       expect(result.id).toBeDefined();
         |                     ^
      96 |     });
      97 |
      98 |     it('should throw error if eventType is missing', async () => {

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:95:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logLoginSuccess ΓÇ║ should log successful login

    TypeError: Cannot read properties of null (reading 'id')

      127 |
      128 |       expect(result).toBeDefined();
    > 129 |       expect(result.id).toBeDefined();
          |                     ^
      130 |     });
      131 |   });
      132 |

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:129:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logLoginFailure ΓÇ║ should log failed login attempt

    TypeError: Cannot read properties of null (reading 'id')

      142 |
      143 |       expect(result).toBeDefined();
    > 144 |       expect(result.id).toBeDefined();
          |                     ^
      145 |     });
      146 |
      147 |     it('should log failed login without user ID', async () => {

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:144:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logLoginFailure ΓÇ║ should log failed login without user ID

    TypeError: Cannot read properties of null (reading 'id')

      154 |
      155 |       expect(result).toBeDefined();
    > 156 |       expect(result.id).toBeDefined();
          |                     ^
      157 |     });
      158 |   });
      159 |

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:156:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logLogout ΓÇ║ should log logout event

    TypeError: Cannot read properties of null (reading 'id')

      167 |
      168 |       expect(result).toBeDefined();
    > 169 |       expect(result.id).toBeDefined();
          |                     ^
      170 |     });
      171 |   });
      172 |

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:169:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logTokenRefresh ΓÇ║ should log token refresh event

    TypeError: Cannot read properties of null (reading 'id')

      181 |
      182 |       expect(result).toBeDefined();
    > 183 |       expect(result.id).toBeDefined();
          |                     ^
      184 |     });
      185 |   });
      186 |

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:183:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ logTokenRevoke ΓÇ║ should log token revocation event

    TypeError: Cannot read properties of null (reading 'id')

      195 |
      196 |       expect(result).toBeDefined();
    > 197 |       expect(result.id).toBeDefined();
          |                     ^
      198 |     });
      199 |   });
      200 |

      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:197:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogs ΓÇ║ should retrieve audit logs for user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:219:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogs ΓÇ║ should filter audit logs by event type

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:226:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogs ΓÇ║ should support pagination

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:237:25)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogs ΓÇ║ should return empty array for non-existent user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:252:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogsCount ΓÇ║ should count audit logs for user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogsCount (services/auth-audit-service.js:378:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:260:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogsCount ΓÇ║ should count filtered audit logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogsCount (services/auth-audit-service.js:378:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:267:21)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getFailedLoginAttempts ΓÇ║ should retrieve failed login attempts for user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getFailedLoginAttempts (services/auth-audit-service.js:434:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:288:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getFailedLoginAttempts ΓÇ║ should retrieve all failed login attempts

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getFailedLoginAttempts (services/auth-audit-service.js:434:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:297:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getFailedLoginAttempts ΓÇ║ should support pagination for failed attempts

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getFailedLoginAttempts (services/auth-audit-service.js:434:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:303:25)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogsForAdmin ΓÇ║ should retrieve all audit logs for admin

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogsForAdmin (services/auth-audit-service.js:505:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:314:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogsForAdmin ΓÇ║ should filter audit logs by event type for admin

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogsForAdmin (services/auth-audit-service.js:505:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:320:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogsForAdmin ΓÇ║ should filter audit logs by severity for admin

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogsForAdmin (services/auth-audit-service.js:505:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:331:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ getAuthAuditLogsForAdmin ΓÇ║ should support pagination for admin

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogsForAdmin (services/auth-audit-service.js:505:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:342:25)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ Property Tests ΓÇ║ should preserve all audit log details on round trip

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:376:20)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ Property Tests ΓÇ║ should consistently log correct event types

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:413:22)

  ΓùÅ Authentication Audit Logging Service ΓÇ║ Property Tests ΓÇ║ should preserve IP address and user agent exactly

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at getAuthAuditLogs (services/auth-audit-service.js:329:20)
      at Object.<anonymous> (../../test/api-backend/auth-audit.test.js:439:20)

FAIL ../../test/api-backend/error-notifications-integration.test.js
  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should reset error counts

    TypeError: mime.getType is not a function

      139 |       response = await request(app)
      140 |         .post('/api/reset')
    > 141 |         .send({ type: 'counts' });
          |          ^
      142 |
      143 |       expect(response.status).toBe(200);
      144 |       expect(response.body.success).toBe(true);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:141:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should reset error history

    TypeError: mime.getType is not a function

      156 |       response = await request(app)
      157 |         .post('/api/reset')
    > 158 |         .send({ type: 'history' });
          |          ^
      159 |
      160 |       expect(response.status).toBe(200);
      161 |

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:158:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should reset metrics

    TypeError: mime.getType is not a function

      172 |       response = await request(app)
      173 |         .post('/api/reset')
    > 174 |         .send({ type: 'metrics' });
          |          ^
      175 |
      176 |       expect(response.status).toBe(200);
      177 |

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:174:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should reset all data

    TypeError: mime.getType is not a function

      185 |       const response = await request(app)
      186 |         .post('/api/reset')
    > 187 |         .send({ type: 'all' });
          |          ^
      188 |
      189 |       expect(response.status).toBe(200);
      190 |

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:187:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should reject invalid reset type

    TypeError: mime.getType is not a function

      199 |       const response = await request(app)
      200 |         .post('/api/reset')
    > 201 |         .send({ type: 'invalid' });
          |          ^
      202 |
      203 |       expect(response.status).toBe(400);
      204 |       expect(response.body.error).toBeDefined();

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:201:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should send manual error notification

    TypeError: mime.getType is not a function

      208 |       const response = await request(app)
      209 |         .post('/api/manual-notification')
    > 210 |         .send({
          |          ^
      211 |           message: 'Test error notification',
      212 |           category: 'database',
      213 |           severity: 'critical',

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:210:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Endpoints ΓÇ║ should reject manual notification without message

    TypeError: mime.getType is not a function

      222 |       const response = await request(app)
      223 |         .post('/api/manual-notification')
    > 224 |         .send({});
          |          ^
      225 |
      226 |       expect(response.status).toBe(400);
      227 |       expect(response.body.error).toBeDefined();

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:224:10)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ withErrorNotification Wrapper ΓÇ║ should include request context in wrapped handler errors

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-id"
    Received: "unknown"

      328 |       const history = errorNotificationService.getErrorHistory();
      329 |       expect(history.length).toBeGreaterThan(0);
    > 330 |       expect(history[0].context.correlationId).toBe('test-id');
          |                                                ^
      331 |     });
      332 |   });
      333 |

      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:330:48)

  ΓùÅ Error Notification Middleware Integration ΓÇ║ Error Notification Queue ΓÇ║ should not exceed maximum queue size

    ReferenceError: require is not defined

      385 |
      386 |     it('should not exceed maximum queue size', async () => {
    > 387 |       const service = new (require('../../services/api-backend/services/error-notification-service.js').ErrorNotificationService)({
          |                       ^
      388 |         maxNotificationQueueSize: 5,
      389 |       });
      390 |

      at Object.<anonymous> (../../test/api-backend/error-notifications-integration.test.js:387:23)

FAIL ../../test/api-backend/api-keys.test.js
  ΓùÅ API Key Service ΓÇ║ generateApiKey ΓÇ║ should generate a valid API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ generateApiKey ΓÇ║ should set expiration date when expiresIn is provided

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ generateApiKey ΓÇ║ should create audit log entry

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should validate a valid API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should validate a valid API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:93:22)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for invalid API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for invalid API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:93:22)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for key without prefix

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for key without prefix

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:93:22)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should update last_used_at on validation

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should update last_used_at on validation

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:93:22)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for expired API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for expired API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:93:22)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for inactive API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ validateApiKey ΓÇ║ should return null for inactive API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:93:22)

  ΓùÅ API Key Service ΓÇ║ listApiKeys ΓÇ║ should list all API keys for a user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ listApiKeys ΓÇ║ should not include actual API keys in list

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKey ΓÇ║ should get API key details

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKey ΓÇ║ should get API key details

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:189:22)

  ΓùÅ API Key Service ΓÇ║ getApiKey ΓÇ║ should return null for non-existent key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKey ΓÇ║ should return null for non-existent key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:189:22)

  ΓùÅ API Key Service ΓÇ║ getApiKey ΓÇ║ should return null for unauthorized user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKey ΓÇ║ should return null for unauthorized user

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:189:22)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key name

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key name

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:220:22)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key description

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key description

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:220:22)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key scopes

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key scopes

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:220:22)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key rate limit

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should update API key rate limit

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:220:22)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should not allow updating key_hash

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ updateApiKey ΓÇ║ should not allow updating key_hash

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:220:22)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should generate a new API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should generate a new API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:276:22)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should preserve key metadata during rotation

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should preserve key metadata during rotation

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:276:22)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should revoke the old key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should revoke the old key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:276:22)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should create audit log entries

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ rotateApiKey ΓÇ║ should create audit log entries

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:276:22)

  ΓùÅ API Key Service ΓÇ║ revokeApiKey ΓÇ║ should revoke an API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ revokeApiKey ΓÇ║ should revoke an API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:318:22)

  ΓùÅ API Key Service ΓÇ║ revokeApiKey ΓÇ║ should make revoked key invalid

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ revokeApiKey ΓÇ║ should make revoked key invalid

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:318:22)

  ΓùÅ API Key Service ΓÇ║ revokeApiKey ΓÇ║ should create audit log entry

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ revokeApiKey ΓÇ║ should create audit log entry

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:318:22)

  ΓùÅ API Key Service ΓÇ║ getApiKeyAuditLogs ΓÇ║ should retrieve audit logs for an API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKeyAuditLogs ΓÇ║ should retrieve audit logs for an API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:347:22)

  ΓùÅ API Key Service ΓÇ║ getApiKeyAuditLogs ΓÇ║ should include creation event in audit logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKeyAuditLogs ΓÇ║ should include creation event in audit logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:347:22)

  ΓùÅ API Key Service ΓÇ║ getApiKeyAuditLogs ΓÇ║ should return empty array for non-existent key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:30:24)

  ΓùÅ API Key Service ΓÇ║ getApiKeyAuditLogs ΓÇ║ should return empty array for non-existent key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:347:22)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys ΓÇ║ should create a new API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys ΓÇ║ should reject request without name

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys ΓÇ║ should reject invalid scopes

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys ΓÇ║ should reject invalid rate limit

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys ΓÇ║ should list all API keys

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys ΓÇ║ should list all API keys

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:459:7)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys ΓÇ║ should not include actual API keys

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys ΓÇ║ should not include actual API keys

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:459:7)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys/:keyId ΓÇ║ should get API key details

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys/:keyId ΓÇ║ should get API key details

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:485:22)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys/:keyId ΓÇ║ should return 404 for non-existent key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys/:keyId ΓÇ║ should return 404 for non-existent key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:485:22)

  ΓùÅ API Key Routes ΓÇ║ PATCH /api-keys/:keyId ΓÇ║ should update API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ PATCH /api-keys/:keyId ΓÇ║ should update API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:509:22)

  ΓùÅ API Key Routes ΓÇ║ PATCH /api-keys/:keyId ΓÇ║ should reject invalid fields

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ PATCH /api-keys/:keyId ΓÇ║ should reject invalid fields

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:509:22)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys/:keyId/rotate ΓÇ║ should rotate API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys/:keyId/rotate ΓÇ║ should rotate API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:539:22)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys/:keyId/revoke ΓÇ║ should revoke API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ POST /api-keys/:keyId/revoke ΓÇ║ should revoke API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:557:22)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys/:keyId/audit-logs ΓÇ║ should get audit logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:394:24)

  ΓùÅ API Key Routes ΓÇ║ GET /api-keys/:keyId/audit-logs ΓÇ║ should get audit logs

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at generateApiKey (services/api-key-service.js:49:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:573:22)

  ΓùÅ API Key Middleware ΓÇ║ authenticateApiKey ΓÇ║ should authenticate with valid API key in Authorization header

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:599:24)

  ΓùÅ API Key Middleware ΓÇ║ authenticateApiKey ΓÇ║ should authenticate with valid API key in X-API-Key header

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:599:24)

  ΓùÅ API Key Middleware ΓÇ║ authenticateApiKey ΓÇ║ should reject request without API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:599:24)

  ΓùÅ API Key Middleware ΓÇ║ authenticateApiKey ΓÇ║ should reject invalid API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:599:24)

  ΓùÅ API Key Middleware ΓÇ║ authenticateApiKey ΓÇ║ should reject revoked API key

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:599:24)


  ΓùÅ Test suite failed to run

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:41:5)

  ΓùÅ Test suite failed to run

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:406:5)

  ΓùÅ Test suite failed to run

    AggregateError:

      49 |
      50 |   try {
    > 51 |     const result = await queryFn();
         |                    ^
      52 |     const duration = Date.now() - startTime;
      53 |
      54 |     // Track successful query

      at node_modules/pg-pool/index.js:45:11
      at executeTrackedQuery (database/query-wrapper.js:51:20)
      at Object.<anonymous> (../../test/api-backend/api-keys.test.js:627:5)

FAIL ../../test/api-backend/rate-limiting-properties.test.js
  ΓùÅ Test suite failed to run

    SyntaxError: The requested module '../../utils/globals.js' does not provide an export named 'safeNormalize'

      at Runtime.linkAndEvaluateModule (node_modules/jest-runtime/build/index.js:708:5)

FAIL ../../test/api-backend/proxy-health-properties.test.js
  ΓùÅ Test suite failed to run

    SyntaxError: The requested module '../../utils/globals.js' does not provide an export named 'safeNormalize'

      at Runtime.linkAndEvaluateModule (node_modules/jest-runtime/build/index.js:708:5)

FAIL ../../test/api-backend/database-transaction-properties.test.js
  ΓùÅ Test suite failed to run

    SyntaxError: The requested module '../../utils/globals.js' does not provide an export named 'safeNormalize'

      at Runtime.linkAndEvaluateModule (node_modules/jest-runtime/build/index.js:708:5)

FAIL ../../test/api-backend/bridge-polling-routes.test.js
  ΓùÅ Test suite failed to run

    ReferenceError: jest is not defined

      33 | import bridgePollingRoutes from '../../services/api-backend/routes/bridge-polling-routes.js';
      34 |
    > 35 | jest.mock('../../services/api-backend/middleware/tier-check.js', () => ({
         | ^
      36 |   addTierInfo: (req, res, next) => {
      37 |     req.userTier = 'free';
      38 |     next();

      at ../../test/api-backend/bridge-polling-routes.test.js:35:1

FAIL ../../test/api-backend/adaptive-rate-limiting.test.js (122.115 s)
  ΓùÅ Adaptive Rate Limiting ΓÇ║ SystemLoadMonitor ΓÇ║ should adjust adaptive multiplier based on load

    expect(received).toBeLessThan(expected)

    Expected: < 1
    Received:   1

      179 |
      180 |       // Should reduce multiplier under high load
    > 181 |       expect(monitor.adaptiveMultiplier).toBeLessThan(1.0);
          |                                          ^
      182 |
      183 |       done();
      184 |     });

      at Object.<anonymous> (../../test/api-backend/adaptive-rate-limiting.test.js:181:42)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ AdaptiveRateLimiter ΓÇ║ should enforce window rate limit

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      266 |       for (let i = 0; i < 100; i++) {
      267 |         const result = limiter.checkRateLimit('user1', `corr-${i}`, {});
    > 268 |         expect(result.allowed).toBe(true);
          |                                ^
      269 |       }
      270 |
      271 |       // Next request should be blocked

      at Object.<anonymous> (../../test/api-backend/adaptive-rate-limiting.test.js:268:32)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ AdaptiveRateLimiter ΓÇ║ should reduce limits under high load

    expect(received).toBeLessThan(expected)

    Expected: < 100
    Received:   100

      297 |
      298 |         // Limits should be reduced
    > 299 |         expect(limits.maxRequests).toBeLessThan(100);
          |                                    ^
      300 |         expect(limits.burstRequests).toBeLessThan(20);
      301 |         expect(limits.multiplier).toBeLessThan(1.0);
      302 |

      at Timeout._onTimeout (../../test/api-backend/adaptive-rate-limiting.test.js:299:36)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ AdaptiveRateLimiter ΓÇ║ should reduce limits under high load

    thrown: "Exceeded timeout of 30000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      286 |     });
      287 |
    > 288 |     it('should reduce limits under high load', (done) => {
          |     ^
      289 |       // Simulate high load
      290 |       limiter.systemLoadMonitor.currentMetrics.cpuUsage = 85;
      291 |       limiter.systemLoadMonitor.currentMetrics.memoryUsage = 80;

      at ../../test/api-backend/adaptive-rate-limiting.test.js:288:5
      at ../../test/api-backend/adaptive-rate-limiting.test.js:206:3
      at ../../test/api-backend/adaptive-rate-limiting.test.js:10:1

  ΓùÅ Adaptive Rate Limiting ΓÇ║ AdaptiveRateLimiter ΓÇ║ should track active requests

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      310 |
      311 |       const metrics = limiter.getSystemMetrics();
    > 312 |       expect(metrics.activeRequests).toBe(2);
          |                                      ^
      313 |     });
      314 |
      315 |     it('should complete requests', () => {

      at Object.<anonymous> (../../test/api-backend/adaptive-rate-limiting.test.js:312:38)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ AdaptiveRateLimiter ΓÇ║ should complete requests

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      320 |
      321 |       const metrics = limiter.getSystemMetrics();
    > 322 |       expect(metrics.activeRequests).toBe(1);
          |                                      ^
      323 |     });
      324 |
      325 |     it('should get system metrics', (done) => {

      at Object.<anonymous> (../../test/api-backend/adaptive-rate-limiting.test.js:322:38)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ Adaptive Rate Limiting Integration ΓÇ║ should adapt limits as system load changes

    expect(received).toBeLessThan(expected)

    Expected: < 100
    Received:   100

      438 |
      439 |         // Limits should be reduced
    > 440 |         expect(highLoadLimits.maxRequests).toBeLessThan(initialLimits.maxRequests);
          |                                            ^
      441 |         expect(highLoadLimits.multiplier).toBeLessThan(1.0);
      442 |
      443 |         done();

      at Timeout._onTimeout (../../test/api-backend/adaptive-rate-limiting.test.js:440:44)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ Adaptive Rate Limiting Integration ΓÇ║ should adapt limits as system load changes

    thrown: "Exceeded timeout of 30000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      424 |     });
      425 |
    > 426 |     it('should adapt limits as system load changes', (done) => {
          |     ^
      427 |       // Get initial limits
      428 |       const initialLimits = limiter.getAdaptiveLimits();
      429 |       expect(initialLimits.multiplier).toBe(1.0);

      at ../../test/api-backend/adaptive-rate-limiting.test.js:426:5
      at ../../test/api-backend/adaptive-rate-limiting.test.js:407:3
      at ../../test/api-backend/adaptive-rate-limiting.test.js:10:1

  ΓùÅ Adaptive Rate Limiting ΓÇ║ Adaptive Rate Limiting Integration ΓÇ║ should handle critical load scenario

    expect(received).toBe(expected) // Object.is equality

    Expected: 0.25
    Received: 1

      463 |
      464 |         // Should be at 25% of normal limits
    > 465 |         expect(limits.multiplier).toBe(0.25);
          |                                   ^
      466 |         expect(limits.maxRequests).toBe(25); // 100 * 0.25
      467 |
      468 |         done();

      at Timeout._onTimeout (../../test/api-backend/adaptive-rate-limiting.test.js:465:35)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ Adaptive Rate Limiting Integration ΓÇ║ should handle critical load scenario

    thrown: "Exceeded timeout of 30000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      453 |     });
      454 |
    > 455 |     it('should handle critical load scenario', (done) => {
          |     ^
      456 |       // Simulate critical load
      457 |       limiter.systemLoadMonitor.currentMetrics.cpuUsage = 95;
      458 |       limiter.systemLoadMonitor.currentMetrics.memoryUsage = 95;

      at ../../test/api-backend/adaptive-rate-limiting.test.js:455:5
      at ../../test/api-backend/adaptive-rate-limiting.test.js:407:3
      at ../../test/api-backend/adaptive-rate-limiting.test.js:10:1

  ΓùÅ Adaptive Rate Limiting ΓÇ║ Adaptive Rate Limiting Integration ΓÇ║ should handle recovery from high load

    expect(received).toBeLessThan(expected)

    Expected: < 1
    Received:   1

      478 |       setTimeout(() => {
      479 |         const highLoadLimits = limiter.getAdaptiveLimits();
    > 480 |         expect(highLoadLimits.multiplier).toBeLessThan(1.0);
          |                                           ^
      481 |
      482 |         // Simulate recovery
      483 |         limiter.systemLoadMonitor.currentMetrics.cpuUsage = 20;

      at Timeout._onTimeout (../../test/api-backend/adaptive-rate-limiting.test.js:480:43)

  ΓùÅ Adaptive Rate Limiting ΓÇ║ Adaptive Rate Limiting Integration ΓÇ║ should handle recovery from high load

    thrown: "Exceeded timeout of 30000 ms for a test while waiting for `done()` to be called.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      470 |     });
      471 |
    > 472 |     it('should handle recovery from high load', (done) => {
          |     ^
      473 |       // Simulate high load
      474 |       limiter.systemLoadMonitor.currentMetrics.cpuUsage = 85;
      475 |       limiter.systemLoadMonitor.currentMetrics.memoryUsage = 80;

      at ../../test/api-backend/adaptive-rate-limiting.test.js:472:5
      at ../../test/api-backend/adaptive-rate-limiting.test.js:407:3
      at ../../test/api-backend/adaptive-rate-limiting.test.js:10:1

FAIL ../../test/api-backend/error-recovery-integration.test.js (315.291 s)
  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/status ΓÇ║ should return recovery statuses for all services

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

       96 |         .set('Authorization', `Bearer ${adminToken}`);
       97 |
    >  98 |       expect(response.status).toBe(200);
          |                               ^
       99 |       expect(response.body.status).toBe('success');
      100 |       expect(Array.isArray(response.body.data)).toBe(true);
      101 |       expect(response.body.data.length).toBeGreaterThan(0);

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:98:31)

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/status/:serviceName ΓÇ║ should return recovery status for specific service

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      130 |         .set('Authorization', `Bearer ${adminToken}`);
      131 |
    > 132 |       expect(response.status).toBe(200);
          |                               ^
      133 |       expect(response.body.status).toBe('success');
      134 |       expect(response.body.data.service).toBe('test-service');
      135 |       expect(response.body.data.description).toBe('Test recovery procedure');

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:132:31)

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/status/:serviceName ΓÇ║ should return unknown status for unregistered service

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      141 |         .set('Authorization', `Bearer ${adminToken}`);
      142 |
    > 143 |       expect(response.status).toBe(200);
          |                               ^
      144 |       expect(response.body.data.status).toBe('unknown');
      145 |     });
      146 |

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:143:31)

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/status/:serviceName ΓÇ║ should require service name parameter

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 401

      151 |
      152 |       // Express will not match this route
    > 153 |       expect(response.status).toBe(404);
          |                               ^
      154 |     });
      155 |   });
      156 |

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:153:31)

  ΓùÅ Error Recovery Endpoints ΓÇ║ POST /error-recovery/recover/:serviceName ΓÇ║ should execute recovery procedure successfully

    TypeError: mime.getType is not a function

      163 |         .post('/error-recovery/recover/test-service')
      164 |         .set('Authorization', `Bearer ${adminToken}`)
    > 165 |         .send({ reason: 'Manual intervention' });
          |          ^
      166 |
      167 |       expect(response.status).toBe(200);
      168 |       expect(response.body.status).toBe('success');

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:165:10)

  ΓùÅ Error Recovery Endpoints ΓÇ║ POST /error-recovery/recover/:serviceName ΓÇ║ should return 404 if no recovery procedure registered

    TypeError: mime.getType is not a function

      175 |         .post('/error-recovery/recover/unknown-service')
      176 |         .set('Authorization', `Bearer ${adminToken}`)
    > 177 |         .send({ reason: 'Test' });
          |          ^
      178 |
      179 |       expect(response.status).toBe(404);
      180 |       expect(response.body.status).toBe('error');

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:177:10)

  ΓùÅ Error Recovery Endpoints ΓÇ║ POST /error-recovery/recover/:serviceName ΓÇ║ should return 409 if recovery already in progress

    TypeError: mime.getType is not a function

      191 |         .post('/error-recovery/recover/test-service')
      192 |         .set('Authorization', `Bearer ${adminToken}`)
    > 193 |         .send({ reason: 'First' });
          |          ^
      194 |
      195 |       // Try to start second recovery immediately
      196 |       const promise2 = request(app)

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:193:10)

  ΓùÅ Error Recovery Endpoints ΓÇ║ POST /error-recovery/recover/:serviceName ΓÇ║ should require admin role

    TypeError: mime.getType is not a function

      209 |         .post('/error-recovery/recover/test-service')
      210 |         .set('Authorization', `Bearer ${userToken}`)
    > 211 |         .send({ reason: 'Test' });
          |          ^
      212 |
      213 |       expect(response.status).toBe(403);
      214 |     });

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:211:10)

  ΓùÅ Error Recovery Endpoints ΓÇ║ POST /error-recovery/recover/:serviceName ΓÇ║ should track recovery in history

    TypeError: mime.getType is not a function

      221 |         .post('/error-recovery/recover/test-service')
      222 |         .set('Authorization', `Bearer ${adminToken}`)
    > 223 |         .send({ reason: 'Test recovery' });
          |          ^
      224 |
      225 |       const history = errorRecoveryService.getRecoveryHistory();
      226 |       expect(history.length).toBe(1);

      at Test.getType [as type] (node_modules/superagent/src/node/index.js:352:38)
      at Test.type (node_modules/superagent/src/request-base.js:690:19)
      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:223:10)

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/history ΓÇ║ should return recovery history

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      230 |
      231 |   describe('GET /error-recovery/history', () => {
    > 232 |     it('should return recovery history', async () => {
          |     ^
      233 |       const procedure = jest.fn().mockResolvedValue({});
      234 |       errorRecoveryService.registerRecoveryProcedure('test-service', { procedure });
      235 |

      at ../../test/api-backend/error-recovery-integration.test.js:232:5
      at ../../test/api-backend/error-recovery-integration.test.js:231:3
      at ../../test/api-backend/error-recovery-integration.test.js:73:1

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/history ΓÇ║ should filter history by service name

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      248 |     });
      249 |
    > 250 |     it('should filter history by service name', async () => {
          |     ^
      251 |       const procedure = jest.fn().mockResolvedValue({});
      252 |       errorRecoveryService.registerRecoveryProcedure('service-1', { procedure });
      253 |       errorRecoveryService.registerRecoveryProcedure('service-2', { procedure });

      at ../../test/api-backend/error-recovery-integration.test.js:250:5
      at ../../test/api-backend/error-recovery-integration.test.js:231:3
      at ../../test/api-backend/error-recovery-integration.test.js:73:1

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/history ΓÇ║ should filter history by status

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      270 |     });
      271 |
    > 272 |     it('should filter history by status', async () => {
          |     ^
      273 |       const successProcedure = jest.fn().mockResolvedValue({});
      274 |       const failProcedure = jest.fn().mockRejectedValue(new Error('Failed'));
      275 |       

      at ../../test/api-backend/error-recovery-integration.test.js:272:5
      at ../../test/api-backend/error-recovery-integration.test.js:231:3
      at ../../test/api-backend/error-recovery-integration.test.js:73:1

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/history ΓÇ║ should limit history results

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      294 |     });
      295 |
    > 296 |     it('should limit history results', async () => {
          |     ^
      297 |       const procedure = jest.fn().mockResolvedValue({});
      298 |       errorRecoveryService.registerRecoveryProcedure('test-service', { procedure });
      299 |

      at ../../test/api-backend/error-recovery-integration.test.js:296:5
      at ../../test/api-backend/error-recovery-integration.test.js:231:3
      at ../../test/api-backend/error-recovery-integration.test.js:73:1

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/metrics ΓÇ║ should return recovery metrics

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      319 |         .set('Authorization', `Bearer ${adminToken}`);
      320 |
    > 321 |       expect(response.status).toBe(200);
          |                               ^
      322 |       expect(response.body.status).toBe('success');
      323 |       expect(response.body.data.totalRecoveryAttempts).toBe(0);
      324 |       expect(response.body.data.successfulRecoveries).toBe(0);

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:321:31)

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/metrics ΓÇ║ should update metrics after recovery

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      326 |     });
      327 |
    > 328 |     it('should update metrics after recovery', async () => {
          |     ^
      329 |       const procedure = jest.fn().mockResolvedValue({});
      330 |       errorRecoveryService.registerRecoveryProcedure('test-service', { procedure });
      331 |

      at ../../test/api-backend/error-recovery-integration.test.js:328:5
      at ../../test/api-backend/error-recovery-integration.test.js:315:3
      at ../../test/api-backend/error-recovery-integration.test.js:73:1

  ΓùÅ Error Recovery Endpoints ΓÇ║ GET /error-recovery/report ΓÇ║ should return comprehensive recovery report

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      353 |         .set('Authorization', `Bearer ${adminToken}`);
      354 |
    > 355 |       expect(response.status).toBe(200);
          |                               ^
      356 |       expect(response.body.status).toBe('success');
      357 |       expect(response.body.data.summary).toBeDefined();
      358 |       expect(response.body.data.services).toBeDefined();

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:355:31)

  ΓùÅ Error Recovery Endpoints ΓÇ║ DELETE /error-recovery/history ΓÇ║ should clear recovery history

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      371 |
      372 |       let history = errorRecoveryService.getRecoveryHistory();
    > 373 |       expect(history.length).toBe(1);
          |                              ^
      374 |
      375 |       const response = await request(app)
      376 |         .delete('/error-recovery/history')

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:373:30)

  ΓùÅ Error Recovery Endpoints ΓÇ║ POST /error-recovery/reset-metrics ΓÇ║ should reset recovery metrics

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      403 |
      404 |       let metrics = errorRecoveryService.getMetrics();
    > 405 |       expect(metrics.totalRecoveryAttempts).toBe(1);
          |                                             ^
      406 |
      407 |       const response = await request(app)
      408 |         .post('/error-recovery/reset-metrics')

      at Object.<anonymous> (../../test/api-backend/error-recovery-integration.test.js:405:45)


Test Suites: 22 failed, 57 passed, 79 total
Tests:       262 failed, 1575 passed, 1837 total
Snapshots:   0 total
Time:        318.408 s
Ran all test suites.
∩┐╜ Cleaning up global test environment...
 Global test cleanup completed
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
