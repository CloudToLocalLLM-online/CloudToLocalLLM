# Maintainer: CloudToLocalLLM Team <support@cloudtolocalllm.online>
pkgname=cloudtolocalllm
pkgver=4.0.78
pkgrel=1
pkgdesc="Manage and run powerful Large Language Models locally"
arch=('x86_64')
url="https://cloudtolocalllm.online"
license=('MIT')
depends=('fuse2' 'gtk3' 'libayatana-appindicator')
optdepends=(
    'docker: For containerized LLM execution'
    'ollama: For local LLM management'
    'curl: For API interactions'
    'wget: For model downloads'
)
provides=('cloudtolocalllm')
conflicts=('cloudtolocalllm-git' 'cloudtolocalllm-bin')
source=("https://github.com/CloudToLocalLLM-online/CloudToLocalLLM/releases/download/v${pkgver}/cloudtolocalllm-${pkgver}-x86_64.AppImage"
        "https://github.com/CloudToLocalLLM-online/CloudToLocalLLM/releases/download/v${pkgver}/cloudtolocalllm-${pkgver}-x86_64.AppImage.sha256")
sha256sums=('SKIP'  # Will be updated by build script
            'SKIP') # Will be updated by build script
noextract=("cloudtolocalllm-${pkgver}-x86_64.AppImage")

prepare() {
    # Verify checksum
    cd "$srcdir"
    sha256sum -c "cloudtolocalllm-${pkgver}-x86_64.AppImage.sha256"
}

package() {
    cd "$srcdir"
    
    # Install AppImage to /opt
    install -Dm755 "cloudtolocalllm-${pkgver}-x86_64.AppImage" \
        "$pkgdir/opt/cloudtolocalllm/cloudtolocalllm.AppImage"
    
    # Create wrapper script in /usr/bin
    install -d "$pkgdir/usr/bin"
    cat > "$pkgdir/usr/bin/cloudtolocalllm" << 'EOF'
#!/bin/bash
# CloudToLocalLLM AppImage wrapper script
exec /opt/cloudtolocalllm/cloudtolocalllm.AppImage "$@"
EOF
    chmod +x "$pkgdir/usr/bin/cloudtolocalllm"
    
    # Extract desktop file and icon from AppImage
    cd "$srcdir"
    chmod +x "cloudtolocalllm-${pkgver}-x86_64.AppImage"
    "./cloudtolocalllm-${pkgver}-x86_64.AppImage" --appimage-extract-and-run --appimage-extract >/dev/null 2>&1 || true
    
    # Install desktop file if extracted
    if [ -f "squashfs-root/cloudtolocalllm.desktop" ]; then
        install -Dm644 "squashfs-root/cloudtolocalllm.desktop" \
            "$pkgdir/usr/share/applications/cloudtolocalllm.desktop"
        
        # Fix Exec path in desktop file
        sed -i 's|Exec=cloudtolocalllm|Exec=/usr/bin/cloudtolocalllm|g' \
            "$pkgdir/usr/share/applications/cloudtolocalllm.desktop"
    fi
    
    # Install icon if extracted
    if [ -f "squashfs-root/cloudtolocalllm.png" ]; then
        install -Dm644 "squashfs-root/cloudtolocalllm.png" \
            "$pkgdir/usr/share/pixmaps/cloudtolocalllm.png"
    fi
    
    # Install license if available
    if [ -f "squashfs-root/usr/share/doc/cloudtolocalllm/copyright" ]; then
        install -Dm644 "squashfs-root/usr/share/doc/cloudtolocalllm/copyright" \
            "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
    fi
    
    # Clean up extraction
    rm -rf "squashfs-root" 2>/dev/null || true
}

# vim:set ts=2 sw=2 et:
