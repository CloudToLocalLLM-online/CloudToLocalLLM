name: CI/CD Main Pipeline

on:
  push:
    branches: [ master ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean
      skip_deployment:
        description: 'Skip VPS deployment'
        required: false
        default: false
        type: boolean
      force_rebuild:
        description: 'Force complete rebuild'
        required: false
        default: false
        type: boolean

env:
  FLUTTER_VERSION: '3.32.2'
  NODE_VERSION: '20'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # Version Management using reusable workflow
  version-management:
    uses: ./.github/workflows/reusable-version-management.yml
    with:
      increment_type: build
      commit_changes: true
      use_timestamp_build: true
    secrets: inherit

  # Cross-Platform Build using reusable workflow
  build-cross-platform:
    uses: ./.github/workflows/reusable-flutter-build.yml
    needs: version-management
    with:
      flutter_version: '3.32.2'
      platforms: 'web,linux,windows'
      version: ${{ needs.version-management.outputs.version }}
      skip_tests: ${{ inputs.skip_tests || false }}
    secrets: inherit

  # Linux Package Building using reusable workflow
  build-linux-packages:
    uses: ./.github/workflows/reusable-package-build.yml
    needs: [version-management, build-cross-platform]
    with:
      flutter_version: '3.32.2'
      package_types: 'deb,appimage'
      version: ${{ needs.version-management.outputs.version }}
    secrets: inherit

  # Windows Installer Creation
  build-windows-installer:
    runs-on: windows-latest
    needs: [version-management, build-cross-platform]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Windows build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: 'build-windows-*'
          path: artifacts/
          merge-multiple: true

      - name: Extract Windows build
        run: |
          echo "ðŸ“¦ Extracting Windows build artifacts..."
          mkdir -p build/windows/x64/runner/Release
          cd artifacts
          if (Test-Path "cloudtolocalllm-windows-${{ needs.version-management.outputs.version }}.zip") {
            Expand-Archive -Path "cloudtolocalllm-windows-${{ needs.version-management.outputs.version }}.zip" -DestinationPath "../build/windows/x64/runner/Release" -Force
            Write-Host "âœ… Windows build extracted successfully"
          } else {
            Write-Host "âŒ Windows build ZIP not found"
            exit 1
          }
        shell: powershell

      - name: Install Inno Setup
        run: |
          echo "ðŸ“¦ Installing Inno Setup via Chocolatey..."

          # Install Inno Setup using Chocolatey (more reliable)
          choco install innosetup -y --no-progress

          # Refresh environment variables
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")

          # Verify installation
          $innoPath = "${env:ProgramFiles(x86)}\Inno Setup 6"
          if (Test-Path $innoPath) {
            echo "$innoPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            Write-Host "âœ… Inno Setup installed successfully"
          } else {
            Write-Host "âŒ Inno Setup installation failed"
            exit 1
          }
        shell: powershell

      - name: Update Inno Setup script
        run: |
          echo "ðŸ”§ Updating Inno Setup script with version ${{ needs.version-management.outputs.version }}..."
          $scriptPath = "installers\windows\Basic.iss"
          $content = Get-Content $scriptPath -Raw
          $content = $content -replace '#define MyAppVersion ".*"', '#define MyAppVersion "${{ needs.version-management.outputs.version }}"'
          Set-Content -Path $scriptPath -Value $content -Encoding UTF8
          Write-Host "âœ… Inno Setup script updated"
        shell: powershell

      - name: Create Windows installer
        run: |
          echo "ðŸ”¨ Compiling Windows installer..."
          New-Item -ItemType Directory -Path "dist\windows" -Force | Out-Null

          # Compile installer
          iscc "installers\windows\Basic.iss" /O"dist\windows"

          # Verify installer was created
          $installerPath = "dist\windows\CloudToLocalLLM-Windows-${{ needs.version-management.outputs.version }}-Setup.exe"
          if (Test-Path $installerPath) {
            Write-Host "âœ… Windows installer created successfully: $installerPath"

            # Generate checksum
            $hash = Get-FileHash -Path $installerPath -Algorithm SHA256
            $checksum = $hash.Hash.ToLower()
            "$checksum  CloudToLocalLLM-Windows-${{ needs.version-management.outputs.version }}-Setup.exe" | Set-Content -Path "$installerPath.sha256" -Encoding UTF8
            Write-Host "âœ… Checksum generated: $checksum"
          } else {
            Write-Host "âŒ Windows installer creation failed"
            exit 1
          }
        shell: powershell

      - name: Upload Windows installer artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-${{ needs.version-management.outputs.version }}
          path: |
            dist/windows/CloudToLocalLLM-Windows-${{ needs.version-management.outputs.version }}-Setup.exe
            dist/windows/CloudToLocalLLM-Windows-${{ needs.version-management.outputs.version }}-Setup.exe.sha256
          retention-days: 30

  # GitHub Release Creation
  create-github-release:
    runs-on: ubuntu-latest
    needs: [version-management, build-cross-platform, build-linux-packages, build-windows-installer]
    if: ${{ !inputs.skip_deployment }}  # Only create releases for production deployments
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Windows build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: 'build-windows-*'
          path: release-assets/
          merge-multiple: true

      - name: Download Linux package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: 'package-*'
          path: release-assets/
          merge-multiple: true

      - name: Download Linux build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: 'build-linux-*'
          path: release-assets/
          merge-multiple: true

      - name: Download Windows installer artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: 'windows-installer-*'
          path: release-assets/
          merge-multiple: true

      - name: Organize release assets
        run: |
          echo "ðŸ” Organizing release assets..."
          mkdir -p organized-assets

          # Find and copy all relevant assets
          find release-assets -type f \( \
            -name "*.zip" -o \
            -name "*.exe" -o \
            -name "*.deb" -o \
            -name "*.AppImage" -o \
            -name "*.tar.gz" -o \
            -name "*.sha256" \
          \) -exec cp {} organized-assets/ \;

          echo "ðŸ“¦ Release assets found:"
          ls -la organized-assets/

          # Verify we have both Windows and Linux assets
          if ! ls organized-assets/*windows*.zip >/dev/null 2>&1 && ! ls organized-assets/*Setup.exe >/dev/null 2>&1; then
            echo "âš ï¸ Warning: No Windows assets found"
          fi

          # Check specifically for Windows installer
          if ls organized-assets/*Setup.exe >/dev/null 2>&1; then
            echo "âœ… Windows installer found"
          else
            echo "âš ï¸ Warning: Windows installer not found"
          fi

          # Check specifically for Windows ZIP
          if ls organized-assets/*windows*.zip >/dev/null 2>&1; then
            echo "âœ… Windows portable ZIP found"
          else
            echo "âš ï¸ Warning: Windows portable ZIP not found"
          fi

          if ! ls organized-assets/*.deb >/dev/null 2>&1 && ! ls organized-assets/*.AppImage >/dev/null 2>&1; then
            echo "âš ï¸ Warning: No Linux assets found"
          fi

      - name: Generate release notes
        run: |
          cat > release-notes.md << 'EOF'
          # CloudToLocalLLM v${{ needs.version-management.outputs.version }}

          ## ðŸš€ Desktop Application Release

          This release provides cross-platform desktop applications for CloudToLocalLLM.

          ### ðŸ“¦ What's Included
          - Windows Installer (CloudToLocalLLM-Windows-${{ needs.version-management.outputs.version }}-Setup.exe) - Easy installation with Start Menu integration
          - Windows Portable Application (cloudtolocalllm-windows-${{ needs.version-management.outputs.version }}.zip) - No installation required
          - Linux Debian Package (cloudtolocalllm_${{ needs.version-management.outputs.version }}_amd64.deb) - For Ubuntu/Debian systems
          - Linux AppImage (cloudtolocalllm-${{ needs.version-management.outputs.version }}-x86_64.AppImage) - Portable Linux application
          - Linux Binary Archive (cloudtolocalllm-${{ needs.version-management.outputs.version }}-x86_64.tar.gz) - Pre-compiled binary for any Linux distribution

          ### ðŸ”§ Installation

          **Option 1: Windows Installer (Recommended)**
          1. Download CloudToLocalLLM-Windows-${{ needs.version-management.outputs.version }}-Setup.exe
          2. Run the installer and follow the setup wizard
          3. Launch CloudToLocalLLM from Start Menu or Desktop shortcut
          4. Authenticate with your CloudToLocalLLM account

          **Option 2: Windows Portable ZIP**
          1. Download cloudtolocalllm-windows-${{ needs.version-management.outputs.version }}.zip
          2. Extract the ZIP file to your preferred location
          3. Run cloudtolocalllm.exe from the extracted folder
          4. Authenticate with your CloudToLocalLLM account

          **Option 3: Linux Debian Package**
          ```bash
          sudo dpkg -i cloudtolocalllm_${{ needs.version-management.outputs.version }}_amd64.deb
          sudo apt-get install -f  # Install dependencies if needed
          ```

          **Option 4: Linux AppImage**
          ```bash
          chmod +x cloudtolocalllm-${{ needs.version-management.outputs.version }}-x86_64.AppImage
          ./cloudtolocalllm-${{ needs.version-management.outputs.version }}-x86_64.AppImage
          ```

          **Option 5: Linux Binary Archive**
          ```bash
          tar -xzf cloudtolocalllm-${{ needs.version-management.outputs.version }}-x86_64.tar.gz
          cd cloudtolocalllm-${{ needs.version-management.outputs.version }}-x86_64
          ./cloudtolocalllm
          ```

          ### ðŸŒ Integration
          Works seamlessly with https://app.cloudtolocalllm.online

          ### ðŸ“‹ System Requirements
          - Windows 10+ (64-bit) / Linux (64-bit)
          - 4GB RAM minimum, 8GB recommended
          - Internet connection for authentication

          ---
          **Version**: ${{ needs.version-management.outputs.version }}
          **Build Date**: $(date +%Y-%m-%d)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version-management.outputs.version }}
          name: CloudToLocalLLM v${{ needs.version-management.outputs.version }}
          body_path: release-notes.md
          files: organized-assets/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify release creation
        run: |
          echo "ðŸ” Verifying release creation..."
          sleep 10  # Wait for release to be fully created

          # Check if release exists and has assets
          RELEASE_INFO=$(gh release view v${{ needs.version-management.outputs.version }} --json url,assets)
          RELEASE_URL=$(echo "$RELEASE_INFO" | jq -r '.url')
          ASSET_COUNT=$(echo "$RELEASE_INFO" | jq '.assets | length')

          echo "âœ… Release created: $RELEASE_URL"
          echo "ðŸ“¦ Assets uploaded: $ASSET_COUNT"

          if [ "$ASSET_COUNT" -eq 0 ]; then
            echo "âš ï¸ Warning: No assets found in release"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # VPS Deployment using reusable workflow
  deploy-vps:
    uses: ./.github/workflows/reusable-vps-deployment.yml
    needs: [version-management, build-cross-platform, create-github-release]
    if: ${{ !inputs.skip_deployment }}
    with:
      environment: production
      version: ${{ needs.version-management.outputs.version }}
    secrets:
      ssh_private_key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

  # Notification and Cleanup
  notify-completion:
    runs-on: ubuntu-latest
    needs: [version-management, build-cross-platform, build-linux-packages, build-windows-installer, create-github-release, deploy-vps]
    if: always()
    steps:
      - name: Determine overall status
        id: status
        run: |
          if [ "${{ needs.deploy-vps.result }}" = "success" ] || [ "${{ needs.deploy-vps.result }}" = "skipped" ]; then
            if [ "${{ needs.build-cross-platform.result }}" = "success" ] && [ "${{ needs.build-linux-packages.result }}" = "success" ] && [ "${{ needs.build-windows-installer.result }}" = "success" ] && [ "${{ needs.create-github-release.result }}" = "success" ]; then
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "status=partial" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ CloudToLocalLLM CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.version-management.outputs.full_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status:** ${{ steps.status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment:** ${{ needs.deploy-vps.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Results" >> $GITHUB_STEP_SUMMARY
          echo "- Cross-platform builds: ${{ needs.build-cross-platform.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Linux packages: ${{ needs.build-linux-packages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Windows installer: ${{ needs.build-windows-installer.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub release: ${{ needs.create-github-release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.create-github-release.result }}" = "success" ]; then
            echo "ðŸ”— **GitHub Release:** https://github.com/imrightguy/CloudToLocalLLM/releases/tag/v${{ needs.version-management.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.status.outputs.status }}" = "success" ]; then
            echo "âœ… Pipeline completed successfully!" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.status.outputs.status }}" = "partial" ]; then
            echo "âš ï¸ Pipeline completed with some issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Pipeline failed" >> $GITHUB_STEP_SUMMARY
          fi
