name: "▶️ Gemini Invoke"

on:
  workflow_call:
    inputs:
      additional_context:
        type: "string"
        description: "Any additional context from the request"
        required: false

concurrency:
  group: "${{ github.workflow }}-invoke-${{ github.event_name }}-${{ github.event.pull_request.number || github.event.issue.number }}"
  cancel-in-progress: false

defaults:
  run:
    shell: "bash"

jobs:
  invoke:
    runs-on: "ubuntu-latest"
    permissions:
      contents: "write"
      id-token: "write"
      issues: "write"
      pull-requests: "write"
    steps:
      - uses: actions/checkout@v4
      - name: "Mint identity token"
        id: "mint_identity_token"
        if: |-
          ${{ vars.APP_ID }}
        uses: "actions/create-github-app-token@a8d616148505b5069dccd32f177bb87d7f39123b" # ratchet:actions/create-github-app-token@v2
        with:
          app-id: "${{ vars.APP_ID }}"
          private-key: "${{ secrets.APP_PRIVATE_KEY }}"
          permission-contents: "write"
          permission-issues: "write"
          permission-pull-requests: "write"

      - name: "Run Gemini CLI"
        id: "run_gemini"
        env:
          GEMINI_API_KEY: "${{ secrets.GEMINI_API_KEY }}"
          GITHUB_TOKEN: "${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}"
          TITLE: "${{ github.event.pull_request.title || github.event.issue.title }}"
          DESCRIPTION: "${{ github.event.pull_request.body || github.event.issue.body }}"
          ADDITIONAL_CONTEXT: "${{ inputs.additional_context }}"
        run: |
          mkdir -p .gemini
          cat > .gemini/settings.json <<EOF
          {
            "model": { "maxSessionTurns": 25 },
            "output": { "format": "json" },
            "mcpServers": {
              "github": {
                "command": "docker",
                "args": [
                  "run", "-i", "--rm",
                  "-e", "GITHUB_PERSONAL_ACCESS_TOKEN",
                  "ghcr.io/github/github-mcp-server:v0.18.0"
                ],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "$GITHUB_TOKEN"
                }
              }
            }
          }
          EOF
          if ! npx -y @google/gemini-cli@latest --yolo --output-format json "TITLE: $TITLE. DESCRIPTION: $DESCRIPTION. CONTEXT: $ADDITIONAL_CONTEXT. Please assist with the request." > raw_output.json 2> gemini_error.log; then
            echo "::error::Gemini CLI failed"
            cat gemini_error.log
            exit 1
          fi
          # No specific output needed for invoke other than it finishing successfully
