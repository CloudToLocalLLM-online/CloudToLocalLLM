name: Fix Azure SSL (Deprecated - Now using cert-manager)

on:
  workflow_dispatch:

jobs:
  fix-ssl:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Fix Cloudflare SSL mode to flexible
      run: |
        if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
          echo "❌ Cloudflare API token not set in secrets"
          exit 1
        fi

        CF_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
        CF_ZONE_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=cloudtolocalllm.online" \
          -H "Authorization: Bearer $CF_API_TOKEN" \
          -H "Content-Type: application/json" | jq -r '.result[0].id')

        if [ "$CF_ZONE_ID" = "null" ] || [ -z "$CF_ZONE_ID" ]; then
          echo "❌ Unable to determine Cloudflare Zone ID"
          exit 1
        fi

        echo "Found Zone ID: $CF_ZONE_ID"
        echo "Setting SSL mode to 'flexible'..."

        RESPONSE=$(curl -s -X PATCH "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/settings/ssl" \
          -H "Authorization: Bearer $CF_API_TOKEN" \
          -H "Content-Type: application/json" \
          --data '{"value": "flexible"}')

        SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
        if [ "$SUCCESS" = "true" ]; then
          echo "✅ Cloudflare SSL mode changed to 'flexible' successfully!"
          echo ""
          echo "This allows:"
          echo "  - Visitors → Cloudflare: HTTPS (secure)"
          echo "  - Cloudflare → Origin: HTTP (no TLS required on origin)"
          echo ""
          echo "The 500 error should now be resolved. Please wait a few seconds and try accessing the site again."
        else
          echo "❌ Failed to change SSL mode"
          echo "$RESPONSE" | jq '.errors'
          exit 1
        fi

