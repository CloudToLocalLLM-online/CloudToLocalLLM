name: Cloud Run Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'lib/**'
      - 'services/**'
      - 'config/cloudrun/**'
      - 'scripts/cloudrun/**'
      - '.github/workflows/**'
      - 'cloudbuild.yaml'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (web|api|streaming|all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - web
          - api
          - streaming
      environment:
        description: 'Target environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

permissions:
  contents: read
  id-token: write

concurrency:
  group: cloudrun-deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID || 'cloudtolocalllm-468303' }}
  REGION: ${{ vars.GCP_REGION || 'us-central1' }}

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud (WIF)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ vars.WIF_PROVIDER }}
        service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Deploy Web Service
      if: github.event.inputs.service == 'all' || github.event.inputs.service == '' || github.event.inputs.service == 'web'
      run: |
        gcloud run deploy cloudtolocalllm-web \
          --source . \
          --platform=managed \
          --region=${{ env.REGION }} \
          --allow-unauthenticated \
          --port=8080 \
          --memory=1Gi \
          --cpu=1 \
          --min-instances=0 \
          --max-instances=10 \
          --concurrency=80 \
          --timeout=600 \
          --service-account=cloudtolocalllm-runner@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
          --set-env-vars="NODE_ENV=production,LOG_LEVEL=info,FIREBASE_PROJECT_ID=${{ vars.FIREBASE_PROJECT_ID || 'cloudtolocalllm-468303' }},GCIP_API_KEY=${{ secrets.GCIP_API_KEY }}" \
          --quiet

    - name: Deploy API Service
      if: github.event.inputs.service == 'all' || github.event.inputs.service == '' || github.event.inputs.service == 'api'
      run: |
        gcloud run deploy cloudtolocalllm-api \
          --source . \
          --platform=managed \
          --region=${{ env.REGION }} \
          --allow-unauthenticated \
          --port=8080 \
          --memory=2Gi \
          --cpu=2 \
          --min-instances=0 \
          --max-instances=20 \
          --concurrency=100 \
          --timeout=900 \
          --service-account=cloudtolocalllm-runner@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
          --set-env-vars="NODE_ENV=production,LOG_LEVEL=info,DB_TYPE=postgresql,DB_NAME=cloudtolocalllm,DB_USER=appuser,DB_PASSWORD=${{ secrets.DB_PASSWORD }},DB_HOST=/cloudsql/${{ vars.CLOUD_SQL_CONNECTION_NAME }},CLOUD_SQL_CONNECTION_NAME=${{ vars.CLOUD_SQL_CONNECTION_NAME }},FIREBASE_PROJECT_ID=${{ vars.FIREBASE_PROJECT_ID || 'cloudtolocalllm-468303' }}" \
          --add-cloudsql-instances="${{ vars.CLOUD_SQL_CONNECTION_NAME }}" \
          --quiet

    - name: Deploy Streaming Service
      if: github.event.inputs.service == 'all' || github.event.inputs.service == '' || github.event.inputs.service == 'streaming'
      run: |
        gcloud run deploy cloudtolocalllm-streaming \
          --source . \
          --platform=managed \
          --region=${{ env.REGION }} \
          --allow-unauthenticated \
          --port=8080 \
          --memory=1Gi \
          --cpu=1 \
          --min-instances=0 \
          --max-instances=15 \
          --concurrency=50 \
          --timeout=3600 \
          --service-account=cloudtolocalllm-runner@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
          --set-env-vars="NODE_ENV=production,LOG_LEVEL=info,FIREBASE_PROJECT_ID=${{ vars.FIREBASE_PROJECT_ID || 'cloudtolocalllm-468303' }}" \
          --quiet
