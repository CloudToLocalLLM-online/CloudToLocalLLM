name: Deploy to Google Cloud Run

on:
  push:
    branches: [main, master]
    paths:
      - 'lib/**'
      - 'services/**'
      - 'config/cloudrun/**'
      - 'scripts/cloudrun/**'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (web|api|streaming|all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - web
          - api
          - streaming
      environment:
        description: 'Target environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID || 'cloudtolocalllm-468303' }}
  REGION: ${{ vars.GCP_REGION || 'us-east4' }}
  REGISTRY: ${{ vars.GCP_REGION || 'us-east4' }}-docker.pkg.dev
  REPOSITORY: cloud-run-source-deploy

jobs:
  # Security and validation checks
  security-check:
    name: Security and Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate Cloud Run configuration
      run: |
        echo "Validating Cloud Run configuration files..."
        if [ ! -f "config/cloudrun/Dockerfile.web-cloudrun" ]; then
          echo "Error: Web Dockerfile not found"
          exit 1
        fi
        if [ ! -f "config/cloudrun/Dockerfile.api-cloudrun" ]; then
          echo "Error: API Dockerfile not found"
          exit 1
        fi
        if [ ! -f "scripts/cloudrun/deploy-to-cloudrun.sh" ]; then
          echo "Error: Deployment script not found"
          exit 1
        fi
        echo "Configuration validation passed"

    - name: Check for secrets
      run: |
        echo "Checking for accidentally committed secrets in application code..."
        # Only scan application code directories; ignore example configs/scripts/docs
        if grep -r "AUTH0_CLIENT_SECRET=" lib services --exclude-dir=.git --exclude="*.template" --exclude="*.md" 2>/dev/null; then
          echo "Error: Found potential secrets in application code"
          exit 1
        fi
        echo "Secret check passed"

  # Build container images
  build:
    name: Build Container Images
    runs-on: ubuntu-latest
    needs: security-check
    if: github.event.inputs.service == 'all' || github.event.inputs.service == '' || contains(github.event.inputs.service, 'web') || contains(github.event.inputs.service, 'api') || contains(github.event.inputs.service, 'streaming')

    strategy:
      matrix:
        service: [web, api, streaming]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud (WIF)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ vars.WIF_PROVIDER }}
        service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker authentication
      run: |
        gcloud auth configure-docker ${{ env.REGISTRY }}

    - name: Build and push container image
      run: |
        SERVICE="${{ matrix.service }}"
        IMAGE_TAG="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${SERVICE}:${{ github.sha }}"
        LATEST_TAG="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${SERVICE}:latest"

        # Resolve correct Dockerfile path per service
        DOCKERFILE="config/cloudrun/Dockerfile.${SERVICE}-cloudrun"
        if [ "$SERVICE" = "streaming" ]; then
          DOCKERFILE="config/cloudrun/Dockerfile.streaming-proxy-cloudrun"
        fi
        if [ ! -f "$DOCKERFILE" ]; then
          echo "Error: Dockerfile not found for service '$SERVICE' at $DOCKERFILE" >&2
          ls -la config/cloudrun || true
          exit 1
        fi

        echo "Building ${SERVICE} service using $DOCKERFILE..."
        docker build \
          -f "$DOCKERFILE" \
          -t ${IMAGE_TAG} \
          -t ${LATEST_TAG} \
          .

        echo "Pushing ${SERVICE} image..."
        docker push ${IMAGE_TAG}
        docker push ${LATEST_TAG}

        echo "IMAGE_${SERVICE^^}=${IMAGE_TAG}" >> $GITHUB_ENV

  # Setup Cloud SQL PostgreSQL
  setup-database:
    name: Setup Cloud SQL PostgreSQL
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.service == 'all' || github.event.inputs.service == '' || github.event.inputs.service == 'api'
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud (WIF)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ vars.WIF_PROVIDER }}
        service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Setup Cloud SQL PostgreSQL instance
      run: |
        INSTANCE_NAME="cloudtolocalllm-db"
        DATABASE_NAME="cloudtolocalllm"
        DB_USER="appuser"

        echo "Checking for existing Cloud SQL instance..."
        if gcloud sql instances describe $INSTANCE_NAME >/dev/null 2>&1; then
          echo "âœ… Cloud SQL instance '$INSTANCE_NAME' already exists"
        else
          echo "ðŸ“¦ Creating Cloud SQL PostgreSQL instance..."

          # Generate secure password and store in Secret Manager
          DB_PASSWORD=$(openssl rand -base64 32)
          echo -n "$DB_PASSWORD" | gcloud secrets create db-password --data-file=- || \
          echo -n "$DB_PASSWORD" | gcloud secrets versions add db-password --data-file=-

          # Create Cloud SQL instance
          gcloud sql instances create $INSTANCE_NAME \
            --database-version=POSTGRES_15 \
            --tier=db-f1-micro \
            --region=${{ env.REGION }} \
            --storage-type=SSD \
            --storage-size=10GB \
            --storage-auto-increase \
            --backup-start-time=03:00 \
            --maintenance-window-day=SUN \
            --maintenance-window-hour=04 \
            --deletion-protection

          echo "â³ Waiting for instance to be ready..."
          gcloud sql instances describe $INSTANCE_NAME --format="value(state)" | grep -q RUNNABLE

          # Create database
          echo "ðŸ—„ï¸ Creating database: $DATABASE_NAME"
          gcloud sql databases create $DATABASE_NAME --instance=$INSTANCE_NAME

          # Create user
          echo "ðŸ‘¤ Creating database user: $DB_USER"
          gcloud sql users create $DB_USER \
            --instance=$INSTANCE_NAME \
            --password="$DB_PASSWORD"

          echo "âœ… Cloud SQL setup complete"
        fi

        # Get connection name for deployment
        CONNECTION_NAME=$(gcloud sql instances describe $INSTANCE_NAME --format="value(connectionName)")
        echo "CONNECTION_NAME=$CONNECTION_NAME" >> $GITHUB_ENV

  # Deploy to Cloud Run
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud (WIF)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ vars.WIF_PROVIDER }}
        service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Get Cloud SQL connection info
      if: github.event.inputs.service == 'all' || github.event.inputs.service == '' || github.event.inputs.service == 'api'
      run: |
        INSTANCE_NAME="cloudtolocalllm-db"
        CONNECTION_NAME=$(gcloud sql instances describe $INSTANCE_NAME --format="value(connectionName)" 2>/dev/null || echo "")
        echo "CONNECTION_NAME=$CONNECTION_NAME" >> $GITHUB_ENV

    - name: Deploy Web Service
      if: github.event.inputs.service == 'all' || github.event.inputs.service == '' || github.event.inputs.service == 'web'
      run: |
        # Resolve GCIP API key: prefer GitHub secret; fallback to GCP Secret Manager
        GCIP_API_KEY_VAL="${{ secrets.GCIP_API_KEY }}"
        if [ -z "$GCIP_API_KEY_VAL" ]; then
          GCIP_API_KEY_VAL="$(gcloud secrets versions access latest --secret=\"gcip-api-key\" 2>/dev/null || echo \"\")"
        fi

        gcloud run deploy cloudtolocalllm-web \
          --image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/web:${{ github.sha }} \
          --platform=managed \
          --region=${{ env.REGION }} \
          --allow-unauthenticated \
          --port=8080 \
          --memory=1Gi \
          --cpu=1 \
          --min-instances=0 \
          --max-instances=10 \
          --concurrency=80 \
          --timeout=300 \
          --service-account=cloudtolocalllm-runner@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
          --set-env-vars="NODE_ENV=production,LOG_LEVEL=info,FIREBASE_PROJECT_ID=${{ vars.FIREBASE_PROJECT_ID || 'cloudtolocalllm-468303' }},GCIP_API_KEY=$GCIP_API_KEY_VAL" \
          --quiet

    - name: Deploy API Service
      if: github.event.inputs.service == 'all' || github.event.inputs.service == '' || github.event.inputs.service == 'api'
      run: |
        # Get database password from Secret Manager
        DB_PASSWORD=$(gcloud secrets versions access latest --secret="db-password" 2>/dev/null || echo "")

        # Deploy with PostgreSQL configuration
        gcloud run deploy cloudtolocalllm-api \
          --image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }} \
          --platform=managed \
          --region=${{ env.REGION }} \
          --allow-unauthenticated \
          --port=8080 \
          --memory=2Gi \
          --cpu=2 \
          --min-instances=0 \
          --max-instances=20 \
          --concurrency=100 \
          --timeout=900 \
          --service-account=cloudtolocalllm-runner@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
          --set-env-vars="NODE_ENV=production,LOG_LEVEL=info,DB_TYPE=postgresql,DB_NAME=cloudtolocalllm,DB_USER=appuser,DB_PASSWORD=$DB_PASSWORD,DB_HOST=/cloudsql/$CONNECTION_NAME,CLOUD_SQL_CONNECTION_NAME=$CONNECTION_NAME,FIREBASE_PROJECT_ID=${{ vars.FIREBASE_PROJECT_ID || 'cloudtolocalllm-468303' }}" \
          --add-cloudsql-instances="$CONNECTION_NAME" \
          --quiet

    - name: Deploy Streaming Service
      if: github.event.inputs.service == 'all' || github.event.inputs.service == '' || github.event.inputs.service == 'streaming'
      run: |
        gcloud run deploy cloudtolocalllm-streaming \
          --image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/streaming:${{ github.sha }} \
          --platform=managed \
          --region=${{ env.REGION }} \
          --allow-unauthenticated \
          --port=8080 \
          --memory=1Gi \
          --cpu=1 \
          --min-instances=0 \
          --max-instances=15 \
          --concurrency=50 \
          --timeout=3600 \
          --service-account=cloudtolocalllm-runner@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
          --set-env-vars="NODE_ENV=production,LOG_LEVEL=info,FIREBASE_PROJECT_ID=${{ vars.FIREBASE_PROJECT_ID || 'cloudtolocalllm-468303' }}" \
          --quiet

  # Post-deployment verification
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy

    steps:
    - name: Authenticate to Google Cloud (WIF)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ vars.WIF_PROVIDER }}
        service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Get service URLs
      run: |
        echo "Getting Cloud Run service URLs..."
        WEB_URL=$(gcloud run services describe cloudtolocalllm-web --platform=managed --region=${{ env.REGION }} --format='value(status.url)')
        API_URL=$(gcloud run services describe cloudtolocalllm-api --platform=managed --region=${{ env.REGION }} --format='value(status.url)')
        STREAMING_URL=$(gcloud run services describe cloudtolocalllm-streaming --platform=managed --region=${{ env.REGION }} --format='value(status.url)')

        echo "Web Service URL: $WEB_URL"
        echo "API Service URL: $API_URL"
        echo "Streaming Service URL: $STREAMING_URL"

        echo "WEB_URL=$WEB_URL" >> $GITHUB_ENV
        echo "API_URL=$API_URL" >> $GITHUB_ENV
        echo "STREAMING_URL=$STREAMING_URL" >> $GITHUB_ENV

    - name: Health check
      run: |
        echo "Performing health checks..."

        # Check web service
        if [ -n "$WEB_URL" ]; then
          echo "Checking web service health..."
          curl -f "$WEB_URL/health" || echo "Web service health check failed"
        fi

        # Check API service and database
        if [ -n "$API_URL" ]; then
          echo "Checking API service health..."
          curl -f "$API_URL/health" || echo "API service health check failed"

          echo "Checking database health..."
          DB_HEALTH=$(curl -s "$API_URL/api/db/health" | jq -r '.status' 2>/dev/null || echo "error")
          if [ "$DB_HEALTH" = "healthy" ]; then
            echo "âœ… Database health check passed"
            curl -s "$API_URL/api/db/health" | jq '.'
          else
            echo "âŒ Database health check failed"
            curl -s "$API_URL/api/db/health" || echo "Could not reach database health endpoint"
          fi
        fi

        # Check streaming service
        if [ -n "$STREAMING_URL" ]; then
          echo "Checking streaming service health..."
          curl -f "$STREAMING_URL/health" || echo "Streaming service health check failed"
        fi

        echo "Health checks completed"

    - name: Create deployment summary
      run: |
        echo "## ðŸš€ Cloud Run Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Region:** ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Services:** ${{ github.event.inputs.service || 'all' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Service URLs:**" >> $GITHUB_STEP_SUMMARY
        if [ -n "$WEB_URL" ]; then
          echo "- **Web App:** [$WEB_URL]($WEB_URL)" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -n "$API_URL" ]; then
          echo "- **API Backend:** [$API_URL]($API_URL)" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -n "$STREAMING_URL" ]; then
          echo "- **Streaming Service:** [$STREAMING_URL]($STREAMING_URL)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Test the deployed services using the URLs above" >> $GITHUB_STEP_SUMMARY
        echo "2. Monitor performance and costs in Google Cloud Console" >> $GITHUB_STEP_SUMMARY
        echo "3. Configure custom domains if needed" >> $GITHUB_STEP_SUMMARY
