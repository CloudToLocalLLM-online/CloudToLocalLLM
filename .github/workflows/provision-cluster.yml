name: Provision Cluster (Zero-to-Hero)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to provision (managed/local)'
        required: true
        default: 'managed'
        type: choice
        options:
          - managed
          - local

permissions:
  id-token: write
  contents: read

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  RESOURCE_GROUP: cloudtolocalllm-rg
  CLUSTER_NAME: cloudtolocalllm-aks

jobs:
  provision_hardware:
    name: Provision Hardware (Terraform)
    runs-on: ubuntu-latest
    if: inputs.environment == 'managed'
    defaults:
      run:
        working-directory: infra/terraform
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Get Kubeconfig
        run: |
          echo "Retrieving kubeconfig..."
          az aks get-credentials --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CLUSTER_NAME }} --admin
          kubelogin convert-kubeconfig -l azurecli

  inject_secrets:
    name: Inject Secrets (Kubernetes)
    runs-on: ubuntu-latest
    needs: provision_hardware
    if: inputs.environment == 'managed'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Kubeconfig
        run: |
          az aks get-credentials --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CLUSTER_NAME }} --admin
          kubelogin convert-kubeconfig -l azurecli

      - name: Create Namespace
        run: kubectl create namespace cloudtolocalllm --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Secrets
        run: |
          kubectl create secret generic cloudtolocalllm-secrets \
            --namespace cloudtolocalllm \
            --from-literal=postgres-user=${{ secrets.POSTGRES_USER }} \
            --from-literal=postgres-password=${{ secrets.POSTGRES_PASSWORD }} \
            --from-literal=jwt-secret=${{ secrets.JWT_SECRET }} \
            --from-literal=stripe-test-secret-key=${{ secrets.STRIPE_SECRET_KEY }} \
            --from-literal=stripe-test-publishable-key=${{ secrets.STRIPE_PUBLISHABLE_KEY }} \
            --from-literal=stripe-test-webhook-secret=${{ secrets.STRIPE_WEBHOOK_SECRET }} \
            --dry-run=client -o yaml | kubectl apply -f -

  install_argocd:
    name: Install ArgoCD
    runs-on: ubuntu-latest
    needs: inject_secrets
    if: inputs.environment == 'managed'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Kubeconfig
        run: |
          az aks get-credentials --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CLUSTER_NAME }} --admin
          kubelogin convert-kubeconfig -l azurecli

      - name: Install ArgoCD
        run: |
          kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

      - name: Bootstrap Application
        run: |
          kubectl apply -f k8s/bootstrap/root-app-managed.yaml