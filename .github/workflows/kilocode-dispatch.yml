name: "ðŸ”€ KiloCode Dispatch"

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, reopened, synchronize]
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      do_managed:
        description: "Deploy to Cloud (Managed)"
        type: boolean
        default: false
      do_local:
        description: "Deploy to Local (Ollama)"
        type: boolean
        default: false
      do_desktop:
        description: "Build for Desktop"
        type: boolean
        default: true
      do_mobile:
        description: "Build for Mobile"
        type: boolean
        default: true
      version_override:
        description: "Override version (e.g. 1.2.3). Leave empty for auto."
        type: string
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.sha }}
  cancel-in-progress: true

env:
  # Secrets needed for sub-workflows are passed via 'secrets: inherit'
  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

defaults:
  run:
    shell: "bash"

jobs:
  dispatch:
    runs-on: "ubuntu-latest"
    permissions:
      contents: "read"
      issues: "write"
      pull-requests: "write"
    outputs:
      command: "${{ steps.extract_command.outputs.command }}"
      additional_context: "${{ steps.extract_command.outputs.additional_context }}"
      do_desktop: "${{ github.event.inputs.do_desktop || 'true' }}"
      do_mobile: "${{ github.event.inputs.do_mobile || 'true' }}"
    steps:
      - name: "Extract command"
        id: "extract_command"
        uses: "actions/github-script@v6"
        env:
          EVENT_TYPE: "${{ github.event_name }}.${{ github.event.action }}"
          REQUEST: "${{ github.event.comment.body || github.event.review.body || github.event.issue.body || '' }}"
        with:
          script: |
            const eventType = process.env.EVENT_TYPE;
            const request = (process.env.REQUEST || '').trim();
            const eventName = context.eventName;

            if (eventName === 'push' || eventName === 'workflow_dispatch') {
              core.setOutput('command', 'deploy');
            } else if (eventType === 'pull_request.opened') {
              core.setOutput('command', 'review');
            } else if (['issues.opened', 'issues.reopened'].includes(eventType)) {
              core.setOutput('command', 'triage');
            } else if (request.startsWith("@kilocode-cli /review")) {
              core.setOutput('command', 'review');
              core.setOutput('additional_context', request.replace(/^@kilocode-cli \/review/, '').trim());
            } else if (request.startsWith("@kilocode-cli /triage")) {
              core.setOutput('command', 'triage');
            } else if (request.startsWith("@kilocode-cli /deploy")) {
              core.setOutput('command', 'deploy');
              core.setOutput('additional_context', request.replace(/^@kilocode-cli \/deploy/, '').trim());
            } else if (request.startsWith("@kilocode-cli")) {
              core.setOutput('command', 'invoke');
              core.setOutput('additional_context', request.replace(/^@kilocode-cli/, '').trim());
            } else {
              core.setOutput('command', 'fallthrough');
            }

  # Sub-Dispatch Tasks
  review:
    needs: dispatch
    if: needs.dispatch.outputs.command == 'review'
    uses: "./.github/workflows/kilocode-review.yml"
    with:
      additional_context: "${{ needs.dispatch.outputs.additional_context }}"
    secrets: inherit

  triage:
    needs: dispatch
    if: needs.dispatch.outputs.command == 'triage'
    uses: "./.github/workflows/kilocode-triage.yml"
    with:
      additional_context: "${{ needs.dispatch.outputs.additional_context }}"
    secrets: inherit

  invoke:
    needs: dispatch
    if: needs.dispatch.outputs.command == 'invoke'
    uses: "./.github/workflows/kilocode-invoke.yml"
    with:
      mode: "invoke"
      additional_context: "${{ needs.dispatch.outputs.additional_context }}"
    secrets: inherit

  deploy:
    needs: dispatch
    if: needs.dispatch.outputs.command == 'deploy'
    uses: "./.github/workflows/kilocode-invoke.yml"
    with:
      mode: "deploy"
      do_desktop: ${{ needs.dispatch.outputs.do_desktop == 'true' }}
      do_mobile: ${{ needs.dispatch.outputs.do_mobile == 'true' }}
      sha: ${{ github.sha }}
    secrets: inherit