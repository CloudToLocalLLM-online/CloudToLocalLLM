name: Fix Cloudflare Tunnel

on:
  workflow_dispatch:

env:
  RESOURCE_GROUP: cloudtolocalllm-resources
  CLUSTER_NAME: cloudtolocalllm-aks
  TUNNEL_ID: ee26f195-904b-4406-a8ae-9265c9971004

jobs:
  fix_tunnel:
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS Credentials
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.RESOURCE_GROUP }}
          cluster-name: ${{ env.CLUSTER_NAME }}

      - name: Fetch Tunnel Token and Update Secret
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          # 1. Get Account ID
          echo "Fetching Account ID..."
          ACCOUNT_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json")
          
          ACCOUNT_ID=$(echo $ACCOUNT_RESPONSE | jq -r '.result[0].id')
          
          if [ "$ACCOUNT_ID" == "null" ] || [ -z "$ACCOUNT_ID" ]; then
            echo "Error: Could not fetch Account ID. Response: $ACCOUNT_RESPONSE"
            exit 1
          fi
          echo "Found Account ID: $ACCOUNT_ID"

          # 2. Get Tunnel Token
          echo "Fetching Tunnel Token for ID: $TUNNEL_ID..."
          TOKEN_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/cfd_tunnel/$TUNNEL_ID/token" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json")
          
          TUNNEL_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.result')
          
          if [ "$TUNNEL_TOKEN" == "null" ] || [ -z "$TUNNEL_TOKEN" ]; then
            echo "Error: Could not fetch Tunnel Token. Response: $TOKEN_RESPONSE"
            exit 1
          fi
          echo "Successfully fetched Tunnel Token."

          # 3. Update Kubernetes Secret
          echo "Updating Kubernetes secret..."
          kubectl create secret generic tunnel-credentials \
            --from-literal=token="$TUNNEL_TOKEN" \
            --namespace=cloudtolocalllm \
            --dry-run=client -o yaml | kubectl apply -f -

          # 4. Restart Cloudflared
          echo "Restarting Cloudflared deployment..."
          kubectl rollout restart deployment/cloudflared -n cloudtolocalllm
          kubectl rollout status deployment/cloudflared -n cloudtolocalllm --timeout=60s
