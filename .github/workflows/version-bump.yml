name: Version Bump & Tagging

on:
  push:
    branches:
      - main
    # Don't trigger on version bump commits or tags
    tags-ignore:
      - '**'

# Prevent multiple version bumps running simultaneously
concurrency:
  group: version-bump
  cancel-in-progress: false

jobs:
  analyze_and_bump:
    # Skip if commit message contains [skip ci] or [no-version]
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[no-version]')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git describe
          fetch-tags: true  # Explicitly fetch tags
          token: ${{ secrets.PAT_TOKEN }}  # Use PAT to trigger other workflows
          persist-credentials: true
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Ensure we're on main branch
          git checkout main
          git pull --rebase origin main
      
      - name: Setup Gemini CLI
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Make Gemini CLI wrapper executable and add to PATH
          chmod +x scripts/gemini-cli.cjs
          sudo ln -sf "$(pwd)/scripts/gemini-cli.cjs" /usr/local/bin/gemini-cli
          # Test Gemini CLI
          if [ -n "$GEMINI_API_KEY" ]; then
            gemini-cli "Respond with just OK" && echo "✅ Gemini CLI test passed" || echo "⚠️  Gemini test failed, will fallback to patch bump"
          else
            echo "⚠️  GEMINI_API_KEY not set, will fallback to patch bump"
          fi
          echo "✅ Gemini CLI installed"
      
      - name: Analyze Commits with Gemini
        id: analyze
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          chmod +x scripts/analyze-version-bump.sh
          ./scripts/analyze-version-bump.sh
      
      - name: Update All Version References
        env:
          NEW_VERSION: ${{ steps.analyze.outputs.new_version }}
          BUMP_TYPE: ${{ steps.analyze.outputs.bump_type }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          chmod +x scripts/update-all-versions.sh
          ./scripts/update-all-versions.sh "$NEW_VERSION" "$COMMIT_SHA"
      
      - name: Commit Version Changes
        run: |
          NEW_VERSION="${{ steps.analyze.outputs.new_version }}"
          
          # Check if there are changes to commit
          if git diff --quiet && git diff --cached --quiet; then
            echo "No version changes to commit"
          else
            git add -A
            git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
            
            # Push with retry logic
            for i in {1..3}; do
              if git push origin main; then
                echo "✅ Pushed version changes"
                break
              else
                echo "⚠️  Push failed, retrying in 5s... (attempt $i/3)"
                sleep 5
                git pull --rebase origin main
              fi
            done
          fi
      
      - name: Create Platform Tags and Trigger Deployments
        env:
          VERSION: ${{ steps.analyze.outputs.new_version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest commit SHA after version bump
          git pull --rebase origin main || true
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # Create platform-specific tags
          TAG_CLOUD="${VERSION}-cloud-${SHORT_SHA}"
          TAG_DESKTOP="${VERSION}-desktop-${SHORT_SHA}"
          TAG_MOBILE="${VERSION}-mobile-${SHORT_SHA}"
          
          echo "Creating tags..."
          # Only create tags if they don't exist
          git tag "$TAG_CLOUD" 2>/dev/null || echo "Tag $TAG_CLOUD already exists"
          git tag "$TAG_DESKTOP" 2>/dev/null || echo "Tag $TAG_DESKTOP already exists"
          git tag "$TAG_MOBILE" 2>/dev/null || echo "Tag $TAG_MOBILE already exists"
          
          # Push tags
          echo "Pushing tags..."
          for i in {1..3}; do
            if git push origin --tags; then
              echo "✅ Tags pushed successfully"
              break
            else
              echo "⚠️  Tag push failed, retrying... (attempt $i/3)"
              sleep 5
            fi
          done
          
          echo ""
          echo "✅ Platform tags created:"
          echo "  - ${TAG_CLOUD}"
          echo "  - ${TAG_DESKTOP}"
          echo "  - ${TAG_MOBILE}"
          echo ""
          echo "ℹ️  Note: Cloud deployment workflow will auto-trigger on tag: $TAG_CLOUD"

