name: Build Desktop Apps & Create Release

# This workflow builds desktop applications using GitHub-hosted runners (FREE for public repos)
#
# Triggers:
#   - Push tags matching 'v*' (e.g., v4.5.0) - Automatic release build
#   - Manual workflow dispatch - For testing or custom builds
#
# What it does:
#   1. Extracts version from pubspec.yaml or git tag
#   2. Builds Windows desktop app on GitHub-hosted runner
#   3. Creates installer (.exe) and portable package (.zip)
#   4. Generates SHA256 checksums for security verification
#   5. Creates GitHub release with all artifacts
#
# Cost: $0/month for public repositories (free unlimited minutes)
# Build time: ~15-20 minutes per build
#
# For troubleshooting, see: docs/BUILD_TROUBLESHOOTING.md

on:
  push:
    branches:
      - build
    tags:
      - "v*" # Trigger on version tags (e.g., v4.5.0)
  workflow_dispatch:
    inputs:
      build_type:
        description: "Build type"
        required: true
        default: "release"
        type: choice
        options:
          - release

permissions:
  contents: write
  id-token: write

concurrency:
  group: build-release-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: "3.38.1"

jobs:
  # Extract version information
  version-info:
    name: Extract Version Information
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
      full_version: ${{ steps.version.outputs.full_version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
      release_name: ${{ steps.version.outputs.release_name }}
      is_release: ${{ steps.version.outputs.is_release }}

    steps:
      - name: Job Started - Version Information Extraction
        run: |
          echo "::group::Job Information"
          echo "Job: Extract Version Information"
          echo "Runner: ubuntu-latest"
          echo "Trigger: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "::endgroup::"

      - name: Start Time Tracking
        id: start-time
        run: |
          START_TIME=$(date +%s)
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Checkout code
        run: |
          echo "::group::Checking out repository"
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
          echo "::endgroup::"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for version detection

      - name: Checkout Complete
        run: |
          echo "::notice::Repository checked out successfully"
          echo "Current directory: $(pwd)"
          echo "Git status:"
          git status --short || echo "No changes"

      - name: Setup GitHub CLI
        run: |
          echo "::group::Setting up GitHub CLI"
          if ! command -v gh &> /dev/null; then
            echo "GitHub CLI not found. Installing..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update && sudo apt install gh -y
            
            if [ $? -eq 0 ]; then
              echo "::notice::GitHub CLI installed successfully"
            else
              echo "::error::Failed to install GitHub CLI"
              exit 1
            fi
          else
            echo "::notice::GitHub CLI already installed"
            gh --version
          fi
          echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Extract version and generate build number
        id: version
        run: |
          echo "::group::Version Extraction"
          echo "Extracting version information from repository..."
          echo ""

          # Check if this is a tag push, workflow_dispatch with release, or main branch
          BUILD_TYPE="${{ github.event.inputs.build_type }}"

          echo "Build trigger: ${{ github.event_name }}"
          echo "Build type: $BUILD_TYPE"
          echo "Git ref: ${{ github.ref }}"
          echo ""

          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Release build from tag
            TAG_REF="${GITHUB_REF_NAME:-${{ github.ref_name }}}"
            VERSION="${TAG_REF#v}"
            IS_RELEASE="true"
          elif [[ "$BUILD_TYPE" == "release" ]]; then
            # Manual release build via workflow_dispatch
            if [ -f pubspec.yaml ]; then
              VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
            fi
            
            # Fallback if version not found
            if [ -z "$VERSION" ]; then
              SHORT_SHA=$(git rev-parse --short HEAD)
              VERSION="0.0.0-dev-$SHORT_SHA"
            fi
            IS_RELEASE="true"
          elif [[ "${{ github.ref }}" == "refs/heads/build" ]]; then
            # Build branch - no release
            if [ -f pubspec.yaml ]; then
              VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
            fi
            
            # Fallback if version not found
            if [ -z "$VERSION" ]; then
              SHORT_SHA=$(git rev-parse --short HEAD)
              VERSION="0.0.0-build-$SHORT_SHA"
            fi
            IS_RELEASE="false"
          else
            # Main branch build - extract version from pubspec.yaml
            if [ -f pubspec.yaml ]; then
              VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
            fi
            
            # Fallback to commit-based version if not found
            if [ -z "$VERSION" ]; then
              SHORT_SHA=$(git rev-parse --short HEAD)
              VERSION="0.0.0+dev-$SHORT_SHA"
              IS_RELEASE="false"
            else
              # Always create release for any version on main branch
              # Extract version from previous commit's pubspec.yaml if available
              PREV_PUBSPEC_VERSION=""
              if git show HEAD~1:pubspec.yaml 2>/dev/null | grep -q "^version:"; then
                PREV_PUBSPEC_VERSION=$(git show HEAD~1:pubspec.yaml 2>/dev/null | grep "^version:" | sed 's/version: //' | sed 's/+.*//' | tr -d ' ' || echo "")
              fi
              
              echo "Current version: $VERSION"
              echo "Previous version: $PREV_PUBSPEC_VERSION"
              
              # Always create release for main branch builds
              echo "Creating release for version $VERSION on main branch"
              IS_RELEASE="true"
            fi
          fi

          # Generate build number as YYYYMMDDHHMM (UTC)
          BUILD_NUMBER=$(date -u +%Y%m%d%H%M)

          # Full version: x.x.x+YYYYMMDDHHMM (or with commit SHA for dev builds)
          if [ "$IS_RELEASE" == "true" ]; then
            FULL_VERSION="$VERSION+$BUILD_NUMBER"
            TAG_NAME="v$VERSION"
            RELEASE_NAME="CloudToLocalLLM v$VERSION"
          else
            SHORT_SHA=$(git rev-parse --short HEAD)
            FULL_VERSION="$VERSION+$BUILD_NUMBER-$SHORT_SHA"
            TAG_NAME=""
            RELEASE_NAME="CloudToLocalLLM Dev Build $BUILD_NUMBER"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT

          echo ""
          echo "::notice::Version extraction completed successfully"
          echo "::group::Version Information"
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUMBER"
          echo "Full Version: $FULL_VERSION"
          echo "Is Release: $IS_RELEASE"
          if [ "$IS_RELEASE" == "true" ]; then
            echo "Tag: $TAG_NAME"
            echo "Release Name: $RELEASE_NAME"
          fi
          echo "::endgroup::"

      - name: Version Info Job Duration
        if: always()
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - ${{ steps.start-time.outputs.start_time }}))
          echo "::notice::Version info job completed in ${DURATION}s"
          echo "Duration: ${DURATION}s" >> $GITHUB_STEP_SUMMARY

      - name: Job Failed - Error Summary
        if: failure()
        run: |
          echo "::error::Version info job failed"
          echo "##  Version Info Job Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Common Issues:**" >> $GITHUB_STEP_SUMMARY
          echo "- pubspec.yaml not found or invalid format" >> $GITHUB_STEP_SUMMARY
          echo "- Git history not available (check fetch-depth)" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid version format in pubspec.yaml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify pubspec.yaml exists and has valid version field" >> $GITHUB_STEP_SUMMARY
          echo "2. Check git tags are properly formatted (v*)" >> $GITHUB_STEP_SUMMARY
          echo "3. Review workflow logs for specific error messages" >> $GITHUB_STEP_SUMMARY

  # Build application using matrix strategy
  build-desktop:
    name: Build ${{ matrix.platform }} App
    runs-on: ${{ matrix.os }}
    needs: version-info
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
            build-command: flutter build windows --release
            artifact-name: windows-desktop

          # Linux and Android builds temporarily disabled - focus on Windows first
          # - platform: linux
          #   os: ubuntu-latest
          #   build-command: flutter build linux --release
          #   artifact-name: linux-desktop

          # - platform: android
          #   os: ubuntu-latest
          #   build-command: flutter build apk --release --split-per-abi
          #   artifact-name: android-apk

    steps:
      - name: Job Started - Build ${{ matrix.platform }} App (Windows)
        if: matrix.platform == 'windows'
        run: |
          Write-Host "::group::Build Job Information" -ForegroundColor Green
          Write-Host "=== Build ${{ matrix.platform }} Job Started ===" -ForegroundColor Green
          Write-Host ""
          Write-Host "Platform: ${{ matrix.platform }}" -ForegroundColor Cyan
          Write-Host "Runner OS: ${{ runner.os }}" -ForegroundColor Cyan
          Write-Host "Runner Architecture: ${{ runner.arch }}" -ForegroundColor Cyan
          Write-Host "Version: ${{ needs.version-info.outputs.version }}" -ForegroundColor Cyan
          Write-Host "Full Version: ${{ needs.version-info.outputs.full_version }}" -ForegroundColor Cyan
          Write-Host "Is Release: ${{ needs.version-info.outputs.is_release }}" -ForegroundColor Cyan
          Write-Host "Build Command: ${{ matrix.build-command }}" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Started at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" -ForegroundColor Cyan
          Write-Host "::endgroup::"
        shell: powershell

      - name: Job Started - Build ${{ matrix.platform }} App (Linux)
        if: matrix.platform == 'linux'
        run: |
          echo "::group::Build Job Information"
          echo "=== Build ${{ matrix.platform }} Job Started ==="
          echo ""
          echo "Platform: ${{ matrix.platform }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "Runner Architecture: ${{ runner.arch }}"
          echo "Version: ${{ needs.version-info.outputs.version }}"
          echo "Full Version: ${{ needs.version-info.outputs.full_version }}"
          echo "Is Release: ${{ needs.version-info.outputs.is_release }}"
          echo "Build Command: ${{ matrix.build-command }}"
          echo ""
          echo "Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "::endgroup::"

      - name: Job Started - Build ${{ matrix.platform }} App (Android)
        if: matrix.platform == 'android'
        run: |
          echo "::group::Build Job Information"
          echo "=== Build ${{ matrix.platform }} Job Started ==="
          echo ""
          echo "Platform: ${{ matrix.platform }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "Runner Architecture: ${{ runner.arch }}"
          echo "Version: ${{ needs.version-info.outputs.version }}"
          echo "Full Version: ${{ needs.version-info.outputs.full_version }}"
          echo "Is Release: ${{ needs.version-info.outputs.is_release }}"
          echo "Build Command: ${{ matrix.build-command }}"
          echo "Target Architectures: ARM64, ARMv7, x86_64"
          echo ""
          echo "Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "::endgroup::"

      - name: Start Build Time Tracking (Windows)
        if: matrix.platform == 'windows'
        id: build-start-time-windows
        run: |
          $START_TIME = [int][double]::Parse((Get-Date -UFormat %s))
          echo "start_time=$START_TIME" >> $env:GITHUB_OUTPUT
          Write-Host "Build timer started"
        shell: powershell

      - name: Start Build Time Tracking (Linux)
        if: matrix.platform == 'linux'
        id: build-start-time-linux
        run: |
          START_TIME=$(date +%s)
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "Build timer started"

      - name: Start Build Time Tracking (Android)
        if: matrix.platform == 'android'
        id: build-start-time-android
        run: |
          START_TIME=$(date +%s)
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "Build timer started"

      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true
          cache-key: "flutter-:os:-:channel:-:version:-:arch:-:hash:"
          cache-path: "${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:"

      # Caching disabled temporarily due to hanging issues with large .dart_tool directory
      # - name: Cache Flutter pub dependencies
      #   uses: actions/cache@v4
      #   with:
      #     path: |
      #       ${{ runner.temp }}\.pub-cache
      #       ${{ runner.temp }}\pub-cache
      #       ~/.pub-cache
      #       .dart_tool
      #     key: ${{ matrix.platform }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
      #     restore-keys: |
      #       ${{ matrix.platform }}-flutter-pub-
      #       flutter-pub-
      #   continue-on-error: true

      # Chocolatey cache disabled temporarily due to hanging issues
      # - name: Cache Chocolatey packages
      #   if: matrix.platform == 'windows'
      #   uses: actions/cache@v4
      #   with:
      #     path: |
      #       ${{ runner.temp }}\chocolatey
      #       C:\ProgramData\chocolatey\lib
      #       C:\ProgramData\chocolatey\bin
      #     key: ${{ runner.os }}-chocolatey-innosetup-${{ hashFiles('.github/workflows/build-release.yml') }}
      #     restore-keys: |
      #       ${{ runner.os }}-chocolatey-innosetup-
      #       ${{ runner.os }}-chocolatey-
      #   continue-on-error: true

      - name: Verify all build dependencies (Windows)
        if: matrix.platform == 'windows'
        run: |
          Write-Host "::group::Verifying Build Dependencies" -ForegroundColor Green
          Write-Host "=== Dependency Verification ===" -ForegroundColor Green
          Write-Host ""

          $errors = @()

          # Check Flutter
          Write-Host "Checking Flutter..." -ForegroundColor Cyan
          try {
            flutter --version
            Write-Host " Flutter is available" -ForegroundColor Green
          } catch {
            Write-Host " Flutter not found" -ForegroundColor Red
            $errors += "Flutter not found"
          }
          Write-Host ""

          # Check Git
          Write-Host "Checking Git..." -ForegroundColor Cyan
          try {
            git --version
            Write-Host " Git is available" -ForegroundColor Green
          } catch {
            Write-Host " Git not found" -ForegroundColor Red
            $errors += "Git not found"
          }
          Write-Host ""

          # Run Flutter doctor
          Write-Host "Running Flutter doctor..." -ForegroundColor Cyan
          flutter doctor -v
          Write-Host ""

          if ($errors.Count -gt 0) {
            Write-Host "::error::Dependency verification failed" -ForegroundColor Red
            foreach ($error in $errors) {
              Write-Host "::error::$error"
            }
            exit 1
          }

          Write-Host "::notice::All dependencies verified successfully" -ForegroundColor Green
          Write-Host "::endgroup::"
        shell: powershell

      - name: Verify all build dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          echo "::group::Verifying Build Dependencies"
          echo "=== Dependency Verification ==="
          echo ""

          errors=0

          # Check Flutter
          echo "Checking Flutter..."
          if flutter --version; then
            echo " Flutter is available"
          else
            echo " Flutter not found"
            errors=$((errors + 1))
          fi
          echo ""

          # Check Git
          echo "Checking Git..."
          if git --version; then
            echo " Git is available"
          else
            echo " Git not found"
            errors=$((errors + 1))
          fi
          echo ""

          # Run Flutter doctor
          echo "Running Flutter doctor..."
          flutter doctor -v
          echo ""

          if [ $errors -gt 0 ]; then
            echo "::error::Dependency verification failed with $errors errors"
            exit 1
          fi

          echo "::notice::Core dependencies verified successfully"
          echo "::notice::Linux-specific tools will be installed in next steps"
          echo "::endgroup::"

      - name: Configure Windows desktop support
        if: matrix.platform == 'windows'
        run: |
          Write-Host "::group::Configuring Flutter for Windows" -ForegroundColor Green
          Write-Host "Enabling Windows desktop support..."
          flutter config --enable-windows-desktop

          Write-Host "Disabling web support..."
          flutter config --no-enable-web

          Write-Host "::notice::Flutter configured for Windows desktop" -ForegroundColor Green
          Write-Host "::endgroup::"
        shell: powershell

      - name: Configure Linux desktop support
        if: matrix.platform == 'linux'
        run: |
          echo "::group::Configuring Flutter for Linux"
          echo "Enabling Linux desktop support..."
          flutter config --enable-linux-desktop

          echo "Disabling web support..."
          flutter config --no-enable-web

          echo "::notice::Flutter configured for Linux desktop"
          echo "::endgroup::"

      - name: Install Linux build dependencies
        if: matrix.platform == 'linux'
        run: |
          echo "::group::Installing Linux build dependencies"
          echo "=== Installing Linux Build Dependencies ==="
          echo ""

          echo "Updating package lists..."
          sudo apt-get update

          echo ""
          echo "Installing Flutter Linux dependencies..."
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev \
            libsecret-1-dev \
            desktop-file-utils

          echo ""
          echo "::notice::Linux build dependencies installed successfully"
          echo "::endgroup::"

      - name: Install Flatpak build tools
        if: matrix.platform == 'linux'
        run: |
          echo "::group::Installing Flatpak build tools"
          echo "=== Installing Flatpak Build Tools ==="
          echo ""

          echo "Installing Flatpak and flatpak-builder..."
          sudo apt-get install -y flatpak flatpak-builder

          echo ""
          echo "Adding Flathub repository..."
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

          echo ""
          echo "Installing Freedesktop SDK and Platform..."
          sudo flatpak install -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

          echo ""
          echo "::notice::Flatpak build tools installed successfully"
          echo "::endgroup::"

      - name: Install .deb packaging tools
        if: matrix.platform == 'linux'
        run: |
          echo "::group::Installing .deb packaging tools"
          echo "=== Installing .deb Packaging Tools ==="
          echo ""

          echo "Installing dpkg-dev, fakeroot, and lintian..."
          sudo apt-get install -y \
            dpkg-dev \
            fakeroot \
            lintian

          echo ""
          echo "Verifying installations..."
          dpkg-deb --version
          fakeroot --version
          lintian --version

          echo ""
          echo "::notice::.deb packaging tools installed successfully"
          echo "::endgroup::"

      - name: Setup Java for Android
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"
          cache: "gradle"

      - name: Setup Android SDK
        if: matrix.platform == 'android'
        uses: android-actions/setup-android@v3
        with:
          api-level: 33
          build-tools: 33.0.2
          ndk-version: 25.2.9519653

      - name: Cache Gradle dependencies
        if: matrix.platform == 'android'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
        continue-on-error: true

      - name: Setup Android signing configuration
        if: matrix.platform == 'android'
        run: |
          echo "::group::Setting up Android signing"
          echo "=== Setting up Android Signing Configuration ==="
          echo ""

          # Create key.properties file for signing
          mkdir -p android
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=../release-keystore.jks
          EOF

          echo " key.properties file created"
          echo ""

          # Decode and save keystore from secrets
          echo "Decoding keystore from GitHub Secrets..."
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/release-keystore.jks

          if [ -f android/release-keystore.jks ]; then
            KEYSTORE_SIZE=$(du -h android/release-keystore.jks | cut -f1)
            echo " Keystore file created: android/release-keystore.jks"
            echo "  Size: $KEYSTORE_SIZE"
          else
            echo "::error::Failed to create keystore file"
            exit 1
          fi

          echo ""
          echo "::notice::Android signing configuration created successfully"
          echo "::endgroup::"

      - name: Verify Android SDK and dependencies
        if: matrix.platform == 'android'
        run: |
          echo "::group::Verifying Android SDK"
          echo "=== Verifying Android SDK and Dependencies ==="
          echo ""

          errors=0

          # Check Java
          echo "Checking Java..."
          if java -version 2>&1; then
            echo " Java is available"
          else
            echo " Java not found"
            errors=$((errors + 1))
          fi
          echo ""

          # Check Android SDK
          echo "Checking Android SDK..."
          if [ -n "$ANDROID_HOME" ] && [ -d "$ANDROID_HOME" ]; then
            echo " Android SDK location: $ANDROID_HOME"
          else
            echo " Android SDK not found"
            errors=$((errors + 1))
          fi
          echo ""

          # List installed SDK components
          if [ -n "$ANDROID_HOME" ] && [ -d "$ANDROID_HOME/cmdline-tools" ]; then
            echo "Installed SDK components:"
            $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed || true
            echo ""
          fi

          # Accept licenses
          echo "Accepting Android SDK licenses..."
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses 2>&1 || true
          echo ""

          # Check Flutter
          echo "Checking Flutter..."
          if flutter --version; then
            echo " Flutter is available"
          else
            echo " Flutter not found"
            errors=$((errors + 1))
          fi
          echo ""

          # Run Flutter doctor
          echo "Running Flutter doctor..."
          flutter doctor -v
          echo ""

          if [ $errors -gt 0 ]; then
            echo "::error::Dependency verification failed with $errors errors"
            exit 1
          fi

          echo "::notice::Android SDK and dependencies verified successfully"
          echo "::endgroup::"

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Patch web package for non-web platforms
        if: matrix.platform != 'web'
        run: |
          if [ "${{ matrix.platform }}" == "windows" ]; then
            pwsh scripts/patch-web-package.ps1
          else
            # For Linux/Android, create bash version
            WEB_PKG="$PUB_CACHE/hosted/pub.dev/web-1.1.1"
            if [ -d "$WEB_PKG" ]; then
              echo "Patching web package..."
              cp "$WEB_PKG/lib/web.dart" "$WEB_PKG/lib/web.dart.backup" 2>/dev/null || true
              echo "// Stub for non-web platforms" > "$WEB_PKG/lib/web.dart"
              echo "library web;" >> "$WEB_PKG/lib/web.dart"
              echo "Web package patched"
            fi
          fi
        shell: bash

      - name: Build Windows application
        if: matrix.platform == 'windows'
        run: |
          Write-Host "::group::Building Windows application" -ForegroundColor Green
          Write-Host "Running: flutter build windows --release"
          Write-Host ""

          # Build without running the INSTALL target to avoid CMake errors
          flutter build windows --release --no-tree-shake-icons

          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Flutter build failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host ""
          Write-Host "::notice::Windows application built successfully" -ForegroundColor Green
          Write-Host "::endgroup::"
        shell: powershell

      - name: Build Linux application
        if: matrix.platform == 'linux'
        run: |
          echo "::group::Building Linux application"
          echo "Running: flutter build linux --release"
          echo ""

          flutter build linux --release

          if [ $? -ne 0 ]; then
            echo "::error::Flutter build failed"
            exit 1
          fi

          echo ""
          echo "::notice::Linux application built successfully"
          echo "::endgroup::"

      - name: Verify Build Output (Windows)
        if: matrix.platform == 'windows'
        run: |
          Write-Host "::group::Verifying build output" -ForegroundColor Green
          $buildPath = "build\windows\x64\runner\Release"

          if (-not (Test-Path $buildPath)) {
            Write-Host "::error::Build output directory not found: $buildPath"
            exit 1
          }

          Write-Host "Build output directory exists: $buildPath"
          Write-Host ""
          Write-Host "Build artifacts:"
          Get-ChildItem $buildPath -Recurse -File | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize

          Write-Host "::notice::Build output verified successfully" -ForegroundColor Green
          Write-Host "::endgroup::"
        shell: powershell

      - name: Verify Build Output (Linux)
        if: matrix.platform == 'linux'
        run: |
          echo "::group::Verifying build output"
          buildPath="build/linux/x64/release/bundle"

          if [ ! -d "$buildPath" ]; then
            echo "::error::Build output directory not found: $buildPath"
            exit 1
          fi

          echo "Build output directory exists: $buildPath"
          echo ""
          echo "Build artifacts:"
          ls -lh "$buildPath"

          echo ""
          echo "::notice::Build output verified successfully"
          echo "::endgroup::"

      - name: Verify Flatpak manifest
        if: matrix.platform == 'linux'
        run: |
          echo "::group::Verifying Flatpak manifest"
          echo "=== Verifying Flatpak Manifest ==="
          echo ""

          MANIFEST_FILE="com.cloudtolocalllm.CloudToLocalLLM.yml"

          if [ ! -f "$MANIFEST_FILE" ]; then
            echo "::error::Flatpak manifest not found: $MANIFEST_FILE"
            exit 1
          fi

          echo " Flatpak manifest found: $MANIFEST_FILE"
          echo ""
          echo "Manifest contents:"
          cat "$MANIFEST_FILE"

          echo ""
          echo "::notice::Flatpak manifest verified successfully"
          echo "::endgroup::"

      - name: Install Inno Setup
        if: matrix.platform == 'windows'
        run: |
          Write-Host "::group::Installing Inno Setup" -ForegroundColor Green
          Write-Host "=== Installing Inno Setup ===" -ForegroundColor Green
          Write-Host ""

          # Check if Inno Setup is already installed
          $innoSetupPaths = @(
            "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe",
            "${env:ProgramFiles}\Inno Setup 6\ISCC.exe",
            "${env:ProgramFiles(x86)}\Inno Setup 5\ISCC.exe",
            "${env:ProgramFiles}\Inno Setup 5\ISCC.exe"
          )

          $innoPath = $null
          foreach ($path in $innoSetupPaths) {
            if (Test-Path $path) {
              $innoPath = $path
              Write-Host "Inno Setup already installed at: $innoPath" -ForegroundColor Cyan
              break
            }
          }

          # Install if not found
          if (-not $innoPath) {
            Write-Host "Inno Setup not found. Installing..." -ForegroundColor Yellow
            Write-Host ""
            
            # Try Chocolatey first
            Write-Host "Attempting installation via Chocolatey..." -ForegroundColor Cyan
            try {
              $chocoInstalled = Get-Command choco -ErrorAction SilentlyContinue
              if ($chocoInstalled) {
                Write-Host "Chocolatey found. Installing Inno Setup..."
                choco install innosetup -y --no-progress
                
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "Inno Setup installed successfully via Chocolatey" -ForegroundColor Green
                  
                  # Verify installation
                  foreach ($path in $innoSetupPaths) {
                    if (Test-Path $path) {
                      $innoPath = $path
                      break
                    }
                  }
                } else {
                  Write-Host "Chocolatey installation failed with exit code: $LASTEXITCODE" -ForegroundColor Yellow
                }
              } else {
                Write-Host "Chocolatey not found on system" -ForegroundColor Yellow
              }
            } catch {
              Write-Host "Chocolatey installation failed: $_" -ForegroundColor Yellow
            }
            
            # Fallback to Winget if Chocolatey failed
            if (-not $innoPath) {
              Write-Host ""
              Write-Host "Attempting installation via Winget..." -ForegroundColor Cyan
              try {
                $wingetInstalled = Get-Command winget -ErrorAction SilentlyContinue
                if ($wingetInstalled) {
                  Write-Host "Winget found. Installing Inno Setup..."
                  winget install --id JRSoftware.InnoSetup --silent --accept-source-agreements --accept-package-agreements
                  
                  if ($LASTEXITCODE -eq 0) {
                    Write-Host "Inno Setup installed successfully via Winget" -ForegroundColor Green
                    
                    # Verify installation
                    foreach ($path in $innoSetupPaths) {
                      if (Test-Path $path) {
                        $innoPath = $path
                        break
                      }
                    }
                  } else {
                    Write-Host "Winget installation failed with exit code: $LASTEXITCODE" -ForegroundColor Yellow
                  }
                } else {
                  Write-Host "Winget not found on system" -ForegroundColor Yellow
                }
              } catch {
                Write-Host "Winget installation failed: $_" -ForegroundColor Yellow
              }
            }
            
            # Final check
            if (-not $innoPath) {
              Write-Host "::error::Failed to install Inno Setup via Chocolatey or Winget"
              Write-Host ""
              Write-Host "Manual installation options:" -ForegroundColor Yellow
              Write-Host "1. Chocolatey: choco install innosetup -y"
              Write-Host "2. Winget: winget install JRSoftware.InnoSetup"
              Write-Host "3. Direct download: https://jrsoftware.org/isdl.php"
              exit 1
            }
          }

          Write-Host ""
          Write-Host "::notice::Inno Setup installation verified successfully" -ForegroundColor Green
          Write-Host "::endgroup::"
        shell: powershell

      - name: Detect Inno Setup path and set environment variable
        if: matrix.platform == 'windows'
        run: |
          Write-Host "::group::Detecting Inno Setup path" -ForegroundColor Green
          Write-Host "=== Detecting Inno Setup Installation Path ===" -ForegroundColor Green
          Write-Host ""

          $innoSetupPaths = @(
            "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe",
            "${env:ProgramFiles}\Inno Setup 6\ISCC.exe",
            "${env:ProgramFiles(x86)}\Inno Setup 5\ISCC.exe",
            "${env:ProgramFiles}\Inno Setup 5\ISCC.exe"
          )

          $innoPath = $null
          foreach ($path in $innoSetupPaths) {
            if (Test-Path $path) {
              $innoPath = $path
              Write-Host "Inno Setup found at: $innoPath" -ForegroundColor Green
              break
            }
          }

          if ($innoPath) {
            echo "INNO_SETUP_PATH=$innoPath" >> $env:GITHUB_ENV
            Write-Host "Environment variable INNO_SETUP_PATH set to: $innoPath"
          } else {
            Write-Host "::error::Inno Setup not found even after installation attempt"
            exit 1
          }

          Write-Host "::endgroup::"
        shell: powershell

      - name: Create Windows Installer
        if: matrix.platform == 'windows'
        run: |
          Write-Host "::group::Creating Windows Installer" -ForegroundColor Green
          Write-Host "=== Creating Windows Installer ===" -ForegroundColor Green
          Write-Host ""

          $issFile = "installers/windows/inno_setup.iss"
          if (-not (Test-Path $issFile)) {
            Write-Host "::error::Inno Setup script not found: $issFile"
            exit 1
          }

          Write-Host "Compiling Inno Setup script..." -ForegroundColor Cyan
          & "${env:INNO_SETUP_PATH}" "$issFile"

          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Inno Setup compilation failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host ""
          Write-Host "::notice::Windows installer created successfully" -ForegroundColor Green
          Write-Host "::endgroup::"
        shell: powershell

      - name: Create Portable Package (Windows)
        if: matrix.platform == 'windows'
        run: |
          Write-Host "::group::Creating Portable Package" -ForegroundColor Green
          Write-Host "=== Creating Portable Package ===" -ForegroundColor Green
          Write-Host ""

          $buildPath = "build\windows\x64\runner\Release"
          $version = "${{ needs.version-info.outputs.version }}"
          $zipName = "CloudToLocalLLM-Windows-Portable-$version.zip"

          Write-Host "Compressing build output to $zipName..." -ForegroundColor Cyan
          Compress-Archive -Path "$buildPath\*" -DestinationPath $zipName -Force

          if (Test-Path $zipName) {
            $size = (Get-Item $zipName).Length / 1MB
            Write-Host "Portable package created: $zipName ({0:N2} MB)" -f $size
          } else {
            Write-Host "::error::Failed to create portable package"
            exit 1
          }

          Write-Host ""
          Write-Host "::notice::Portable package created successfully" -ForegroundColor Green
          Write-Host "::endgroup::"
        shell: powershell

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            build/windows/x64/runner/Release/*
            build/linux/x64/release/bundle/*
            build/app/outputs/flutter-apk/*
            *.zip
            Output/*.exe
          if-no-files-found: warn

  # Create GitHub Release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [version-info, build-desktop]
    if: needs.version-info.outputs.is_release == 'true'
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Display downloaded artifacts
        run: |
          echo "::group::Downloaded Artifacts"
          ls -R
          echo "::endgroup::"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.version-info.outputs.tag_name }}
          name: ${{ needs.version-info.outputs.release_name }}
          draft: false
          prerelease: false
          files: |
            windows-desktop/*.zip
            windows-desktop/Output/*.exe
            linux-desktop/*
            android-apk/*
          generate_release_notes: true
