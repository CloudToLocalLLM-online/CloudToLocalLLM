name: Purge Cloudflare Cache

on:
    workflow_dispatch:

jobs:
    purge:
        runs-on: ubuntu-latest
        steps:
            - name: Purge Cache via API
              env:
                  CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  # We'll try to dynamically fetch the zone ID for the domain
                  DOMAIN: "cloudtolocalllm.online"
              run: |
                  if [ -z "$CF_API_TOKEN" ]; then
                    echo "::error::CLOUDFLARE_API_TOKEN secret is missing"
                    exit 1
                  fi

                  echo "Fetching Zone ID for $DOMAIN..."
                  ZONE_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=$DOMAIN" \
                    -H "Authorization: Bearer $CF_API_TOKEN" \
                    -H "Content-Type: application/json" | jq -r '.result[0].id')

                  if [ -z "$ZONE_ID" ] || [ "$ZONE_ID" == "null" ]; then
                    echo "::error::Failed to find Zone ID for $DOMAIN"
                    exit 1
                  fi

                  echo "Found Zone ID: $ZONE_ID. Purging cache..."

                  RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/purge_cache" \
                    -H "Authorization: Bearer $CF_API_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d '{"purge_everything":true}')
                    
                  echo "Response: $RESPONSE"

                  SUCCESS=$(echo $RESPONSE | jq -r '.success')
                  if [ "$SUCCESS" == "true" ]; then
                    echo "âœ… Cache purged successfully"
                  else
                    echo "::error::Failed to purge cache"
                    exit 1
                  fi
