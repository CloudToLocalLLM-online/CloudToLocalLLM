name: Version Analysis & Platform Distribution

on:
  push:
    branches:
      - main
    # Don't trigger on version bump commits or platform branch merges
  workflow_dispatch:

# Prevent multiple version bumps running simultaneously
concurrency:
  group: version-distribution
  cancel-in-progress: false

jobs:
  analyze_and_distribute:
    if: "${{ !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[no-version]') }}"
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 50
          fetch-tags: true
          token: "${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Cache Ollama
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/bin/ollama
            ~/.ollama
          key: ollama-${{ runner.os }}-v1

      - name: Setup Ollama
        run: |
          # Install Ollama if not cached
          if [ ! -f /usr/local/bin/ollama ]; then
            curl -fsSL https://ollama.ai/install.sh | sh
          fi
          
          # Start Ollama server
          ollama serve &
          sleep 5
          
          # Pull model if not cached
          if ! ollama list | grep -q "llama3.2:1b"; then
            ollama pull llama3.2:1b
          fi

      - name: Setup Kilocode CLI
        run: |
          chmod +x scripts/kilocode-cli.cjs
          sudo ln -sf "$(pwd)/scripts/kilocode-cli.cjs" /usr/local/bin/kilocode-cli

          kilocode-cli "Respond with just OK" && echo "âœ… Kilocode CLI test passed" || echo "âš ï¸  Kilocode test failed"
          echo "âœ… Kilocode CLI ready"

      - name: Install jq
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          jq --version

      - name: Analyze Changes with Kilocode
        id: analyze
        run: |
          chmod +x scripts/analyze-platforms.sh
          ./scripts/analyze-platforms.sh

      - name: Update Version Files
        env:
          NEW_VERSION: "${{ steps.analyze.outputs.new_version }}"
          COMMIT_SHA: "${{ github.sha }}"
        run: |
          chmod +x scripts/update-all-versions.sh
          ./scripts/update-all-versions.sh "$NEW_VERSION" "$COMMIT_SHA"

      - name: Commit and Push to Platform Branches
        env:
          NEW_VERSION: "${{ steps.analyze.outputs.new_version }}"
          NEEDS_CLOUD: "${{ steps.analyze.outputs.needs_cloud }}"
          NEEDS_DESKTOP: "${{ steps.analyze.outputs.needs_desktop }}"
          NEEDS_MOBILE: "${{ steps.analyze.outputs.needs_mobile }}"
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)

          # Commit version changes to main
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
            git push origin main
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Platform Distribution for v$NEW_VERSION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Push to cloud branch
          echo "â˜ï¸  Pushing to cloud branch..."
          git checkout -B cloud
          git push -f origin cloud
          git tag "${NEW_VERSION}-cloud-${SHORT_SHA}" -f
          git push origin "${NEW_VERSION}-cloud-${SHORT_SHA}" -f
          echo "âœ… Cloud: v${NEW_VERSION}-cloud-${SHORT_SHA}"

          # Push to desktop branch
          echo "ğŸ–¥ï¸  Pushing to desktop branch..."
          git checkout -B desktop main
          git push -f origin desktop
          git tag "${NEW_VERSION}-desktop-${SHORT_SHA}" -f
          git push origin "${NEW_VERSION}-desktop-${SHORT_SHA}" -f
          echo "âœ… Desktop: v${NEW_VERSION}-desktop-${SHORT_SHA}"

          # Push to mobile branch
          echo "ğŸ“± Pushing to mobile branch..."
          git checkout -B mobile main
          git push -f origin mobile
          git tag "${NEW_VERSION}-mobile-${SHORT_SHA}" -f
          git push origin "${NEW_VERSION}-mobile-${SHORT_SHA}" -f
          echo "âœ… Mobile: v${NEW_VERSION}-mobile-${SHORT_SHA}"

          # Return to main
          git checkout main

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Version $NEW_VERSION distributed to platforms"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"