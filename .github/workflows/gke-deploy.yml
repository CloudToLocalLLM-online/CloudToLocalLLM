name: Deploy to GKE

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: gke-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-flutter:
    name: Run Flutter Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run Flutter tests
        run: flutter test

      - name: Run Flutter static analysis
        run: flutter analyze --fatal-infos --fatal-warnings

  test-node-api:
    name: Run Node.js API Tests
    runs-on: ubuntu-latest
    continue-on-error: true # Allow workflow to continue even if this job fails
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache Node.js modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install API backend dependencies
        run: npm ci
        working-directory: services/api-backend

      - name: Run API backend tests
        run: npm test
        working-directory: services/api-backend

      - name: Run API backend linting
        run: npm run lint
        working-directory: services/api-backend

  warn-on-node-api-test-failure:
    name: Warn on Node.js API Test Failure
    runs-on: ubuntu-latest
    needs: [test-node-api]
    if: ${{ failure() && needs.test-node-api.result == 'failure' }}
    steps:
      - name: Report Failure
        run: |
          echo "## âš ï¸ Node.js API Tests Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Node.js API tests failed. This job is configured to not block deployment, but the tests should be investigated." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [Node.js API Tests job logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs/${{ needs.test-node-api.id }}) for details." >> $GITHUB_STEP_SUMMARY

  deploy-web:
    name: Deploy Web to GKE
    runs-on: ubuntu-latest
    needs: [test-flutter]
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ vars.WIF_PROVIDER }}'
          service_account: '${{ vars.WIF_SERVICE_ACCOUNT }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: 'cloudtolocalllm-us-central1'
          location: 'us-central1'

      - name: 'Build and Push Container'
        run: |
          gcloud builds submit --async --tag "gcr.io/${{ vars.GCP_PROJECT_ID }}/web:latest" web --build-arg BUILDKIT_INLINE_CACHE=1 -f web/Dockerfile

      - name: 'Deploy to GKE'
        run: |
          kubectl apply -f web/k8s/deployment.yaml
          kubectl apply -f web/k8s/service.yaml
          kubectl apply -f web/k8s/ingress.yaml

  deploy-api:
    name: Deploy API Backend to GKE
    runs-on: ubuntu-latest
    needs: [test-flutter]
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ vars.WIF_PROVIDER }}'
          service_account: '${{ vars.WIF_SERVICE_ACCOUNT }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: 'cloudtolocalllm-us-central1'
          location: 'us-central1'

      - name: 'Build and Push Container'
        run: |
          gcloud builds submit --async --tag "gcr.io/${{ vars.GCP_PROJECT_ID }}/api-backend:latest" services/api-backend -f services/api-backend/Dockerfile

      - name: 'Deploy to GKE'
        run: |
          kubectl apply -f services/api-backend/k8s/deployment.yaml
          kubectl apply -f services/api-backend/k8s/service.yaml
          kubectl apply -f services/api-backend/k8s/ingress.yaml

  deploy-streaming:
    name: Deploy Streaming Proxy to GKE
    runs-on: ubuntu-latest
    needs: [test-flutter]
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ vars.WIF_PROVIDER }}'
          service_account: '${{ vars.WIF_SERVICE_ACCOUNT }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: 'cloudtolocalllm-us-central1'
          location: 'us-central1'

      - name: 'Build and Push Container'
        run: |
          gcloud builds submit --async --tag "gcr.io/${{ vars.GCP_PROJECT_ID }}/streaming-proxy:latest" services/streaming-proxy -f services/streaming-proxy/Dockerfile

      - name: 'Deploy to GKE'
        run: |
          kubectl apply -f services/streaming-proxy/k8s/deployment.yaml
          kubectl apply -f services/streaming-proxy/k8s/service.yaml
          kubectl apply -f services/streaming-proxy/k8s/ingress.yaml

  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-api, deploy-streaming]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies for validation
        run: |
          npm install -g wscat
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Run deployment validation
        env:
          API_BASE_URL: https://api.cloudtolocalllm.online # Replace with actual deployed URL or dynamic retrieval
          TEST_JWT_TOKEN: ${{ secrets.TEST_JWT_TOKEN }}
          TEST_USER_ID: ${{ secrets.TEST_USER_ID }}
        run: |
          chmod +x ./scripts/deploy/run_tunnel_validation.sh
          ./scripts/deploy/run_tunnel_validation.sh

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-results
          path: /tmp/tunnel-validation-*/

  k6-smoke-test:
    name: k6 Smoke Test
    runs-on: ubuntu-latest
    needs: [validate-deployment]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run k6 smoke test
        run: |
          export K6_CLOUD_TOKEN=${{ secrets.K6_CLOUD_TOKEN }}
          k6 run --env API_BASE_URL=https://api.cloudtolocalllm.online test/k6/smoke-test.js

  rollback-on-failure:
    name: Rollback on Validation Failure
    runs-on: ubuntu-latest
    needs: [validate-deployment]
    if: failure() && github.event_name == 'push' # Only rollback on push failures
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ vars.WIF_PROVIDER }}'
          service_account: '${{ vars.WIF_SERVICE_ACCOUNT }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: 'cloudtolocalllm-us-central1'
          location: 'us-central1'

      - name: Rollback Web Service
        run: kubectl rollout undo deployment/web

      - name: Rollback API Service
        run: kubectl rollout undo deployment/api-backend

      - name: Rollback Streaming Service
        run: kubectl rollout undo deployment/streaming-proxy

      - name: Notify Rollback
        run: |
          echo "## ðŸš¨ Automated Rollback Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment validation failed. An automated rollback to the previous stable version has been performed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY