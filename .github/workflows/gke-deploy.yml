name: Deploy to GKE

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: gke-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-web:
    name: Deploy Web to GKE
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ vars.WIF_PROVIDER }}'
          service_account: '${{ vars.WIF_SERVICE_ACCOUNT }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: 'cloudtolocalllm-us-central1'
          location: 'us-central1'

      - name: 'Build and Push Container'
        run: |
          gcloud auth configure-docker gcr.io -q
          docker build -t "gcr.io/${{ vars.GCP_PROJECT_ID }}/web:${{ github.sha }}" web
          docker push "gcr.io/${{ vars.GCP_PROJECT_ID }}/web:${{ github.sha }}"

      - name: 'Resolve image digest'
        id: digest_web
        run: |
          DIGEST=$(gcloud container images list-tags gcr.io/${{ vars.GCP_PROJECT_ID }}/web --filter="tags:${{ github.sha }}" --format='get(digest)')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: 'Deploy to GKE'
        run: |
          kubectl apply -f web/k8s/deployment.yaml
          kubectl apply -f web/k8s/service.yaml
          kubectl apply -f web/k8s/ingress.yaml
          kubectl -n cloudtolocalllm set image deployment/web web=gcr.io/${{ vars.GCP_PROJECT_ID }}/web@${{ steps.digest_web.outputs.digest }}

  deploy-api:
    name: Deploy API Backend to GKE
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ vars.WIF_PROVIDER }}'
          service_account: '${{ vars.WIF_SERVICE_ACCOUNT }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: 'cloudtolocalllm-us-central1'
          location: 'us-central1'

      - name: 'Build and Push Container'
        run: |
          gcloud auth configure-docker gcr.io -q
          docker build -t "gcr.io/${{ vars.GCP_PROJECT_ID }}/api-backend:${{ github.sha }}" services/api-backend
          docker push "gcr.io/${{ vars.GCP_PROJECT_ID }}/api-backend:${{ github.sha }}"

      - name: 'Resolve image digest'
        id: digest_api
        run: |
          DIGEST=$(gcloud container images list-tags gcr.io/${{ vars.GCP_PROJECT_ID }}/api-backend --filter="tags:${{ github.sha }}" --format='get(digest)')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: 'Ensure API secrets exist'
        run: |
          kubectl create namespace cloudtolocalllm --dry-run=client -o yaml | kubectl apply -f -
          kubectl -n cloudtolocalllm create secret generic api-secrets \
            --from-literal=db-password="${{ secrets.DB_PASSWORD }}" \
            --from-literal=jwt-secret="${{ secrets.JWT_SECRET }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: 'Deploy to GKE'
        run: |
          kubectl apply -f services/api-backend/k8s/deployment.yaml
          kubectl apply -f services/api-backend/k8s/service.yaml
          kubectl apply -f services/api-backend/k8s/ingress.yaml
          kubectl -n cloudtolocalllm set image deployment/api-backend api-backend=gcr.io/${{ vars.GCP_PROJECT_ID }}/api-backend@${{ steps.digest_api.outputs.digest }}

  deploy-streaming:
    name: Deploy Streaming Proxy to GKE
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ vars.WIF_PROVIDER }}'
          service_account: '${{ vars.WIF_SERVICE_ACCOUNT }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: 'cloudtolocalllm-us-central1'
          location: 'us-central1'

      - name: 'Build and Push Container'
        run: |
          gcloud auth configure-docker gcr.io -q
          docker build -t "gcr.io/${{ vars.GCP_PROJECT_ID }}/streaming-proxy:${{ github.sha }}" services/streaming-proxy
          docker push "gcr.io/${{ vars.GCP_PROJECT_ID }}/streaming-proxy:${{ github.sha }}"

      - name: 'Resolve image digest'
        id: digest_stream
        run: |
          DIGEST=$(gcloud container images list-tags gcr.io/${{ vars.GCP_PROJECT_ID }}/streaming-proxy --filter="tags:${{ github.sha }}" --format='get(digest)')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: 'Deploy to GKE'
        run: |
          kubectl apply -f services/streaming-proxy/k8s/deployment.yaml
          kubectl apply -f services/streaming-proxy/k8s/service.yaml
          kubectl apply -f services/streaming-proxy/k8s/ingress.yaml
          kubectl -n cloudtolocalllm set image deployment/streaming-proxy streaming-proxy=gcr.io/${{ vars.GCP_PROJECT_ID }}/streaming-proxy@${{ steps.digest_stream.outputs.digest }}

  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-api, deploy-streaming]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies for validation
        run: |
          npm install -g wscat
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Run deployment validation
        env:
          API_BASE_URL: https://api.cloudtolocalllm.online # Replace with actual deployed URL or dynamic retrieval
          TEST_JWT_TOKEN: ${{ secrets.TEST_JWT_TOKEN }}
          TEST_USER_ID: ${{ secrets.TEST_USER_ID }}
        run: |
          chmod +x ./scripts/deploy/run_tunnel_validation.sh
          ./scripts/deploy/run_tunnel_validation.sh

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-results
          path: /tmp/tunnel-validation-*/

  k6-smoke-test:
    name: k6 Smoke Test
    runs-on: ubuntu-latest
    needs: [validate-deployment]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run k6 smoke test
        run: |
          export K6_CLOUD_TOKEN=${{ secrets.K6_CLOUD_TOKEN }}
          k6 run --env API_BASE_URL: https://api.cloudtolocalllm.online test/k6/smoke-test.js

  rollback-on-failure:
    name: Rollback on Validation Failure
    runs-on: ubuntu-latest
    needs: [validate-deployment]
    if: failure() && github.event_name == 'push' # Only rollback on push failures
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ vars.WIF_PROVIDER }}'
          service_account: '${{ vars.WIF_SERVICE_ACCOUNT }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: 'cloudtolocalllm-us-central1'
          location: 'us-central1'

      - name: Rollback Web Service
        run: kubectl rollout undo deployment/web

      - name: Rollback API Service
        run: kubectl rollout undo deployment/api-backend

      - name: Rollback Streaming Service
        run: kubectl rollout undo deployment/streaming-proxy

      - name: Notify Rollback
        run: |
          echo "## ðŸš¨ Automated Rollback Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment validation failed. An automated rollback to the previous stable version has been performed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY