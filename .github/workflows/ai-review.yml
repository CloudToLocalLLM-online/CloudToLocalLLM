name: "üîé AI Code Review"

on:
  workflow_call:
    inputs:
      additional_context:
        type: "string"
        description: "Any additional context from the request"
        required: false

concurrency:
  group: "${{ github.workflow }}-review-${{ github.event_name }}-${{ github.event.pull_request.number || github.event.issue.number }}"
  cancel-in-progress: true

defaults:
  run:
    shell: "bash"

env:
  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

jobs:
  review:
    runs-on: "blacksmith-4vcpu-ubuntu-2404"
    timeout-minutes: 7
    permissions:
      contents: "read"
      id-token: "write"
      issues: "write"
      pull-requests: "write"
    steps:
      - name: "Mint identity token"
        id: "mint_identity_token"
        if: |-
          ${{ vars.APP_ID }}
        uses: "actions/create-github-app-token@a8d616148505b5069dccd32f177bb87d7f39123b" # ratchet:actions/create-github-app-token@v2
        with:
          app-id: "${{ vars.APP_ID }}"
          private-key: "${{ secrets.APP_PRIVATE_KEY }}"
          permission-contents: "read"
          permission-issues: "write"
          permission-pull-requests: "write"

      - name: "Checkout repository"
        uses: "actions/checkout@v6"
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "Run AI pull request review"
        id: "ai_pr_review"
        env:
          GEMINI_API_KEY: "${{ secrets.GEMINI_API_KEY }}"
          GITHUB_TOKEN: "${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}"
          ISSUE_TITLE: "${{ github.event.pull_request.title || github.event.issue.title }}"
          ISSUE_BODY: "${{ github.event.pull_request.body || github.event.issue.body }}"
          ADDITIONAL_CONTEXT: "${{ inputs.additional_context }}"
        run: |
          mkdir -p .ai-agent
          cat > .ai-agent/settings.json <<EOF
          {
            "model": { "maxSessionTurns": 25 },
            "output": { "format": "json" },
            "mcpServers": {
              "github": {
                "command": "docker",
                "args": [
                  "run", "-i", "--rm",
                  "-e", "GITHUB_PERSONAL_ACCESS_TOKEN",
                  "ghcr.io/github/github-mcp-server:v0.18.0"
                ],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "$GITHUB_TOKEN"
                }
              }
            }
          }
          EOF
          echo "üîÑ Starting AI PR review..."
          
          # Ensure local gemini CLI is usable
          if [ -f scripts/gemini-cli.cjs ]; then
            chmod +x scripts/gemini-cli.cjs
            sudo ln -sf "$(pwd)/scripts/gemini-cli.cjs" /usr/local/bin/gemini
          fi

          TITLE_ESCAPED=$(echo "$ISSUE_TITLE" | sed 's/\"/\\\\\"/g')
          BODY_ESCAPED=$(echo "$ISSUE_BODY" | sed 's/\"/\\\\\"/g')
          CONTEXT_ESCAPED=$(echo "$ADDITIONAL_CONTEXT" | sed 's/\"/\\\\\"/g')
          if ! gemini "Please review this pull request. Title: $TITLE_ESCAPED. Body: $BODY_ESCAPED. Context: $CONTEXT_ESCAPED." > raw_output.json 2> ai_error.log; then
            echo "::error::AI Agent CLI failed"
            echo "üìù Error details:"
            cat ai_error.log
            echo "::group::Debug Information"
            echo "Environment:"
            env | sort
            echo "::endgroup::"
            exit 1
          fi
          echo "‚úÖ AI PR review completed successfully"
