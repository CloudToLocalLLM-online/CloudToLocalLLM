name: Purge Cloudflare Cache

on:
    workflow_dispatch:

jobs:
    purge-cache:
        runs-on: ubuntu-latest
        steps:
            - name: Purge Cache
              uses: cloudflare/wrangler-action@v3
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  command: kv:key delete --binding=--all # WRONG COMMAND.

            - name: Install Wrangler
              run: npm install -g wrangler

            - name: Purge Zone Cache
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
              run: |
                  # If zone ID is not in secrets, try to find it or just ask user to provide it as input
                  if [ -z "$CLOUDFLARE_ZONE_ID" ]; then
                     echo "Zone ID not found in secrets. Listing zones..."
                     wrangler zone list || echo "Failed to list zones"
                  fi

                  echo "Purging everything..."
                  # Using curl is often more reliable for simple purge if wrangler config is missing
                  # But let's try to use wrangler if possible, or curl.

                  # We need the Zone ID.
                  # Let's assume the user has the Zone ID in secrets or we can find it.

                  # curl -X POST "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/purge_cache" \
                  #     -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                  #     -H "Content-Type: application/json" \
                  #     -d '{"purge_everything":true}'
