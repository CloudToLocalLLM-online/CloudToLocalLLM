# cert-manager ClusterIssuer using Azure DNS-01 challenge
# This uses Azure DNS for domain validation via Azure DNS zone
# Certificates are stored in Kubernetes secrets and automatically renewed
#
# Prerequisites:
# 1. Azure DNS zone: cloudtolocalllm.online
# 2. Service Principal with DNS Zone Contributor role on the DNS zone
# 3. Create Kubernetes secret with Azure credentials (use GitHub secrets in workflow):
#    kubectl create secret generic azure-dns-config \
#      --from-literal=client-id=<AZURE_CLIENT_ID> \
#      --from-literal=client-secret=<AZURE_CLIENT_SECRET> \
#      --from-literal=subscription-id=<AZURE_SUBSCRIPTION_ID> \
#      --from-literal=tenant-id=<AZURE_TENANT_ID> \
#      -n cert-manager
#
# Note: The workflow will create this secret automatically from GitHub secrets

apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: azure-dns-prod
spec:
  acme:
    # ACME protocol server (required for certificate issuance)
    # Domain validation uses Azure DNS-01 challenge
    server: https://acme-v02.api.letsencrypt.org/directory
    
    email: admin@cloudtolocalllm.online
    
    privateKeySecretRef:
      name: azure-dns-prod-key
    
    # Use DNS-01 challenge with Azure DNS for domain validation
    # This leverages Azure DNS zone for validation, making it Azure-native
    solvers:
      - dns01:
          azuredns:
            # Azure service principal credentials from secret
            # These will be populated from GitHub secrets in the workflow
            clientID: <AZURE_CLIENT_ID>
            clientSecretSecretRef:
              name: azure-dns-config
              key: client-secret
            subscriptionID: <AZURE_SUBSCRIPTION_ID>
            tenantID: <AZURE_TENANT_ID>
            resourceGroupName: cloudtolocalllm-rg
            hostedZoneName: cloudtolocalllm.online
            environment: AzurePublicCloud
---
# Staging ClusterIssuer for testing wildcard certificate setup
# Use this first to test the configuration before switching to production
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: azure-dns-staging
spec:
  acme:
    # Let's Encrypt staging server (for testing - no rate limits)
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    
    email: admin@cloudtolocalllm.online
    
    privateKeySecretRef:
      name: azure-dns-staging-key
    
    # Use DNS-01 challenge with Azure DNS for domain validation
    solvers:
      - dns01:
          azuredns:
            clientID: <AZURE_CLIENT_ID>
            clientSecretSecretRef:
              name: azure-dns-config
              key: client-secret
            subscriptionID: <AZURE_SUBSCRIPTION_ID>
            tenantID: <AZURE_TENANT_ID>
            resourceGroupName: cloudtolocalllm-rg
            hostedZoneName: cloudtolocalllm.online
            environment: AzurePublicCloud

