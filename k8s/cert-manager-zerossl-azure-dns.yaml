# cert-manager ClusterIssuer using ZeroSSL with Azure DNS-01 challenge
# ZeroSSL offers free SSL certificates with ACME automation
#
# Benefits:
# - Free SSL certificates
# - 90-day certificate validity
# - Higher rate limits than Let's Encrypt
# - Wildcard certificate support
# - Works with existing Azure DNS setup
#
# Prerequisites:
# 1. ZeroSSL account: https://zerossl.com (sign up for free)
# 2. Create ACME account in ZeroSSL dashboard
# 3. Get EAB (External Account Binding) credentials:
#    - Key ID
#    - Key Secret
# 4. Create Kubernetes secret: kubectl create secret generic zerossl-eab-secret --from-literal=key-secret=<EAB_KEY_SECRET> -n cert-manager
# 5. Azure DNS zone: cloudtolocalllm.online
# 6. Service Principal with DNS Zone Contributor role on the DNS zone
# 7. Kubernetes secret: azure-dns-config (already exists from main setup)

apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: zerossl-prod
spec:
  acme:
    # ZeroSSL ACME server (DV90 = Domain Validated, 90-day certificates)
    server: https://acme.zerossl.com/v2/DV90
    email: admin@cloudtolocalllm.online
    
    # External Account Binding (EAB) required by ZeroSSL for automation
    # Get these credentials from ZeroSSL dashboard after creating ACME account
    externalAccountBinding:
      keyID: <ZEROSSL_EAB_KEY_ID>  # Replace with your EAB Key ID from ZeroSSL dashboard
      keySecretRef:
        name: zerossl-eab-secret
        key: key-secret
      keyAlgorithm: HS256
    
    privateKeySecretRef:
      name: zerossl-prod-key
    
    # Use DNS-01 challenge with Azure DNS for domain validation
    solvers:
      - dns01:
          azureDNS:
            # Azure service principal credentials from existing secret
            # The secret contains: client-id, client-secret, subscription-id, tenant-id
            clientID: <AZURE_CLIENT_ID>  # Replace in workflow or manually
            clientSecretSecretRef:
              name: azure-dns-config
              key: client-secret
            subscriptionID: <AZURE_SUBSCRIPTION_ID>  # Replace in workflow or manually
            tenantID: <AZURE_TENANT_ID>  # Replace in workflow or manually
            resourceGroupName: cloudtolocalllm-rg
            hostedZoneName: cloudtolocalllm.online
            environment: AzurePublicCloud

