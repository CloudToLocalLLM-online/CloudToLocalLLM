apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # Infrastructure
  - base/namespace.yaml
  - base/rbac.yaml
  - base/network-policies.yaml
  
  # Configuration
  - base/configmaps/main-config.yaml
  - base/configmaps/redis.yaml
  
  # Services
  - base/services/postgres.yaml
  - base/services/redis.yaml
  - base/services/api-backend.yaml
  - base/services/web.yaml
  - base/services/streaming-proxy.yaml
  
  # Deployments
  - base/deployments/postgres.yaml
  - base/deployments/redis.yaml
  - base/deployments/api-backend.yaml
  - base/deployments/web.yaml
  - base/deployments/streaming-proxy.yaml
  
  # Utilities & Add-ons
  - base/alertmanager-config.yaml
  - base/prometheus-config.yaml
  - base/utilities/monitoring.yaml
  - base/utilities/blackbox-exporter.yaml
  - base/utilities/coturn.yaml
  - base/postgres-auth-statefulset.yaml
  
  # Cloudflared Tunnel
  - overlays/managed/cloudflared-tunnel.yaml

images:
  - name: imrightguycloudtolocalllm.azurecr.io/api-backend
    newTag: 7.10.9-202512190353-api-backend
  - name: imrightguycloudtolocalllm.azurecr.io/web
    newTag: 7.10.9-202512190353

patches:
  # API Backend Patches
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: api-backend
        namespace: cloudtolocalllm
      spec:
        template:
          spec:
            containers:
              - name: api-backend
                env:
                  - name: APP_MODE
                    value: "local"
                  - name: ENABLE_BILLING
                    value: "false"
                  - name: ENABLE_MULTI_TENANCY
                    value: "false"
                  - name: ADMIN_CENTER_ENABLED
                    value: "true"
                  - name: ENABLE_ADMIN_PAYMENTS
                    value: "false"
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: api-backend
        namespace: cloudtolocalllm
      spec:
        replicas: 1
        template:
          spec:
            containers:
              - name: api-backend
                resources:
                  requests:
                    memory: "128Mi"
                    cpu: "100m"
                  limits:
                    memory: "512Mi"
                    cpu: "250m"
  
  # Web Patches
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: web
        namespace: cloudtolocalllm
      spec:
        replicas: 1
        template:
          spec:
            containers:
              - name: web
                resources:
                  requests:
                    memory: "128Mi"
                    cpu: "10m"
                  limits:
                    memory: "256Mi"
                    cpu: "250m"

  # Storage Patches
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: postgres
        namespace: cloudtolocalllm
      spec:
        volumeClaimTemplates:
        - metadata:
            name: postgres-data
          spec:
            accessModes: ["ReadWriteOnce"]
            storageClassName: default
            resources:
              requests:
                storage: 10Gi
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: redis-tunnel-state
        namespace: cloudtolocalllm
      spec:
        volumeClaimTemplates:
        - metadata:
            name: redis-data
          spec:
            accessModes: ["ReadWriteOnce"]
            storageClassName: default
            resources:
              requests:
                storage: 1Gi

