apiVersion: batch/v1
kind: Job
metadata:
  name: cloudflare-cache-purge
  namespace: cloudtolocalllm
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      containers:
        - name: purge-cache
          image: alpine:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              apk add --no-cache curl grep
              # The script is assumed to be mounted or we can inline the logic for simplicity
              # Given we have the script in the repo, we could build an image or use a configmap
              # For now, we'll inline the core curl command from scripts/cloudflare-cache-purge.sh
              echo "Starting Cloudflare cache purge..."

              if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
                echo "‚ùå Error: CLOUDFLARE_API_TOKEN is not configured. Skipping purge (deployment may serve stale cache)."
                # We exit 0 here to not block the deployment if the user hasn't set up CF yet,
                # BUT we remove optional: true below to ensure that IF it's in the secret, it must work.
                # Actually, if we want it to be mandatory, we should exit 1.
                # User said "cloudflare need to be cleared for sure", so let's make it mandatory.
                exit 1
              fi

              # Fetch Zone ID if not provided
              if [ -z "$CLOUDFLARE_ZONE_ID" ]; then
                echo "üîç Fetching Zone ID for $DOMAIN..."
                ZONE_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=$DOMAIN" \
                  -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
                  -H "Content-Type: application/json" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
              else
                ZONE_ID=$CLOUDFLARE_ZONE_ID
              fi

              if [ -z "$ZONE_ID" ]; then
                echo "‚ùå Error: Could not retrieve Zone ID for $DOMAIN. Verify your API token permissions."
                exit 1
              fi

              echo "üöÄ Purging everything for Zone: $ZONE_ID ($DOMAIN)"
              RESPONSE=$(curl -s -X POST \
                "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/purge_cache" \
                -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                -H "Content-Type: application/json" \
                --data '{"purge_everything": true}')

              SUCCESS=$(echo "$RESPONSE" | grep -o '"success":true')

              if [ -n "$SUCCESS" ]; then
                echo "‚úÖ Successfully purged Cloudflare cache"
              else
                echo "‚ùå Failed to purge cache!"
                echo "Response: $RESPONSE"
                exit 1
              fi
          env:
            - name: DOMAIN
              valueFrom:
                configMapKeyRef:
                  name: cloudtolocalllm-config
                  key: DOMAIN
            - name: CLOUDFLARE_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: cloudflare-cache-secrets
                  key: api-token
      restartPolicy: Never
  backoffLimit: 2
