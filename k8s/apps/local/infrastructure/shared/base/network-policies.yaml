---
# Default deny all ingress traffic in cloudtolocalllm namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: cloudtolocalllm
  labels:
    app: network-policy
    policy: default-deny
spec:
  podSelector: {}
  policyTypes:
    - Ingress

---
# Default deny all egress traffic in cloudtolocalllm namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: cloudtolocalllm
  labels:
    app: network-policy
    policy: default-deny
spec:
  podSelector: {}
  policyTypes:
    - Egress

---
# Allow DNS egress for all pods (required for service discovery)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: cloudtolocalllm
  labels:
    app: network-policy
    policy: allow-dns
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries to kube-dns
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# Allow ingress to web application from Ingress controller
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-web-app-ingress
  namespace: cloudtolocalllm
  labels:
    app: web
    policy: allow-ingress
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
    - Ingress
  ingress:
    # Allow from Ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080
    # Also allow from Cloudflared
    - from:
        - podSelector:
            matchLabels:
              app: cloudflared
      ports:
        - protocol: TCP
          port: 8080

---
# Allow ingress to API backend from Ingress controller and other services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-backend-ingress
  namespace: cloudtolocalllm
  labels:
    app: api-backend
    policy: allow-ingress
spec:
  podSelector:
    matchLabels:
      app: api-backend
  policyTypes:
    - Ingress
  ingress:
    # Allow from Ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080
    # Allow from Cloudflared
    - from:
        - podSelector:
            matchLabels:
              app: cloudflared
      ports:
        - protocol: TCP
          port: 8080
    # Allow from Web app
    - from:
        - podSelector:
            matchLabels:
              app: web
      ports:
        - protocol: TCP
          port: 8080
    # Allow from Streaming Proxy
    - from:
        - podSelector:
            matchLabels:
              app: streaming-proxy
      ports:
        - protocol: TCP
          port: 8080

---
# Allow web app to communicate with API backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-web-to-api
  namespace: cloudtolocalllm
  labels:
    app: web
    policy: allow-egress
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
    - Egress
  egress:
    # Allow to API backend
    - to:
        - podSelector:
            matchLabels:
              app: api-backend
      ports:
        - protocol: TCP
          port: 8080
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# Allow API backend to communicate with PostgreSQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-to-postgres
  namespace: cloudtolocalllm
  labels:
    app: api-backend
    policy: allow-egress
spec:
  podSelector:
    matchLabels:
      app: api-backend
  policyTypes:
    - Egress
  egress:
    # Allow to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow to PostgreSQL Auth
    - to:
        - podSelector:
            matchLabels:
              app: postgres-auth
      ports:
        - protocol: TCP
          port: 5432
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# Allow ingress to PostgreSQL from API backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres-ingress
  namespace: cloudtolocalllm
  labels:
    app: postgres
    policy: allow-ingress
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
  ingress:
    # Allow from API backend
    - from:
        - podSelector:
            matchLabels:
              app: api-backend
      ports:
        - protocol: TCP
          port: 5432

---
# Allow ingress to PostgreSQL Auth from API backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres-auth-ingress
  namespace: cloudtolocalllm
  labels:
    app: postgres-auth
    policy: allow-ingress
spec:
  podSelector:
    matchLabels:
      app: postgres-auth
  policyTypes:
    - Ingress
  ingress:
    # Allow from API backend
    - from:
        - podSelector:
            matchLabels:
              app: api-backend
      ports:
        - protocol: TCP
          port: 5432

---
# Allow streaming proxy to communicate with API backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-streaming-proxy-to-api
  namespace: cloudtolocalllm
  labels:
    app: streaming-proxy
    policy: allow-egress
spec:
  podSelector:
    matchLabels:
      app: streaming-proxy
  policyTypes:
    - Egress
  egress:
    # Allow to API backend
    - to:
        - podSelector:
            matchLabels:
              app: api-backend
      ports:
        - protocol: TCP
          port: 8080
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# Allow ingress to streaming proxy from Cloudflared
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-streaming-proxy-ingress
  namespace: cloudtolocalllm
  labels:
    app: streaming-proxy
    policy: allow-ingress
spec:
  podSelector:
    matchLabels:
      app: streaming-proxy
  policyTypes:
    - Ingress
  ingress:
    # Allow from Cloudflared
    - from:
        - podSelector:
            matchLabels:
              app: cloudflared
      ports:
        - protocol: TCP
          port: 3001